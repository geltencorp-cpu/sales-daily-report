<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì—… ì¼ì¼ ë³´ê³ ì„œ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvasëŠ” PNG ë‹¤ìš´ë¡œë“œìš© -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> 
    <!-- ì•„ì´ì½˜ ë¡œë“œ (Lucide Icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- ğŸ“Š Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Marked.jsëŠ” AI ë¶„ì„ ê²°ê³¼ë¥¼ ë Œë”ë§í•˜ëŠ” ë° ì‚¬ìš©ë©ë‹ˆë‹¤. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.10/marked.min.js"></script>

    <style>
        /* Custom styles and font setting */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-main {
            max-width: 1024px;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .drag-source, .drag-target {
            min-height: 5rem;
            border: 2px dashed #d1d5db;
            padding: 0.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
        }
        .drag-target.drag-hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .activity-card {
            cursor: grab;
            background-color: #bfdbfe;
            color: #1e3a8a;
            border: 1px solid #60a5fa;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .activity-card.dragging {
            opacity: 0.5;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .plan-card {
            background-color: #e0f2fe;
            border: 1px solid #93c5fd;
            color: #0c4a6e;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .summary-card {
            background-color: #f0fdf4; /* Green background for success */
            border: 1px solid #4ade80;
            color: #065f46;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        /* AI ë¶„ì„ ê²°ê³¼ì˜ ê°€ë…ì„±ì„ ë†’ì´ê¸° ìœ„í•œ ìŠ¤íƒ€ì¼ */
        #aiAnalysisResult p {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        #aiAnalysisResult ul, #aiAnalysisResult ol {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            padding-left: 1.5rem;
            list-style: disc; /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        }
        #aiAnalysisResult li {
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #10b981; /* ì—ë©”ë„ë“œ ìƒ‰ìƒ */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="spinner"></div>
    </div>
    
    <div id="dashboard-container" class="container-main mx-auto space-y-8 p-4">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-blue-800">ì˜ì—… ì¼ì¼ ë³´ê³ ì„œ ëŒ€ì‹œë³´ë“œ</h1>
            <p class="text-gray-600 mt-2">ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜ì—… ì„±ê³¼ë¥¼ ë¶„ì„í•˜ê³  ì¸ì‚¬ì´íŠ¸ë¥¼ ë°œê²¬í•˜ì„¸ìš”.</p>
            <p class="text-xs text-gray-400 mt-1">ì‚¬ìš©ì ID: <span id="userIdDisplay">03937239367092324634</span></p>
        </header>

        <!-- Main Content Area: Left (Activity & Plans & Analysis) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Column 1 & 2: Activity, Plans, & Analysis (lg:col-span-2) -->
            <div class="lg:col-span-2 space-y-6">

                <!-- 1. ì¼ì¼ í™œë™ ê¸°ë¡ -->
                <section class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="file-pen" class="w-5 h-5 mr-2 text-blue-500"></i>
                        âœï¸ ì¼ì¼ í™œë™ ê¸°ë¡ ë° ìƒì„¸ ë‚´ìš© ì¶”ê°€
                    </h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ë³´ê³ ì ì´ë¦„:</label>
                            <select id="reporterName" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border transition duration-150">
                                <option value="">--- ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš” ---</option>
                                <option value="ì •ë´‰ì£¼">ì •ë´‰ì£¼</option>
                                <option value="ê¹€ê°•">ê¹€ê°•</option>
                                <option value="í—ˆì—°">í—ˆì—°</option>
                                <option value="ê¹€ì‚°">ê¹€ì‚°</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ì˜ì—… í™œë™ ìœ í˜• ì„ íƒ:</label>
                            <select id="activityType" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                                <option value="">--- í™œë™ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš” ---</option>
                                <option value="ê³µë¬¸ì˜ì—…">ê³µë¬¸ì˜ì—…</option>
                                <option value="ì¸ë°”ìš´ë“œ ì˜ì—…">ì¸ë°”ìš´ë“œ ì˜ì—…</option>
                                <option value="ì•„ì›ƒë°”ìš´ë“œ ì˜ì—…">ì•„ì›ƒë°”ìš´ë“œ ì˜ì—…</option>
                                <option value="ë©”ì¼ì˜ì—…">ë©”ì¼ì˜ì—…</option>
                                <option value="SNS ì˜ì—…">SNS ì˜ì—…</option>
                                <option value="ëŒ€ë©´ ì˜ì—…">ëŒ€ë©´ ì˜ì—…</option>
                                <option value="ê¸°íƒ€ì˜ì—…">ê¸°íƒ€ì˜ì—…</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ì…ë ¥ í•„ë“œ ì˜ì—­ -->
                    <div id="dynamicActivityFields" class="mt-4 border-l-4 border-blue-200 pl-4 py-2">
                        <p class="text-sm text-gray-400">í™œë™ ìœ í˜•ì„ ì„ íƒí•˜ë©´ ê´€ë ¨ ì…ë ¥ í•„ë“œê°€ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                    </div>

                    <button id="addActivityButton" class="w-full mt-6 bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600 transition">
                        + í™œë™ ë‚´ì—­ ì¶”ê°€
                    </button>
                    
                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-700 mb-2">ì‘ì„±ëœ í™œë™ ëª©ë¡ (ì•„ë˜ë¡œ ëˆ„ì ) - ì¹´ë“œë¥¼ ëŒì–´ 'ë‚´ì¼ ê³„íš'ì— ì—°ê²°í•˜ì„¸ìš”</h3>
                        <button id="loadPastDataBtn" class="w-full bg-gray-100 text-gray-700 p-2 mb-2 rounded-lg text-sm hover:bg-gray-200 transition flex items-center justify-center">
                            <i data-lucide="history" class="w-4 h-4 mr-2"></i>
                            ğŸ“… ê³¼ê±° ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° (ìµœê·¼ 1ê°œì›”)
                        </button>
                        <div id="activityList" class="drag-source bg-gray-50 p-3 min-h-[5rem]"
                            ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                            <p class="text-gray-400 text-sm">ì•„ì§ ë“±ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ ì–‘ì‹ìœ¼ë¡œ í™œë™ ë‚´ì—­ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”.</p>
                        </div>
                    </div>
                </section>

                <!-- 2. ë‚´ì¼ ê³„íš ì‘ì„± -->
                <section class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="clipboard-list" class="w-5 h-5 mr-2 text-indigo-500"></i>
                        ğŸ“ ë‚´ì¼ ê³„íš ì‘ì„±
                    </h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ì—…ë¬´ í™œë™ ìœ í˜• ì„ íƒ:</label>
                            <select id="planActivityType" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                                <option value="">--- ìœ í˜• ì„ íƒ ---</option>
                                <option value="ê³µë¬¸ì˜ì—…">ê³µë¬¸ì˜ì—…</option>
                                <option value="ì¸ë°”ìš´ë“œ ì˜ì—…">ì¸ë°”ìš´ë“œ ì˜ì—…</option>
                                <option value="ì•„ì›ƒë°”ìš´ë“œ ì˜ì—…">ì•„ì›ƒë°”ìš´ë“œ ì˜ì—…</option>
                                <option value="ë©”ì¼ì˜ì—…">ë©”ì¼ì˜ì—…</option>
                                <option value="SNS ì˜ì—…">SNS ì˜ì—…</option>
                                <option value="ëŒ€ë©´ ì˜ì—…">ëŒ€ë©´ ì˜ì—…</option>
                                <option value="ê¸°íƒ€ì˜ì—…">ê¸°íƒ€ì˜ì—…</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ì—°ê´€ í™œë™ (ì—¬ê¸°ì— ë“œë˜ê·¸)</label>
                            <div id="planDropTarget" 
                                class="drag-target border-indigo-300 bg-indigo-50 p-2 text-xs text-gray-500" 
                                ondragover="handleDragOver(event)" 
                                ondragleave="handleDragLeave(event)" 
                                ondrop="handleDrop(event)">
                                í™œë™ ì¹´ë“œë¥¼ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš” (ì„ íƒì‚¬í•­)
                            </div>
                        </div>
                    </div>

                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ì…ë ¥ í•„ë“œ ì˜ì—­ -->
                    <div id="dynamicPlanFields" class="mt-4 border-l-4 border-indigo-200 pl-4 py-2 space-y-3">
                        <p class="text-sm text-gray-400">í™œë™ ìœ í˜•ì„ ì„ íƒí•˜ë©´ í›„ì† ì‘ì—… í•„ë“œê°€ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                    </div>
                    
                    <button id="addPlanButton" class="w-full mt-4 bg-indigo-500 text-white p-3 rounded-lg font-bold hover:bg-indigo-600 transition">
                        + ê³„íš ì¶”ê°€
                    </button>

                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-700 mb-2">ì‘ì„±ëœ ë‚´ì¼ ê³„íš ëª©ë¡</h3>
                        <div id="planList" class="bg-gray-50 p-3 min-h-[5rem]">
                            <p class="text-gray-400 text-sm">ë“±ë¡ëœ ë‚´ì¼ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ ì–‘ì‹ìœ¼ë¡œ ê³„íšì„ ì¶”ê°€í•´ ë³´ì„¸ìš”ã€‚</p>
                        </div>
                    </div>
                </section>

                <!-- 4. ì¢…í•© ì„±ê³¼ ë° íŒŒì¼ ê´€ë¦¬ (KPI, ë¶„ì„ ë²„íŠ¼, ì°¨íŠ¸ í†µí•©ë¨) -->
                <section class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2 text-orange-500"></i>
                        ğŸ“Š ì¢…í•© ì„±ê³¼
                    </h2>
                    
                    <!-- KPI Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-center mb-6">
                        
                        <!-- ë‹¹ì›” ëˆ„ì  ë§¤ì¶œ -->
                        <div class="p-3 bg-indigo-50 rounded-lg">
                            <p class="text-xs text-gray-500">íŒ€ ì›”ê°„ ëˆ„ì  ë§¤ì¶œ</p>
                            <p id="displayMonthlyCumulativeSales" class="text-lg font-bold text-indigo-800 mt-1">â‚©0</p>
                        </div>

                        <!-- ë‹¹ì›” ë‚˜ì˜ ë§¤ì¶œ -->
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <p class="text-xs text-gray-500">ë‹¹ì›” ë‚˜ì˜ ë§¤ì¶œ</p>
                            <p id="displayMyMonthlySales" class="text-lg font-bold text-blue-800 mt-1">â‚©0</p>
                        </div>

                        <!-- ì´ ì‹¤ì œ ë§¤ì¶œ (ì˜¤ëŠ˜) (ì¼ì¼ í•©ì‚°) -->
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-xs text-gray-500">ì´ ì‹¤ì œ ë§¤ì¶œ (ì˜¤ëŠ˜)</p>
                            <p id="displayTotalRevenue" class="text-lg font-bold text-green-800 mt-1">â‚©0</p>
                        </div>
                        
                        <!-- ì´ ê³„ì•½ ê±´ìˆ˜ (ì˜¤ëŠ˜) (ì¼ì¼ í•©ì‚°) -->
                        <div class="p-3 bg-yellow-50 rounded-lg">
                            <p class="text-xs text-gray-500">ì´ ê³„ì•½ ê±´ìˆ˜ (ì˜¤ëŠ˜)</p>
                            <p id="displayTotalContracts" class="text-lg font-bold text-yellow-800 mt-1">0ê±´</p>
                        </div>

                        <!-- ë§¤ì¶œ ëª©í‘œ ë‹¬ì„±ë¥  (ì˜¤ëŠ˜) (Mock) -->
                        <div class="p-3 bg-red-50 rounded-lg">
                            <p class="text-xs text-gray-500">ë§¤ì¶œ ëª©í‘œ ë‹¬ì„±ë¥  (ì˜¤ëŠ˜)</p>
                            <p id="displayRevenueGoalAttainment" class="text-lg font-bold text-red-800 mt-1">0.0%</p>
                        </div>
                        
                    </div>

                    <div class="space-y-3 mb-6">
                        
                        <!-- AI ë¶„ì„ ë²„íŠ¼ -->
                        <button onclick="analyzePerformance()" class="w-full bg-indigo-500 text-white p-3 rounded-lg font-bold hover:bg-indigo-600 transition flex items-center justify-center shadow-md">
                            <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                            âœ¨ ì„±ê³¼ ì¸ì‚¬ì´íŠ¸ ë¶„ì„ ì‹œì‘
                        </button>
                        
                    </div>
                    
                    <!-- ì„±ê³¼ ì¸ì‚¬ì´íŠ¸ ë¶„ì„ (ì°¨íŠ¸ í¬í•¨) -->
                    <div class="pt-6 border-t border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                                <i data-lucide="line-chart" class="w-5 h-5 mr-2 text-green-500"></i>
                                ì„±ê³¼ ì¸ì‚¬ì´íŠ¸ ë¶„ì„
                            </h3>
                        <div id="aiAnalysisResult" class="mb-6">
                            <p class="text-gray-500 text-sm">AI ë¶„ì„ì„ ì‹œì‘í•˜ë©´ ì´ ì˜ì—­ì— ë§ì¶¤í˜• ì„±ê³¼ ë¦¬í¬íŠ¸ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Chart 1: Sales Breakdown (ë§¤ì¶œ ê¸°ì—¬ë„ ë„ë„› ì°¨íŠ¸) -->
                            <div>
                                <h4 class="font-semibold text-gray-700 text-lg mb-2 border-b pb-1">ì›”ë³„ ë§¤ì¶œ ê¸°ì—¬ë„ ë¶„ì„</h4>
                                <div class="relative h-64">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Chart 2: Activity Count (í™œë™ ìœ í˜•ë³„ ë§‰ëŒ€ ê·¸ë˜í”„) -->
                            <div>
                                <h4 class="font-semibold text-gray-700 text-lg mb-2 border-b pb-1">í™œë™ ìœ í˜•ë³„ ì‹¤í–‰ ê±´ìˆ˜ (ìµœê·¼ 7ì¼)</h4>
                                <div class="relative h-64">
                                    <canvas id="activityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Download Button -->
                    <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                        <button onclick="downloadAsPNG()" class="w-full max-w-lg mx-auto border border-gray-300 text-gray-700 p-4 rounded-xl font-bold hover:bg-gray-100 transition flex items-center justify-center shadow-lg">
                            <i data-lucide="download" class="w-6 h-6 mr-3"></i>
                            â¬‡ï¸ ìµœì¢… ë³´ê³ ì„œ ì €ì¥ ë° ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>

                </section>
                

            </div>

            <!-- Column 3: Performance Entry Only (lg:col-span-1) -->
            <div class="lg:col-span-1 space-y-6">

                <!-- 3. ì˜¤ëŠ˜ ìµœì¢… ì‹¤ì  ì…ë ¥ -->
                <section class="card p-6 text-center">
                    <h2 class="text-xl font-extrabold text-gray-700 flex flex-col items-center">
                        <div class="flex items-center">
                            <i data-lucide="trending-up" class="w-5 h-5 mr-2 text-green-500"></i>
                            ğŸ’° ì˜¤ëŠ˜ ìµœì¢… ì‹¤ì  ì…ë ¥
                        </div>
                        <span class="mt-1 text-base font-medium text-gray-500">(ì¼ë³„ ê¸°ì¤€)</span>
                    </h2>
                    <p class="text-sm text-gray-500 my-4">ì˜¤ëŠ˜ í•˜ë£¨ì˜ ìµœì¢… ë§¤ì¶œ ë° ê³„ì•½ ê±´ìˆ˜ë¥¼ ìƒì„¸íˆ ê¸°ë¡í•©ë‹ˆë‹¤.</p>
                    
                    <div class="space-y-4">
                        <!-- ë§¤ì¶œ ê±´ìˆ˜ ì…ë ¥ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 text-left">ë§¤ì¶œ ë°œìƒ ê±´ìˆ˜ (ìˆ«ìë§Œ)</label>
                            <input type="number" id="inputRevenueCount" min="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="0">
                        </div>
                        <!-- ë™ì  ë§¤ì¶œ í•„ë“œ ì˜ì—­ (ì„¸ë¡œ ì •ë ¬) -->
                        <div id="revenueFields" class="space-y-3">
                            <!-- revenue inputs will be rendered here -->
                        </div>
                        
                        <hr class="border-t border-gray-200">
                        
                        <!-- ê³„ì•½ ê±´ìˆ˜ ì…ë ¥ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 text-left">ê³„ì•½ ì²´ê²° ê±´ìˆ˜ (ìˆ«ìë§Œ)</label>
                            <input type="number" id="inputContractCount" min="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="0">
                        </div>
                        <!-- ë™ì  ê³„ì•½ í•„ë“œ ì˜ì—­ (ì„¸ë¡œ ì •ë ¬) -->
                        <div id="contractFields" class="space-y-3">
                            <!-- contract inputs will be rendered here -->
                        </div>
                    </div>
                    
                    <button onclick="handleSavePerformance()" class="w-full mt-5 bg-green-500 text-white p-3 rounded-lg font-bold hover:bg-green-600 transition flex items-center justify-center shadow-md">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                        âœ… ì˜¤ëŠ˜ ì‹¤ì  ì €ì¥
                    </button>
                    <div id="saveStatus" class="mt-2 text-sm text-gray-500 font-semibold text-center">ì‹¤ì  ë° í™œë™ ë‚´ì—­ì„ ê¸°ë¡í•´ ì£¼ì„¸ìš”.</div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="font-semibold text-gray-700 mb-2">ì˜¤ëŠ˜ ì €ì¥ëœ ì‹¤ì  ëª©ë¡</h3>
                        <div id="performanceSummaryList" class="bg-gray-50 p-3 min-h-[5rem] space-y-2">
                            <p class="text-gray-400 text-sm">ì˜¤ëŠ˜ ì €ì¥ëœ ì‹¤ì  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ì‹¤ì ì„ ìƒì„¸íˆ ê¸°ë¡í•´ ì£¼ì„¸ìš”ã€‚</p>
                        </div>
                    </div>
                </section>

            </div>
        </div>
    </div>

    <script type="module">
        
        // --- Gemini API ì„¤ì • ---
        const GEMINI_API_KEY = "AIzaSyD7md4tcbDQJ9_WrBowlIjdvss4wajs2R4";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
        
        // [í•„ìˆ˜] Google Sheets Web App URL
        const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxCq9AE93PxKNttqmwjMyK3Rgze9JLoSRJUhkXYMD3MZ9_qNyLBysH7h41sITeZhePYMw/exec";
        const SHEETS_API_URL = SHEETS_URL;
        const SHEETS_READ_URL = SHEETS_URL;

        const REPORTER_NAME_KEY = 'salesReporterName'; 

        // ì‚¬ìš©ì IDëŠ” ë¡œì»¬ì—ì„œ ìƒì„± ë° ìœ ì§€ (ì¸ì¦ ì—†ì´ ì‚¬ìš©)
        let currentUserId = localStorage.getItem('localUserId') || crypto.randomUUID();
        localStorage.setItem('localUserId', currentUserId);
        
        let salesChartInstance = null;
        let activityChartInstance = null;
        let activityCounter = 1; 
        let planCounter = 1; 
        
        // --- ì„ì‹œ ë°ì´í„° ì´ˆê¸°ê°’ (Sheets ë¡œë“œ í›„ ì—…ë°ì´íŠ¸ë¨) ---
        let dashboardData = {
            activities: [],
            plans: [],
            todaySummaries: [], // ì‹¤ì  ìš”ì•½ ëª©ë¡
            performance: {
                totalRevenue: 0, 
                totalContracts: 0, 
                revenueGoalAttainment: 0, 
                monthlyCumulativeSales: 0, 
                myMonthlySales: 0, 
            },
            chartData: {
                activityCounts: {}
            }
        };

        // --- ì¬ì‹œë„ ë¡œì§ì„ ìœ„í•œ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        
        // --- Chart Rendering Functions ---
        
        // --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (KPI ì—…ë°ì´íŠ¸ ë° ì°¨íŠ¸ ì¬ë Œë”ë§) ---
        function updateDashboardUI() {
            // í—¬í¼: KRW í†µí™” í˜•ì‹ ì§€ì • (ì› ë‹¨ìœ„)
            const krwFormatter = new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                minimumFractionDigits: 0
            });

            // ì¼ì¼ KPI ì—…ë°ì´íŠ¸ (ì‹¤ì  ìš”ì•½ ëª©ë¡ì—ì„œ í•©ì‚°ëœ ê°’)
            document.getElementById('displayTotalRevenue').textContent = krwFormatter.format(dashboardData.performance.totalRevenue);
            document.getElementById('displayTotalContracts').textContent = `${dashboardData.performance.totalContracts.toLocaleString()}ê±´`;
            
            // Sheetsì— ëª©í‘œ ë°ì´í„°ê°€ ì—†ìœ¼ë¯€ë¡œ ì„ì‹œ Mock ê°’ ìœ ì§€
            document.getElementById('displayRevenueGoalAttainment').textContent = `${dashboardData.performance.revenueGoalAttainment.toFixed(1)}%`; 

            // **ì›”ë³„ KPI ì—…ë°ì´íŠ¸ (Sheets ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸)**
            document.getElementById('displayMonthlyCumulativeSales').textContent = krwFormatter.format(dashboardData.performance.monthlyCumulativeSales);
            document.getElementById('displayMyMonthlySales').textContent = krwFormatter.format(dashboardData.performance.myMonthlySales);
            
            // ì°¨íŠ¸ ë°ì´í„°ê°€ KPI ê°’ì— ì˜ì¡´í•˜ë¯€ë¡œ, KPI ì—…ë°ì´íŠ¸ í›„ ì°¨íŠ¸ë„ ë‹¤ì‹œ ë Œë”ë§
            renderSalesChart(dashboardData.performance);
            renderActivityChart(dashboardData.chartData.activityCounts);
        }

        // --- ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ 1: ì›”ë³„ ë§¤ì¶œ ê¸°ì—¬ë„ (ë„ë„› ì°¨íŠ¸) ---
        function renderSalesChart(performanceData) {
            const mySales = performanceData.myMonthlySales;
            const cumulativeSales = performanceData.monthlyCumulativeSales;
            const otherSales = Math.max(0, cumulativeSales - mySales); 

            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            const ctx = document.getElementById('salesChart').getContext('2d');
            salesChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ë‚˜ì˜ ë§¤ì¶œ', 'ë‹¤ë¥¸ íŒ€ì› ë§¤ì¶œ'],
                    datasets: [{
                        data: [mySales, otherSales],
                        backgroundColor: [
                            'rgb(59, 130, 246)', 
                            'rgb(209, 213, 219)' 
                        ],
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Inter',
                                    size: 14,
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `íŒ€ ì „ì²´ ì›”ê°„ ë§¤ì¶œ ê¸°ì—¬ë„ (ì´ì•¡: ${cumulativeSales.toLocaleString()}ì›)`,
                            font: {
                                family: 'Inter',
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }
        
        // --- ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ 2: í™œë™ ìœ í˜•ë³„ ì‹¤í–‰ ê±´ìˆ˜ (ë§‰ëŒ€ ê·¸ë˜í”„) ---
        function renderActivityChart(activityCounts) {
            const labels = Object.keys(activityCounts);
            const data = Object.values(activityCounts);

            if (activityChartInstance) {
                activityChartInstance.destroy();
            }
            
            const ctx = document.getElementById('activityChart').getContext('2d');
            activityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì‹¤í–‰ ê±´ìˆ˜',
                        data: data,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.7)', 
                            'rgba(245, 158, 11, 0.7)', Â 
                            'rgba(99, 102, 241, 0.7)', Â 
                            'rgba(239, 68, 68, 0.7)', Â  
                            'rgba(6, 182, 212, 0.7)', Â  
                            'rgba(236, 72, 153, 0.7)', Â 
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)', 
                            'rgb(245, 158, 11)', Â 
                            'rgb(99, 102, 241)', 
                            'rgb(239, 68, 68)', Â  
                            'rgb(6, 182, 212)', Â  
                            'rgb(236, 72, 153)', Â 
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'ì£¼ìš” ì˜ì—… í™œë™ ìœ í˜•ë³„ ì‹¤í–‰ ê±´ìˆ˜ (ìµœê·¼ 7ì¼)',
                            font: { family: 'Inter', size: 16, weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ê±´ìˆ˜'
                            }
                        }
                    }
                }
            });
        }

        // --- í™œë™/ê³„íš ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜ ---
        function renderActivityCard(activity) {
            const list = document.getElementById('activityList');
            const placeholder = list.querySelector('p.text-gray-400');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Note: Sheetsì—ì„œ ë¡œë“œëœ ë°ì´í„°ëŠ” ì´ë¯¸ Stringsë¡œ ì²˜ë¦¬ë˜ì–´ ìˆìŒ.
            const detailsText = activity.summaryText || `ëŒ€ìƒ: ${activity.target} | ëª©ì : ${activity.purpose} | ê±´ìˆ˜: ${activity.count}ê±´. ìƒì„¸: ${activity.fullDetails.substring(0, 20)}...`;

            const card = document.createElement('div');
            card.id = activity.id;
            card.className = 'activity-card flex flex-col cursor-grab mb-2';
            card.draggable = true;
            card.ondragstart = handleDragStart;

            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        <span class="text-xs font-bold bg-blue-700 text-white px-2 py-0.5 rounded-full">${activity.type}</span>
                        <span class="text-xs text-blue-900 opacity-75 ml-2">${activity.time}</span>
                    </div>
                    <!-- ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ -->
                    <button onclick="deleteActivity('${activity.id}')" class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-white transition" title="í™œë™ ì‚­ì œ">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <!-- ìš”ì•½ëœ ë‚´ìš© í‘œì‹œ -->
                <p class="mt-1 text-sm font-semibold">${detailsText}</p>
                <p class="text-xs text-blue-900 opacity-75 mt-0.5">ë³´ê³ ì: ${activity.reporter}</p>
            `;
            list.appendChild(card);
            lucide.createIcons();
        }

        function renderPlanCard(plan) {
            const list = document.getElementById('planList');
            const placeholder = list.querySelector('p.text-gray-400');
            if (placeholder) {
                placeholder.remove();
            }

            const relatedActivitiesArray = plan.relatedActivities ? plan.relatedActivities.split('; ') : [];

            const relatedHtml = relatedActivitiesArray.length > 0 
                ? `<div class="mt-2 text-xs bg-indigo-100 p-2 rounded-lg text-indigo-700">
                    <span class="font-bold">ğŸ”— ì—°ê´€ í™œë™:</span> ${relatedActivitiesArray.join('; ')}
                   </div>`
                : '';

            const card = document.createElement('div');
            card.id = plan.id;
            card.className = 'plan-card flex flex-col mb-3 transition shadow-sm hover:shadow-md';

            card.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-sm font-bold bg-indigo-700 text-white px-3 py-1 rounded-full">${plan.type} (ì˜ˆì •)</span>
                        <span class="text-xs text-indigo-900 font-medium ml-3">ë‹´ë‹¹: ${plan.contact}</span>
                    </div>
                    <!-- ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ -->
                    <button onclick="deletePlan('${plan.id}')" class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-white transition" title="ê³„íš ì‚­ì œ">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <h4 class="mt-2 text-md font-extrabold text-indigo-900">${plan.followup}</h4>
                <p class="text-sm mt-1 text-gray-700">ìƒì„¸: ${plan.details}</p>
                ${relatedHtml}
            `;
            list.appendChild(card);
            lucide.createIcons();
        }
        
        // --- ì‹¤ì  ìš”ì•½ ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜ ---
        function renderSummaryCard(summary) {
            const list = document.getElementById('performanceSummaryList');
            const placeholder = list.querySelector('p.text-gray-400');
            if (placeholder) {
                placeholder.remove();
            }

            const krwFormatter = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', minimumFractionDigits: 0 });

            let content = '';
            if (summary.type === 'revenue') {
                content = `ë§¤ì¶œ ë°œìƒ (â‚©): <strong>${krwFormatter.format(summary.amount)}</strong> | ë§¤ì¶œì²˜: ${summary.source}`;
            } else if (summary.type === 'contract') {
                content = `ê³„ì•½ëª…: <strong>${summary.contractName}</strong> | ê±°ë˜ì²˜: ${summary.source}`;
            }

            const card = document.createElement('div');
            card.className = 'summary-card';
            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-bold text-sm">${summary.type === 'revenue' ? 'ğŸ’° ë§¤ì¶œ ê¸°ë¡' : 'ğŸ¤ ê³„ì•½ ê¸°ë¡'}</span>
                    <span class="text-xs opacity-75">${summary.time}</span>
                </div>
                <p class="mt-1">${content}</p>
            `;
            list.appendChild(card);
            lucide.createIcons();
        }


        // --- ëª©ë¡ ì´ˆê¸°í™” ë° ë°ì´í„° ê¸°ë°˜ ë Œë”ë§ ---
        function renderActivityAndPlanLists() {
            const activityList = document.getElementById('activityList');
            const planList = document.getElementById('planList');
            const performanceSummaryList = document.getElementById('performanceSummaryList');

            // --- ë Œë”ë§ ì „ì— ê¸°ì¡´ ëª©ë¡ì„ ë¹„ì›ë‹ˆë‹¤ ---
            activityList.innerHTML = '';
            performanceSummaryList.innerHTML = ''; // ì‹¤ì  ìš”ì•½ ëª©ë¡ì€ í•­ìƒ ë¹„ì›ë‹ˆë‹¤.

            // í”Œë ˆì´ìŠ¤í™€ë” ì„¤ì •
            if (dashboardData.activities.length === 0) {
                activityList.innerHTML = '<p class="text-gray-400 text-sm">ì•„ì§ ë“±ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ ì–‘ì‹ìœ¼ë¡œ í™œë™ ë‚´ì—­ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”.</p>';
            }
            if (dashboardData.plans.length === 0) {
                planList.innerHTML = '<p class="text-gray-400 text-sm">ë“±ë¡ëœ ë‚´ì¼ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ ì–‘ì‹ìœ¼ë¡œ ê³„íšì„ ì¶”ê°€í•´ ë³´ì„¸ìš”ã€‚</p>';
            }
            // ì‹¤ì  ìš”ì•½ ëª©ë¡ì€ ë¡œì»¬ ë°ì´í„°ê°€ ì—†ì„ ë•Œë§Œ í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ
            if (dashboardData.todaySummaries.length === 0) {
                 performanceSummaryList.innerHTML = '<p class="text-gray-400 text-sm">ì˜¤ëŠ˜ ì €ì¥ëœ ì‹¤ì  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ì‹¤ì ì„ ìƒì„¸íˆ ê¸°ë¡í•´ ì£¼ì„¸ìš”ã€‚</p>';
            }

            // ë°ì´í„° ë Œë”ë§
            dashboardData.activities.forEach(renderActivityCard);
            dashboardData.plans.forEach(renderPlanCard); 
            dashboardData.todaySummaries.forEach(renderSummaryCard); 

            lucide.createIcons();
        }

        // --- í™œë™ ë‚´ì—­ ì‚­ì œ í•¨ìˆ˜ ---
        function deleteActivity(activityId) {
             // ë¡œì»¬ì—ì„œë§Œ ì‚­ì œ (Sheets ë°˜ì˜ì€ ìµœì¢… ì €ì¥ ì‹œ)
            dashboardData.activities = dashboardData.activities.filter(a => a.id !== activityId);
            
            const element = document.getElementById(activityId);
            if (element) {
                element.remove();
                displayMessage('âœ”ï¸ í™œë™ ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (Sheets ë°˜ì˜ì€ ìµœì¢… ì €ì¥ ì‹œ)', 'success');
            }
            
            const list = document.getElementById('activityList');
            if (dashboardData.activities.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm">ì•„ì§ ë“±ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ ì–‘ì‹ìœ¼ë¡œ í™œë™ ë‚´ì—­ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”ã€‚</p>';
            }
            lucide.createIcons();
        }
        window.deleteActivity = deleteActivity;

        // --- ë‚´ì¼ ê³„íš ì‚­ì œ í•¨ìˆ˜ ---
        function deletePlan(planId) {
            // ë¡œì»¬ì—ì„œë§Œ ì‚­ì œ (Sheets ë°˜ì˜ì€ ìµœì¢… ì €ì¥ ì‹œ)
            dashboardData.plans = dashboardData.plans.filter(p => p.id !== planId);
            
            const element = document.getElementById(planId);
            if (element) {
                element.remove();
                displayMessage('âœ”ï¸ ë‚´ì¼ ê³„íšì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (Sheets ë°˜ì˜ì€ ìµœì¢… ì €ì¥ ì‹œ)', 'success');
            }
            
            const list = document.getElementById('planList');
            if (dashboardData.plans.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm">ë“±ë¡ëœ ë‚´ì¼ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤. ìœ„ì˜ ì–‘ì‹ìœ¼ë¡œ ê³„íšì„ ì¶”ê°€í•´ ë³´ì„¸ìš”ã€‚</p>';
            }
            lucide.createIcons();
        }
        window.deletePlan = deletePlan;


        // --- ë™ì  ì…ë ¥ í•„ë“œ ë Œë”ë§ (í™œë™/ê³„íš) ---
        function renderPlanDynamicFields() {
            const container = document.getElementById('dynamicPlanFields');
            const selectedType = document.getElementById('planActivityType').value;
            container.innerHTML = ''; 

            if (selectedType === '--- ìœ í˜• ì„ íƒ ---') {
                container.innerHTML = '<p class="text-sm text-gray-400">í™œë™ ìœ í˜•ì„ ì„ íƒí•˜ë©´ í›„ì† ì‘ì—… í•„ë“œê°€ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>';
                return;
            }
            // ... (HTML êµ¬ì¡° ìœ ì§€)
            const fieldsHtml = `
                <div class="space-y-3">
                    <!-- 1. ìˆ˜í–‰ í›„ì†ì‘ì—… -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ìˆ˜í–‰ í›„ì†ì‘ì—…</label>
                        <input type="text" id="planFollowup" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ex: ë³´ê³ ì„œ ì œì¶œ, ë‹¤ìŒ ë‹¨ê³„ ë…¼ì˜, ê²¬ì  ë°œì†¡">
                    </div>

                    <!-- 2. ì—°ë½ì²˜ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì—°ë½ì²˜ / ë‹´ë‹¹ì</label>
                        <input type="text" id="planContact" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ex: ê¹€ì² ìˆ˜, 010-XXXX-XXXX">
                    </div>
                    
                    <!-- 3. ìƒì„¸ ê³„íš / To-Do List -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ìƒì„¸ ê³„íš / To-Do List</label>
                        <textarea id="planDetailsInput" rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ë‚´ì¼ì˜ ì£¼ìš” ëª©í‘œì™€ ìƒì„¸ ì—…ë¬´ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”."></textarea>
                    </div>
                </div>
            `;
            container.innerHTML = fieldsHtml;
            lucide.createIcons();
        }
        window.renderPlanDynamicFields = renderPlanDynamicFields;

        
        // --- ë‚´ì¼ ê³„íš ì¶”ê°€ í•¸ë“¤ëŸ¬ ---
        async function handleAddPlan() {
            const reporterNameSelect = document.getElementById('reporterName');
            const reporterName = reporterNameSelect.value.trim(); // ì´ë¦„ ê³ ì • í•´ì œë¨

            if (!reporterName) {
                displayMessage('âš ï¸ ë³´ê³ ì ì´ë¦„ì„ ë¨¼ì € ì„ íƒí•˜ê³  í™œë™ì„ ì¶”ê°€í•˜ì„¸ìš”.', 'error');
                return;
            }

            const planActivityType = document.getElementById('planActivityType').value;
            const planFollowupInput = document.getElementById('planFollowup');
            const planContactInput = document.getElementById('planContact');
            const planDetailsInput = document.getElementById('planDetailsInput');
            const planDropTarget = document.getElementById('planDropTarget');
            
            // 1. ìœ íš¨ì„± ê²€ì‚¬
            if (planActivityType === '--- ìœ í˜• ì„ íƒ ---' || !planFollowupInput || !planContactInput || !planDetailsInput) {
                displayMessage('âš ï¸ ê³„íš ìœ í˜•ì„ ì„ íƒí•˜ê³  ëª¨ë“  ìƒì„¸ í•„ë“œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const followup = planFollowupInput.value.trim();
            const contact = planContactInput.value.trim();
            const details = planDetailsInput.value.trim();

            if (!followup || !contact || !details) {
                 displayMessage('âš ï¸ ìˆ˜í–‰ í›„ì†ì‘ì—…, ì—°ë½ì²˜, ìƒì„¸ ê³„íšì„ ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                 return;
            }

            // 2. ì—°ê´€ í™œë™ ì •ë³´ ì¶”ì¶œ
            const relatedActivities = Array.from(planDropTarget.children)
                .filter(child => child.dataset.originalId)
                .map(child => {
                    const contentElement = child.querySelector('.font-semibold');
                    return contentElement ? contentElement.textContent.trim() : 'ë‚´ìš© ì—†ìŒ';
                });

            const now = new Date();
            // 3. ìƒˆ ê³„íš ê°ì²´ ìƒì„±
            const newPlan = {
                id: `plan-${planCounter++}`,
                reporter: reporterName,
                date: now.toISOString().slice(0, 10),
                time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                type: planActivityType,
                followup: followup,
                contact: contact,
                details: details,
                relatedActivities: relatedActivities.join('; '), 
                status: 'ì˜ˆì •'
            };

            // 4. ë¡œì»¬ ë°ì´í„° ì €ì¥ ë° UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ì†ë„ ê°œì„ )
            dashboardData.plans.push(newPlan);
            renderPlanCard(newPlan); 

            // 5. ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('planActivityType').value = '--- ìœ í˜• ì„ íƒ ---';
            planDropTarget.innerHTML = 'í™œë™ ì¹´ë“œë¥¼ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš” (ì„ íƒì‚¬í•­)';
            document.getElementById('dynamicPlanFields').innerHTML = '<p class="text-sm text-gray-400">í™œë™ ìœ í˜•ì„ ì„ íƒí•˜ë©´ í›„ì† ì‘ì—… í•„ë“œê°€ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>';

            displayMessage('âœ”ï¸ ìƒˆë¡œìš´ ë‚´ì¼ ê³„íšì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

            // 6. Google Sheetsì— ë°ì´í„° ë¹„ë™ê¸° ì „ì†¡
            await sendDataToSheets('addê³„íš', newPlan);
        }
        window.handleAddPlan = handleAddPlan;


        // --- ë™ì  ì…ë ¥ í•„ë“œ ë Œë”ë§ (ì¼ì¼ í™œë™ ìœ í˜• ì„ íƒ ì‹œ í˜¸ì¶œ) ---
        function renderDynamicFields() {
            const container = document.getElementById('dynamicActivityFields');
            const selectedType = document.getElementById('activityType').value;

            if (selectedType === '--- í™œë™ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš” ---') {
                container.innerHTML = '<p class="text-sm text-gray-400">í™œë™ ìœ í˜•ì„ ì„ íƒí•˜ë©´ ê´€ë ¨ ì…ë ¥ í•„ë“œê°€ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>';
                return;
            }
            
            // ... (HTML êµ¬ì¡° ìœ ì§€)
            container.innerHTML = `
                <div class="space-y-4">
                    <!-- 1. ì˜ì—… ëŒ€ìƒ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì˜ì—… ëŒ€ìƒ</label>
                        <input type="text" id="inputTarget" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ex: Aì‚¬ ì‹ ê·œ í”„ë¡œì íŠ¸, ê¸°ì¡´ Bê³ ê° ìœ ì§€">
                    </div>

                    <!-- 2. ì˜ì—… ëª©ì  -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì˜ì—… ëª©ì </label>
                        <input type="text" id="inputPurpose" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ex: ì‹ ì œí’ˆ X íŒë§¤, ê³„ì•½ ì—°ì¥">
                    </div>
                    
                    <!-- 3. ì˜ˆìƒ ì„±ê³¼ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì˜ˆìƒ ì„±ê³¼</label>
                        <input type="text" id="inputExpectedResult" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ex: 500ë§Œì› ê³„ì•½ ì²´ê²°, ë‹¤ìŒ ë¯¸íŒ… í™•ì •">
                    </div>

                    <hr class="border-t border-gray-200">
                    
                    <!-- 4. ì‹¤ì  ê±´ìˆ˜ (ë™ì  ìƒì„± ê¸°ì¤€) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì‹¤ì  ê±´ìˆ˜ (ìˆ«ìë§Œ ì…ë ¥)</label>
                        <input type="number" id="inputPerformanceCount" min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" oninput="renderDetailFields(this.value)" placeholder="1">
                    </div>

                    <!-- 5. ìƒì„¸ ë‚´ìš© (ë™ì  ìƒì„± ì˜ì—­) -->
                    <div id="detailTextareas" class="space-y-3">
                        <!-- ìƒì„¸ ë‚´ìš© ì…ë ¥ë€ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤. -->
                    </div>
                </div>
            `;
            // ê¸°ë³¸ê°’ 1ì— ëŒ€í•´ ìƒì„¸ ë‚´ìš© í•„ë“œ 1ê°œë¥¼ ë°”ë¡œ ë Œë”ë§
            renderDetailFields(1);
            lucide.createIcons();
        }
        window.renderDynamicFields = renderDynamicFields;


        // --- ì‹¤ì  ê±´ìˆ˜ì— ë”°ë¥¸ ìƒì„¸ ë‚´ìš© í•„ë“œ ë Œë”ë§ ---
        function renderDetailFields(countString) {
            const count = parseInt(countString, 10);
            const container = document.getElementById('detailTextareas');
            container.innerHTML = '';

            if (isNaN(count) || count <= 0) {
                container.innerHTML = '<p class="text-sm text-red-500">ì‹¤ì  ê±´ìˆ˜ëŠ” 1 ì´ìƒì˜ ìˆ«ìë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.</p>';
                return;
            }

            for (let i = 1; i <= count; i++) {
                const detailHtml = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ìƒì„¸ ë‚´ìš© ${i}</label>
                        <textarea id="detail_${i}" rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="${i}ë²ˆì§¸ í™œë™ì˜ êµ¬ì²´ì ì¸ ë‚´ìš©, ê²°ê³¼, í›„ì† ì¡°ì¹˜ë¥¼ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', detailHtml);
            }
        }
        window.renderDetailFields = renderDetailFields;


        // --- í™œë™ ë‚´ì—­ ì¶”ê°€ í•¸ë“¤ëŸ¬ ---
        async function handleAddActivity() {
            const reporterNameSelect = document.getElementById('reporterName'); 
            let reporterName = reporterNameSelect.value.trim(); // ì´ë¦„ ê³ ì • í•´ì œë¨

            const activityTypeSelect = document.getElementById('activityType');
            const activityType = activityTypeSelect.value;
            
            const target = document.getElementById('inputTarget')?.value.trim();
            const purpose = document.getElementById('inputPurpose')?.value.trim();
            const expectedResult = document.getElementById('inputExpectedResult')?.value.trim();
            const count = parseInt(document.getElementById('inputPerformanceCount')?.value, 10) || 0;
            
            // ì´ë¦„ ìœ íš¨ì„± ê²€ì‚¬ (ê³ ì • ë¡œì§ ì œê±°)
            if (!reporterName) {
                displayMessage('âš ï¸ ë³´ê³ ì ì´ë¦„ì„ ë¨¼ì € ì„ íƒí•˜ê³  í™œë™ì„ ì¶”ê°€í•˜ì„¸ìš”.', 'error');
                return;
            }
            
            // ìƒì„¸ ë‚´ìš© ìˆ˜ì§‘
            let collectedDetails = [];
            for (let i = 1; i <= count; i++) {
                const detailElement = document.getElementById(`detail_${i}`);
                if (detailElement && detailElement.value.trim()) {
                    collectedDetails.push(detailElement.value.trim());
                }
            }


            if (activityType === '--- í™œë™ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš” ---' || !target || count <= 0 || collectedDetails.length === 0) {
                displayMessage('âš ï¸ í™œë™ ìœ í˜•, ì˜ì—… ëŒ€ìƒ, ì‹¤ì  ê±´ìˆ˜ ë° ìƒì„¸ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const summaryText = `ëŒ€ìƒ: ${target} | ëª©ì : ${purpose} | ê±´ìˆ˜: ${count}ê±´. ìƒì„¸: ${collectedDetails[0].substring(0, 20)}...`;

            const now = new Date();
            const newActivity = {
                id: `activity-${activityCounter++}`,
                reporter: reporterName,
                date: now.toISOString().slice(0, 10),
                time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                type: activityType,
                target: target,
                purpose: purpose,
                expectedResult: expectedResult,
                count: count,
                fullDetails: collectedDetails.join('; '), 
                summaryText: summaryText
            };

            // 1. ë¡œì»¬ ë°ì´í„°ì— ì¶”ê°€ ë° UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ì‘ë‹µ ì†ë„ ê°œì„ )
            dashboardData.activities.push(newActivity); 
            renderActivityCard(newActivity); 
            
            // 2. ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            activityTypeSelect.value = '--- í™œë™ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš” ---';
            document.getElementById('dynamicActivityFields').innerHTML = '<p class="text-sm text-gray-400">í™œë™ ìœ í˜•ì„ ì„ íƒí•˜ë©´ ê´€ë ¨ ì…ë ¥ í•„ë“œê°€ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>';

            displayMessage('âœ”ï¸ ìƒˆë¡œìš´ í™œë™ ë‚´ì—­ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            
            // 3. Google Sheetsì— ë°ì´í„° ë¹„ë™ê¸° ì „ì†¡
            await sendDataToSheets('addí™œë™', newActivity);
        }
        window.handleAddActivity = handleAddActivity;

        
        // --- ë™ì  ì‹¤ì  ì…ë ¥ í•„ë“œ ë Œë”ë§ ---
        function renderRevenueFields(count) {
            const container = document.getElementById('revenueFields');
            container.innerHTML = '';
            if (isNaN(count) || count <= 0) return;

            for (let i = 1; i <= count; i++) {
                container.insertAdjacentHTML('beforeend', `
                    <div class="space-y-1 p-2 border border-gray-200 rounded-lg">
                        <input type="text" id="revenueSource_${i}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="ë§¤ì¶œì²˜">
                        <input type="number" id="revenueAmount_${i}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="ê¸ˆì•¡ (EX: 100000)">
                    </div>
                `);
            }
        }
        window.renderRevenueFields = renderRevenueFields;

        function renderContractFields(count) {
            const container = document.getElementById('contractFields');
            container.innerHTML = '';
            if (isNaN(count) || count <= 0) return;

            for (let i = 1; i <= count; i++) {
                 container.insertAdjacentHTML('beforeend', `
                    <div class="space-y-1 p-2 border border-gray-200 rounded-lg">
                        <input type="text" id="contractSource_${i}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="ê±°ë˜ì²˜">
                        <input type="text" id="contractName_${i}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="ê³„ì•½ëª… (ex: 2ì°¨ ì„œë¹„ìŠ¤ ê³„ì•½)">
                    </div>
                `);
            }
        }
        window.renderContractFields = renderContractFields;
        
        
        // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬: ì‹¤ì  ì €ì¥, ìš”ì•½ í‘œì‹œ, Sheets ì „ì†¡ (ë¹„ë™ê¸°) ---
        window.handleSavePerformance = async () => {
            const reporterNameSelect = document.getElementById('reporterName');
            const reporterName = reporterNameSelect.value.trim(); // ì´ë¦„ ê³ ì • í•´ì œë¨
            
            if (!reporterName) {
                displayMessage('âš ï¸ ë³´ê³ ì ì´ë¦„ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
                return false; 
            }
            
            // 1. ë°ì´í„° ìˆ˜ì§‘
            const revenueCount = parseInt(document.getElementById('inputRevenueCount').value, 10) || 0;
            const contractCount = parseInt(document.getElementById('inputContractCount').value, 10) || 0;
            const now = new Date();
            const time = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            
            let allSummaries = [];
            let localRevenueTotal = 0;
            let localContractCount = 0; 
            let sheetsPromises = [];

            // 1-1. ë§¤ì¶œ ë°ì´í„° ìˆ˜ì§‘ ë° ì „ì†¡ ì¤€ë¹„
            for (let i = 1; i <= revenueCount; i++) {
                const source = document.getElementById(`revenueSource_${i}`)?.value.trim();
                const amount = parseFloat(document.getElementById(`revenueAmount_${i}`)?.value) || 0;
                
                if (source && amount > 0) {
                    localRevenueTotal += amount;
                    const summary = { id: `sum-${Date.now()}-rev-${i}`, type: 'revenue', time: time, reporter: reporterName, source: source, amount: amount, contractName: '' };
                    allSummaries.push(summary);
                    
                    const payload = {
                        date: now.toISOString().slice(0, 10),
                        time: time,
                        reporter: reporterName,
                        revenueSource: source,
                        revenue: amount,
                        contractSource: '',
                        contracts: 0,
                        contractName: '',
                    };
                    sheetsPromises.push(sendDataToSheets('addì‹¤ì ', payload));
                }
            }

            // 1-2. ê³„ì•½ ë°ì´í„° ìˆ˜ì§‘ ë° ì „ì†¡ ì¤€ë¹„
            for (let i = 1; i <= contractCount; i++) {
                const source = document.getElementById(`contractSource_${i}`)?.value.trim();
                const contractName = document.getElementById(`contractName_${i}`)?.value.trim();
                
                if (source && contractName) {
                    localContractCount += 1;
                    const summary = { id: `sum-${Date.now()}-con-${i}`, type: 'contract', time: time, reporter: reporterName, source: source, amount: 0, contractName: contractName };
                    allSummaries.push(summary);

                    const payload = {
                        date: now.toISOString().slice(0, 10),
                        time: time,
                        reporter: reporterName,
                        revenueSource: '',
                        revenue: 0,
                        contractSource: source,
                        contracts: 1, // ê±´ìˆ˜ëŠ” 1ë¡œ ê³ ì •
                        contractName: contractName,
                    };
                    sheetsPromises.push(sendDataToSheets('addì‹¤ì ', payload));
                }
            }
            
            if (sheetsPromises.length === 0) {
                displayMessage('âš ï¸ ì €ì¥í•  ìœ íš¨í•œ ì‹¤ì  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì…ë ¥ í•„ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'error');
                return false;
            }

            // 2. Sheetsì— ë°ì´í„° ì „ì†¡ (ë³‘ë ¬ ì²˜ë¦¬)
            displayMessage('â³ ëª¨ë“  ì‹¤ì  ë°ì´í„°ë¥¼ Google Sheetsë¡œ ì „ì†¡ ì¤‘...', 'info');
            const results = await Promise.all(sheetsPromises.map(p => p.catch(e => e)));
            const hasError = results.some(r => r instanceof Error || r === false);
            
            if (hasError) {
                displayMessage('âŒ ì¼ë¶€ ì‹¤ì  ë°ì´í„° Sheets ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }


            // 3. ë¡œì»¬ ë°ì´í„° ì—…ë°ì´íŠ¸ (UI ì¦‰ì‹œ ë°˜ì˜)
            dashboardData.todaySummaries.push(...allSummaries);
            
            // ì—¬ê¸°ì„œëŠ” ì˜¤ëŠ˜ ì €ì¥ëœ ì‹¤ì ë§Œ í•©ì‚°í•˜ì—¬ ë¡œì»¬ KPIì— ë°˜ì˜í•©ë‹ˆë‹¤.
            dashboardData.performance.totalRevenue += localRevenueTotal;
            dashboardData.performance.totalContracts += localContractCount; 

            // 4. ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('inputRevenueCount').value = '';
            document.getElementById('inputContractCount').value = '';
            renderRevenueFields(0);
            renderContractFields(0);
            
            // 5. UI ê°±ì‹  (ì‹¤ì  ìš”ì•½ ë° KPI ê°±ì‹ )
            renderActivityAndPlanLists();
            
            // 6. Sheetsì—ì„œ ìµœì‹  KPI ë°ì´í„° ë¡œë“œ (ì‹¤ì‹œê°„ ê°±ì‹ )
            displayMessage('âœ… ì‹¤ì  ì €ì¥ ì™„ë£Œ. KPI ë°ì´í„° ê°±ì‹  ì¤‘...', 'info');
            // Sheetsì—ì„œ KPI ë°ì´í„°ë§Œ ë¡œë“œ (í™œë™ ë‚´ì—­ê³¼ ê³¼ê±° ì‹¤ì  ìš”ì•½ì€ ë¶ˆëŸ¬ì˜¤ì§€ ì•ŠìŒ)
            const loadSuccess = await fetchSalesData(reporterName, false); 
            
            if (loadSuccess) {
                 displayMessage('ğŸ‰ ì‹¤ì  ì €ì¥ ë° KPI ê°±ì‹  ì™„ë£Œ!', 'success');
            } else {
                 displayMessage('âš ï¸ ì‹¤ì  ì €ì¥ì€ ì™„ë£Œë˜ì—ˆìœ¼ë‚˜, KPI ê°±ì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (Apps Script í™•ì¸)', 'error');
            }

            // ì „ì†¡ì— ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ì—†ì—ˆë‹¤ë©´ true ë°˜í™˜ (ë‹¤ìš´ë¡œë“œ ì§„í–‰ ê°€ëŠ¥)
            return !hasError;
        };

        
        // --- LLM ì¸ì‚¬ì´íŠ¸ ë¶„ì„ (Gemini API í˜¸ì¶œ) ---
        async function analyzePerformance() {
             const reporterName = document.getElementById('reporterName').value.trim();
             const totalRevenueToday = dashboardData.performance.totalRevenue;
             const totalContractsToday = dashboardData.performance.totalContracts;
             const activityCounts = dashboardData.chartData.activityCounts;
             
             if (!reporterName) {
                 displayMessage('âš ï¸ AI ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ë¨¼ì € ë³´ê³ ì ì´ë¦„ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                 return;
             }

             if (totalRevenueToday === 0 && totalContractsToday === 0 && Object.keys(activityCounts).length === 0) {
                 displayMessage('âš ï¸ ì˜¤ëŠ˜ ì‹¤ì  ë° í™œë™ ë‚´ì—­ì´ ì—†ì–´ì„œ ë¶„ì„í•  ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error');
                 return;
             }

             // Mock ë°ì´í„° ìƒì„± (ì–´ì œ ì‹¤ì  ê°€ì •: ì˜¤ëŠ˜ë³´ë‹¤ 5% ë‚®ê³ , ê³„ì•½ 1ê±´ ì ìŒ)
             const yesterdayRevenue = Math.max(0, Math.round(totalRevenueToday * 0.95));
             const yesterdayContracts = Math.max(0, totalContractsToday - 1);

             const analysisPrompt = `
                 ë‹¹ì‹ ì€ ì˜ì—… ì‚¬ì›(${reporterName})ì˜ ì¼ì¼ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.
                 ì˜¤ëŠ˜ì˜ ì„±ê³¼ì™€ ê°€ìƒì˜ ì–´ì œ ì„±ê³¼ë¥¼ ë¹„êµ ë¶„ì„í•˜ê³ , í˜„ì¬ ì˜ì—… í™œë™ ìœ í˜•ì„ ê³ ë ¤í•˜ì—¬ í–¥í›„ ê°œì„ í•  ìˆ˜ ìˆëŠ” ì•¡ì…˜ í”Œëœì„ ì œì‹œí•´ì£¼ì„¸ìš”.

                 --- ë°ì´í„° ---
                 1. ë³´ê³ ì: ${reporterName}
                 2. ì˜¤ëŠ˜ ë§¤ì¶œ: ${totalRevenueToday.toLocaleString()}ì›
                 3. ì˜¤ëŠ˜ ê³„ì•½ ê±´ìˆ˜: ${totalContractsToday}ê±´
                 4. ì–´ì œ (ê°€ìƒ) ë§¤ì¶œ: ${yesterdayRevenue.toLocaleString()}ì›
                 5. ì–´ì œ (ê°€ìƒ) ê³„ì•½ ê±´ìˆ˜: ${yesterdayContracts}ê±´
                 6. ì˜¤ëŠ˜ ì£¼ìš” í™œë™ ê±´ìˆ˜: ${JSON.stringify(activityCounts)}

                 --- ë¶„ì„ ìš”ì²­ ---
                 1. ì„±ê³¼ ìš”ì•½: ì˜¤ëŠ˜ ì‹¤ì  ë³€í™”(ë§¤ì¶œ, ê³„ì•½ ê±´ìˆ˜)ë¥¼ ì–´ì œì™€ ë¹„êµí•˜ì—¬ í•µì‹¬ì ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.
                 2. í™œë™ ë¶„ì„: ê°€ì¥ ë†’ì€ ë¹„ì¤‘ì„ ì°¨ì§€í•˜ëŠ” í™œë™ ìœ í˜•ì— ëŒ€í•œ ê°„ëµí•œ í‰ê°€ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.
                 3. ì•¡ì…˜ í”Œëœ: ì„±ê³¼ë¥¼ ê·¹ëŒ€í™”í•˜ê±°ë‚˜ ë¶€ì¡±í•œ ë¶€ë¶„ì„ ê°œì„ í•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ì•¡ì…˜ í”Œëœ 2~3ê°€ì§€ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”.
                 ê²°ê³¼ëŠ” ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì‹­ì‹œì˜¤.
             `;

             const resultElement = document.getElementById('aiAnalysisResult');
             resultElement.innerHTML = '<div class="text-center py-4 text-blue-600 font-semibold flex items-center justify-center"><i data-lucide="loader-circle" class="w-5 h-5 mr-2 animate-spin"></i>AIê°€ ì„±ê³¼ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (ìµœëŒ€ 10ì´ˆ ì†Œìš”)</div>';
             lucide.createIcons();
             
             let attempts = 0;
             const maxAttempts = 5;

             while (attempts < maxAttempts) {
                 attempts++;
                 let delay = attempts === 1 ? 0 : Math.pow(2, attempts - 1) * 1000;
                 
                 if (delay > 0) {
                      await sleep(delay);
                 }
                 
                 try {
                      // API í‚¤ëŠ” ëŸ°íƒ€ì„ì— í”Œë«í¼ì—ì„œ ì£¼ì…ë©ë‹ˆë‹¤.
                      const apiKey = GEMINI_API_KEY; 
                      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                      const payload = {
                           contents: [{ parts: [{ text: analysisPrompt }] }],
                           tools: [{ "google_search": {} }],
                           systemInstruction: {
                               parts: [{ text: "ë‹¹ì‹ ì€ ì˜ì—… ì‚¬ì›ì˜ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì‘ë‹µì€ ë¶„ì„ê³¼ ì•¡ì…˜ í”Œëœì— ì§‘ì¤‘í•˜ë©°, ì¹œì ˆí•˜ê³  ì „ë¬¸ì ì¸ í†¤ì„ ìœ ì§€í•©ë‹ˆë‹¤." }]
                           },
                       };
                       
                       const response = await fetch(apiUrl, {
                           method: 'POST',
                           headers: { 'Content-Type': 'application/json' },
                           body: JSON.stringify(payload)
                       });
                       
                       if (!response.ok) {
                           throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
                       }

                       const result = await response.json();
                       const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                       
                       // Marked.parseë¥¼ ì‚¬ìš©í•˜ì—¬ Markdownì„ HTMLë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                       if (analysisText) {
                            resultElement.innerHTML = `<div class="p-4 bg-gray-50 rounded-xl shadow-inner">${marked.parse(analysisText)}</div>`;
                            lucide.createIcons();
                            return; // ì„±ê³µ ì‹œ í•¨ìˆ˜ ì¢…ë£Œ
                       } else {
                            throw new Error("ì‘ë‹µ ë‚´ìš© ëˆ„ë½");
                       }

                 } catch (error) {
                      const isRetryable = error.message.includes('HTTP ì˜¤ë¥˜: 503') || error.message.includes('HTTP ì˜¤ë¥˜: 429');
                      
                      if (isRetryable && attempts < maxAttempts) {
                           resultElement.innerHTML = `<div class="text-center py-2 text-orange-600">ì¬ì‹œë„ ${attempts}/${maxAttempts}: ì„œë²„ ê³¼ë¶€í•˜. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤...</div>`;
                           continue;
                      } else {
                           // ìµœì¢… ì‹¤íŒ¨
                           resultElement.innerHTML = `<div class="text-center py-4 text-red-600 font-semibold">âŒ AI ë¶„ì„ì— ìµœì¢… ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì›ì¸: ${error.message})</div>`;
                           return;
                      }
                 }
             } // end while
             resultElement.innerHTML = `<div class="text-center py-4 text-red-600 font-semibold">âŒ AI ë¶„ì„ì— ìµœì¢… ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼)</div>`;
        }
        window.analyzePerformance = analyzePerformance;

Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- PNG ë‹¤ìš´ë¡œë“œ ë° ì´ˆê¸°í™” ---
Â  Â  Â  Â  function downloadAsPNG() {
Â  Â  Â  Â  Â  Â  const reporterName = document.getElementById('reporterName').value.trim();
Â  Â  Â  Â  Â  Â  if (!reporterName) {
Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ ë³´ê³ ì ì´ë¦„ì„ ë¨¼ì € ì„ íƒí•´ì•¼ ë³´ê³ ì„œë¥¼ ì €ì¥í•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 1. Sheetsì— ìµœì¢… ì‹¤ì  ë°ì´í„° ì €ì¥ (ë¹„ë™ê¸° ì™„ë£Œ ëŒ€ê¸°)
Â  Â  Â  Â  Â  Â  displayMessage('â³ Sheetsì— ìµœì¢… ì‹¤ì  ë°ì´í„°ë¥¼ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...', 'info');
Â  Â  Â  Â  Â  Â  const savePromise = handleSavePerformance(); // ì‹¤ì  ì €ì¥ ë° KPI ê°±ì‹ 

Â  Â  Â  Â  Â  Â  // 2. PNG ìº¡ì²˜ ë° ë‹¤ìš´ë¡œë“œ
Â  Â  Â  Â  Â  Â  savePromise.then((success) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â // Sheets ì €ì¥ ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë‹¤ìš´ë¡œë“œ ë° ì´ˆê¸°í™” ì‹œë„
Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('â³ ë³´ê³ ì„œ ì´ë¯¸ì§€ë¥¼ ìº¡ì²˜í•˜ëŠ” ì¤‘...', 'info');

Â  Â  Â  Â  Â  Â  Â  Â  Â const captureArea = document.getElementById('dashboard-container');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â html2canvas(captureArea, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â scale: 2,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â logging: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â useCORS: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â allowTaint: true
Â  Â  Â  Â  Â  Â  Â  Â  Â }).then(canvas => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const today = new Date().toISOString().slice(0, 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.download = `ì˜ì—…ì¼ì¼ë³´ê³ ì„œ_${reporterName}_${today}.png`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ë‹¤ìš´ë¡œë“œ ë§í¬ ì„¤ì •
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.href = canvas.toDataURL('image/png');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('ğŸ‰ ë³´ê³ ì„œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! ëª¨ë“  í•„ë“œë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // 3. ë‹¤ìš´ë¡œë“œ ë° ì €ì¥ í›„ ìµœì¢… ì´ˆê¸°í™”
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resetAllInputs();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }, 500);


Â  Â  Â  Â  Â  Â  Â  Â  Â }).catch(error => {
Â  Â  1599: Â  Â  Â  Â  Â  Â  Â  Â  Â console.error('Error capturing dashboard:', error);
Â  Â  1600: Â  Â  Â  Â  Â  Â  Â  Â  Â // ì´ˆê¸°í™”ëŠ” ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ì™€ ë¬´ê´€í•˜ê²Œ ì‹¤í–‰
Â  Â  1601: Â  Â  Â  Â  Â  Â  Â  Â  Â resetAllInputs();
Â  Â  1602: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âŒ ì´ë¯¸ì§€ ìº¡ì²˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì • í™•ì¸)', 'error');
Â  Â  1603: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  1604: Â  Â  Â  Â  Â  Â  Â  Â  Â // PNG ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ì‹œì—ë„ Sheets ì €ì¥ ì‹¤íŒ¨ëŠ” ì•„ë‹˜
Â  Â  1605: Â  Â  Â  Â  Â  Â  Â  Â  Â return true;
Â  Â  1606: Â  Â  Â  Â  Â  Â  Â });
Â  Â  1607: Â  Â  Â  Â  Â  Â  } else {
Â  Â  1608: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ ì‹¤ì  ì €ì¥ ì‹¤íŒ¨ë¡œ ë‹¤ìš´ë¡œë“œ/ì´ˆê¸°í™”ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.', 'error');
Â  Â  1609: Â  Â  Â  Â  Â  Â  Â  Â  Â resetAllInputs();
Â  Â  1610: Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  1611: Â  Â  Â  Â  Â  Â  }
Â  Â  1612: Â  Â  Â  Â  });
Â  Â  1613: Â  Â  }
Â  Â  1614: Â  Â  window.downloadAsPNG = downloadAsPNG;
Â  Â  1615: Â  Â Â 
Â  Â  1616: Â  Â  // --- ì»¤ìŠ¤í…€ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ ---
Â  Â  1617: Â  Â  function displayMessage(message, type) {
Â  Â  1618: Â  Â  Â  Â  const statusElement = document.getElementById('saveStatus');
Â  Â  1619: Â  Â  Â  Â  statusElement.textContent = message;
Â  Â  1620: Â  Â  Â  Â  statusElement.className = `mt-2 text-sm font-semibold text-center ${type === 'error' ? 'text-red-600' : type === 'info' ? 'text-blue-600' : 'text-green-600'}`;
Â  Â  1621: Â  Â  Â  Â Â 
Â  Â  1622: Â  Â  Â  Â  // ì¼ì • ì‹œê°„ í›„ ë©”ì‹œì§€ ì´ˆê¸°í™”
Â  Â  1623: Â  Â  Â  Â  if (type !== 'info') {
Â  Â  1624: Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  1625: Â  Â  Â  Â  Â  Â  Â  Â  statusElement.textContent = 'ì‹¤ì  ë° í™œë™ ë‚´ì—­ì„ ê¸°ë¡í•´ ì£¼ì„¸ìš”.';
Â  Â  1626: Â  Â  Â  Â  Â  Â  Â  Â  statusElement.className = 'mt-2 text-sm text-gray-500 font-semibold text-center';
Â  Â  1627: Â  Â  Â  Â  Â  Â  }, 8000);
Â  Â  1628: Â  Â  Â  Â  }
Â  Â  1629: Â  Â  }
Â  Â  1630: Â  Â  window.displayMessage = displayMessage;
Â  Â  1631: Â  Â Â 
Â  Â  1632: Â  Â  // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§ ---
Â  Â  1633: Â  Â  function handleDragStart(event) { event.dataTransfer.setData('text/plain', event.target.id); event.target.classList.add('dragging'); }
Â  Â  1634: Â  Â  function handleDragOver(event) { event.preventDefault(); event.currentTarget.classList.add('drag-hover'); }
Â  Â  1635: Â  Â  function handleDragLeave(event) { event.currentTarget.classList.remove('drag-hover'); }
Â  Â  1636: Â  Â  function handleDrop(event) {Â 
Â  Â  1637: Â  Â  Â  Â  event.preventDefault();Â 
Â  Â  1638: Â  Â  Â  Â  event.currentTarget.classList.remove('drag-hover');Â 
Â  Â  1639: Â  Â  Â  Â  const data = event.dataTransfer.getData('text/plain');Â 
Â  Â  1640: Â  Â  Â  Â  const draggedElement = document.getElementById(data);Â 
Â  Â  1641: Â  Â  Â  Â  if (draggedElement) {Â 
Â  Â  1642: Â  Â  Â  Â  Â  Â Â 
Â  Â  1643: Â  Â  Â  Â  Â  Â  if (event.currentTarget.textContent.includes('í™œë™ ì¹´ë“œë¥¼ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”')) {
Â  Â  1644: Â  Â  Â  Â  Â  Â  Â  Â  event.currentTarget.innerHTML = '';
Â  Â  1645: Â  Â  Â  Â  Â  Â  }

Â  Â  1647: Â  Â  Â  Â  Â  Â  if (event.currentTarget.querySelector(`[data-original-id="${draggedElement.id}"]`)) {
Â  Â  1648: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('ì´ë¯¸ ì¶”ê°€ëœ í™œë™ì…ë‹ˆë‹¤.', 'info');
Â  Â  1649: Â  Â  Â  Â  Â  Â  Â  Â  Â draggedElement.classList.remove('dragging');
Â  Â  1650: Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  1651: Â  Â  Â  Â  Â  Â  }
Â  Â  1652: Â  Â  Â  Â  Â  Â Â 
Â  Â  1653: Â  Â  Â  Â  Â  Â  const clone = draggedElement.cloneNode(true);
Â  Â  1654: Â  Â  Â  Â  Â  Â  clone.id = `${draggedElement.id}-plan-link-${Date.now()}`;Â 
Â  Â  1655: Â  Â  Â  Â  Â  Â  clone.dataset.originalId = draggedElement.id;Â 
Â  Â  1656: Â  Â  Â  Â  Â  Â  clone.draggable = false;Â 
Â  Â  1657: Â  Â  Â  Â  Â  Â  clone.style.cursor = 'default';
Â  Â  1658: Â  Â  Â  Â  Â  Â  clone.classList.remove('dragging', 'activity-card', 'cursor-grab', 'bg-bfdbfe', 'text-1e3a8a');
Â  Â  1659: Â  Â  Â  Â  Â  Â  clone.classList.add('bg-indigo-200', 'text-indigo-900', 'p-2', 'mb-1', 'rounded-md', 'text-xs');
Â  Â  1660: Â  Â  Â  Â  Â  Â Â 
Â  Â  1661: Â  Â  Â  Â  Â  Â  const summaryDiv = draggedElement.querySelector('.font-semibold');
Â  Â  1662: Â  Â  Â  Â  Â  Â  const detailsText = summaryDiv ? summaryDiv.textContent : 'ë‚´ìš© ì—†ìŒ';
Â  Â  1663: Â  Â  Â  Â  Â  Â Â 
Â  Â  1664: Â  Â  Â  Â  Â  Â  const cardContent = dashboardData.activities.find(a => a.id === draggedElement.id) || {};
Â  Â  1665: Â  Â  Â  Â  Â  Â Â 
Â  Â  1666: Â  Â  Â  Â  Â  Â  clone.innerHTML = `<div class="flex justify-between items-center">
Â  Â  1667: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="font-bold">${cardContent.type || 'í™œë™'} (${cardContent.time || ''})</span>
Â  Â  1668: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="this.parentElement.parentElement.remove(); checkPlanDropTargetEmpty();" class="text-red-500 hover:text-red-700 font-bold ml-2" title="ì—°ê´€ í™œë™ ì—°ê²° í•´ì œ">X</button>
Â  Â  1669: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  1670: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-1">ğŸ”— ${cardContent.target || detailsText}</p>`;Â 
Â  Â  1671: Â  Â  Â  Â  Â  Â Â 
Â  Â  1672: Â  Â  Â  Â  Â  Â  event.currentTarget.appendChild(clone);
Â  Â  1673: Â  Â  Â  Â  Â  Â  draggedElement.classList.remove('dragging');
Â  Â  1674: Â  Â  Â  Â  Â  Â  // NOTE: ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” Sheetsì— ë°˜ì˜ëœ í™œë™ë§Œ ë‚¨ê²¨ì•¼ í•˜ì§€ë§Œ, Sheets ì—°ë™ì„ ë³µì¡í•˜ê²Œ í•˜ì§€ ì•Šê¸° ìœ„í•´ ë¡œì»¬ì—ì„œë§Œ ìœ ì§€í•©ë‹ˆë‹¤.
Â  Â  1675: Â  Â  Â  Â  Â  Â  // ì›ë³¸ í™œë™ì„ ëª©ë¡ì—ì„œ ì œê±°í•˜ì§€ ì•Šì•„ì•¼ ì—¬ëŸ¬ ê³„íšì— ì—°ê²° ê°€ëŠ¥
Â  Â  1676: Â  Â  Â  Â  Â  Â  // dragSource.removeChild(draggedElement); // ì›ë³¸ì€ ìœ ì§€
Â  Â  1677: Â  Â  Â  Â  }Â 
Â  Â  1678: Â  Â  }
Â  Â  1679: Â  Â  window.handleDragStart = handleDragStart;
Â  Â  1680: Â  Â  window.handleDragOver = handleDragOver;
Â  Â  1681: Â  Â  window.handleDragLeave = handleDragLeave;
Â  Â  1682: Â  Â  window.handleDrop = handleDrop;
Â  Â  1683: Â  Â Â 
Â  Â  1684: Â  Â  // ë“œë¡­ ëŒ€ìƒì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ê³  í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ë‹¤ì‹œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
Â  Â  1685: Â  Â  function checkPlanDropTargetEmpty() {
Â  Â  1686: Â  Â  Â  Â  const target = document.getElementById('planDropTarget');
Â  Â  1687: Â  Â  Â  Â  const linkedCards = target.querySelectorAll('[data-original-id]');
Â  Â  1688: Â  Â  Â  Â  if (linkedCards.length === 0) {
Â  Â  1689: Â  Â  Â  Â  Â  Â  Â target.innerHTML = 'í™œë™ ì¹´ë“œë¥¼ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš” (ì„ íƒì‚¬í•­)';
Â  Â  1690: Â  Â  Â  Â  }
Â  Â  1691: Â  Â  }
Â  Â  1692: Â  Â  window.checkPlanDropTargetEmpty = checkPlanDropTargetEmpty;

Â  Â  1693: Â  Â Â 
Â  Â  1694: Â  Â  // --- ë°ì´í„° ì´ˆê¸°í™” ë° UI ë¡œë“œ ---
Â  Â  1695: Â  Â  // window.onload ëŒ€ì‹  DOMContentLoadedë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ˆê¸° ë¡œë“œë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.
Â  Â  1696: Â  Â  document.addEventListener('DOMContentLoaded', async () => {
Â  Â  1697: Â  Â  Â  Â Â 
Â  Â  1698: Â  Â  Â  Â  // ê¸°ë³¸ UI ë Œë”ë§ (ì•„ì´ì½˜ í™œì„±í™”)
Â  Â  1699: Â  Â  Â  Â  document.getElementById('userIdDisplay').textContent = currentUserId;
Â  Â  1700: Â  Â  Â  Â  lucide.createIcons();
Â  Â  1701: Â  Â  Â  Â Â 
Â  Â  1702: Â  Â  Â  Â  // --- ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
Â  Â  1703: Â  Â  Â  Â  document.getElementById('addActivityButton').addEventListener('click', handleAddActivity);
Â  Â  1704: Â  Â  Â  Â  document.getElementById('addPlanButton').addEventListener('click', handleAddPlan);Â 
Â  Â  1705: Â  Â  Â  Â Â 
Â  Â  1706: Â  Â  Â  Â  // í™œë™/ê³„íš ë“œë¡­ë‹¤ìš´ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
Â  Â  1707: Â  Â  Â  Â  document.getElementById('activityType').addEventListener('change', renderDynamicFields);
Â  Â  1708: Â  Â  Â  Â  document.getElementById('planActivityType').addEventListener('change', renderPlanDynamicFields);
Â  Â  1709: Â  Â  Â  Â Â 
Â  Â  1710: Â  Â  Â  Â  // ì‹¤ì  ê±´ìˆ˜ ì…ë ¥ ë¦¬ìŠ¤ë„ˆ
Â  Â  1711: Â  Â  Â  Â  document.getElementById('inputRevenueCount').addEventListener('input', (e) => {
Â  Â  1712: Â  Â  Â  Â  Â  Â  const count = parseInt(e.target.value, 10);
Â  Â  1713: Â  Â  Â  Â  Â  Â  if (!isNaN(count) && count >= 0) renderRevenueFields(count);
Â  Â  1714: Â  Â  Â  Â  });
Â  Â  1715: Â  Â  Â  Â  document.getElementById('inputContractCount').addEventListener('input', (e) => {
Â  Â  1716: Â  Â  Â  Â  Â  Â  const count = parseInt(e.target.value, 10);
Â  Â  1717: Â  Â  Â  Â  Â  Â  if (!isNaN(count) && count >= 0) renderContractFields(count);
Â  Â  1718: Â  Â  Â  Â  });
Â  Â  1719: Â  Â  Â  Â Â 
Â  Â  1720: Â  Â  Â  Â  // ê³¼ê±° ë°ì´í„° ë¡œë“œ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
Â  Â  1721: Â  Â  Â  Â  document.getElementById('loadPastDataBtn').addEventListener('click', () => {
Â  Â  1722: Â  Â  Â  Â  Â  Â  Â const name = localStorage.getItem(REPORTER_NAME_KEY);
Â  Â  1723: Â  Â  Â  Â  Â  Â  Â if (name) {
Â  Â  1724: Â  Â  Â  Â  Â  Â  Â  Â  Â fetchSalesData(name, true); // true: í™œë™ ë‚´ì—­ í¬í•¨ ë¡œë“œ
Â  Â  1725: Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  1726: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ ë¨¼ì € ë³´ê³ ì ì´ë¦„ì„ ì„ íƒí•´ì•¼ ê³¼ê±° ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
Â  Â  1727: Â  Â  Â  Â  Â  Â  Â }
Â  Â  1728: Â  Â  Â  Â  });
Â  Â  1729: Â  Â  Â  Â Â 
Â  Â  1730: Â  Â  Â  Â  // ì´ˆê¸° ë™ì  í•„ë“œ ë Œë”ë§Â 
Â  Â  1731: Â  Â  Â  Â  renderRevenueFields(0);
Â  Â  1732: Â  Â  Â  Â  renderContractFields(0);

Â  Â  1733: Â  Â  Â  Â  // ì´ˆê¸° ëŒ€ì‹œë³´ë“œ UI ì—…ë°ì´íŠ¸ (ë°ì´í„° ë¡œë“œ ì „ê¹Œì§€ëŠ” 0)
Â  Â  1734: Â  Â  Â  Â  updateDashboardUI();
Â  Â  1735: Â  Â  });

Â  Â  1736: Â  Â Â 
Â  Â  1737: Â  Â  // Sheets ì—°ë™ ë¡œì§ (í•¨ìˆ˜ ì •ì˜)
Â  Â  1738: Â  Â Â 
Â  Â  1739: Â  Â  // --- Sheetsì—ì„œ ë°ì´í„° ì½ì–´ì˜¤ê¸° (ì›”ê°„ KPI ë° í™œë™ ê±´ìˆ˜) ---
Â  Â  1740: Â  Â  // loadActivities: trueì¼ ë•Œë§Œ activities ë°°ì—´ì„ ë®ì–´ì”ë‹ˆë‹¤.
Â  Â  1741: Â  Â  async function fetchSalesData(reporterName, loadActivities = false) {
Â  Â  1742: Â  Â  Â  Â  displayMessage(`â³ ${reporterName}ë‹˜ì˜ ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ Sheetsì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`, 'info');
Â  Â  1743: 
Â  Â  1744: Â  Â  Â  Â  try {
Â  Â  1745: Â  Â  Â  Â  Â  Â  const response = await fetch(`${SHEETS_READ_URL}?action=getDashboardData&reporter=${encodeURIComponent(reporterName)}`, {
Â  Â  1746: Â  Â  Â  Â  Â  Â  Â  Â  method: 'GET',
Â  Â  1747: Â  Â  Â  Â  Â  Â  Â  Â  mode: 'cors'
Â  Â  1748: Â  Â  Â  Â  Â  Â  });
Â  Â  1749: Â  Â  Â  Â  Â  Â Â 
Â  Â  1750: Â  Â  Â  Â  Â  Â  // HTTP ì˜¤ë¥˜ ì‘ë‹µ ì²˜ë¦¬
Â  Â  1751: Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  1752: Â  Â  Â  Â  Â  Â  Â  Â  Â const errorBody = await response.text();
Â  Â  1753: Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Sheets API HTTP Error:", response.status, errorBody);
Â  Â  1754: Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
Â  Â  1755: Â  Â  Â  Â  Â  Â  }

Â  Â  1756: Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  1757: Â  Â  Â  Â  Â  Â  if (data.status === 'success' && data.message) {
Â  Â  1758: Â  Â  Â  Â  Â  Â  Â  Â  Â const fetchedData = data.message;

Â  Â  1759: Â  Â  Â  Â  Â  Â  Â  Â  Â // 1. KPI ì—…ë°ì´íŠ¸ (í•­ìƒ)
Â  Â  1760: Â  Â  Â  Â  Â  Â  Â  Â  Â const monthly = fetchedData.monthlyKPI || {};
Â  Â  1761: Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.monthlyCumulativeSales = monthly.totalCumulativeSales || 0;
Â  Â  1762: Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.myMonthlySales = monthly.myMonthlySales || 0;
Â  Â  1763: Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.chartData.activityCounts = monthly.activityCounts || {};
Â  Â  1764: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  1765: Â  Â  Â  Â  Â  Â  Â  Â  Â // 2. í™œë™ ëª©ë¡ ì—…ë°ì´íŠ¸ (ìš”ì²­ ì‹œì—ë§Œ)
Â  Â  1766: Â  Â  Â  Â  Â  Â  Â  Â  Â if (loadActivities) {
Â  Â  1767: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.activities = fetchedData.activities || [];
Â  Â  1768: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // NOTE: ê³„íš ëª©ë¡ì€ ê³¼ê±° ë‚´ì—­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì—ë„ ìœ ì§€í•˜ë„ë¡ ë¶„ë¦¬ë¨
Â  Â  1769: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // dashboardData.plans = fetchedData.plans || []; 
Â  Â  1770: Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  1771: Â  Â  Â  Â  Â  Â  Â  Â  Â // 3. ì˜¤ëŠ˜ ì‹¤ì  ìš”ì•½ ì—…ë°ì´íŠ¸ (KPI ê°±ì‹  ì‹œì—ë§Œ)
Â  Â  1772: Â  Â  Â  Â  Â  Â  Â  Â  Â // Sheetsì—ì„œ ê³„ì‚°ëœ ì˜¤ëŠ˜ KPI ê°’ë§Œ ì—…ë°ì´íŠ¸
Â  Â  1773: Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.totalRevenue = fetchedData.todaySummaries
Â  Â  1774: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .filter(s => s.type === 'revenue')
Â  Â  1775: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .reduce((sum, s) => sum + (parseFloat(s.amount) || 0), 0);
Â  Â  1776: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  1777: Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.totalContracts = fetchedData.todaySummaries
Â  Â  1778: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .filter(s => s.type === 'contract')
Â  Â  1779: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .length;

Â  Â  1780: Â  Â  Â  Â  Â  Â  Â  Â  Â // 4. UI ê°±ì‹ 
Â  Â  1781: Â  Â  Â  Â  Â  Â  Â  Â  Â renderActivityAndPlanLists();Â 
Â  Â  1782: Â  Â  Â  Â  Â  Â  Â  Â  Â updateDashboardUI();
Â  Â  1783: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âœ… ë°ì´í„° ë¡œë“œ ë° KPI ê°±ì‹  ì™„ë£Œ.', 'success');
Â  Â  1784: Â  Â  Â  Â  Â  Â  Â  Â  Â return true;
Â  Â  1785: Â  Â  Â  Â  Â  Â  } else {
Â  Â  1786: Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Sheets Load Error:", data.message || "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
Â  Â  1787: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage(`âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${data.message || 'Apps Script ì‘ë‹µ ì˜¤ë¥˜'}`, 'error');
Â  Â  1788: Â  Â  Â  Â  Â  Â  Â  Â  Â return false;
Â  Â  1789: Â  Â  Â  Â  Â  Â  }
Â  Â  1790: Â  Â  Â  Â  Â  Â Â 
Â  Â  1791: Â  Â  Â  Â  Â  Â  // NOTE: loadActivitiesê°€ falseì¼ ê²½ìš° dashboardData.activitiesëŠ” ë®ì–´ì“°ì§€ ì•Šê³  ê¸°ì¡´ ë¡œì»¬ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
Â  Â  1792: Â  Â  Â  Â  Â  Â Â 
Â  Â  1793: Â  Â  Â  Â  } catch (error) {
Â  Â  1794: Â  Â  Â  Â  Â  Â  console.error("Sheets Read Error:", error);
Â  Â  1795: Â  Â  Â  Â  Â  Â  // Sheets ì½ê¸° ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ëª©ë¡ì€ ìœ ì§€í•˜ê³  ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
Â  Â  1796: Â  Â  Â  Â  Â  Â  displayMessage('âŒ Sheets ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. (Apps Script ì¬ë°°í¬/ê¶Œí•œ í™•ì¸ ìš”ë§)', 'error');
Â  Â  1797: Â  Â  Â  Â  Â  Â  updateDashboardUI();Â 
Â  Â  1798: Â  Â  Â  Â  Â  Â  return false;
Â  Â  1799: Â  Â  Â  Â  }
Â  Â  1800: Â  Â  }
Â  Â  1801: Â  Â  window.fetchSalesData = fetchSalesData;


Â  Â  1802: Â  Â  // --- Google Sheetsë¡œ ë°ì´í„° ì „ì†¡ í•µì‹¬ í•¨ìˆ˜ ---
Â  Â  1803: Â  Â  async function sendDataToSheets(action, dataPayload) {
Â  Â  1804: Â  Â  Â  Â  const displayType = action === 'addí™œë™' ? 'í™œë™' : action === 'addê³„íš' ? 'ê³„íš' : 'ì‹¤ì ';
Â  Â  1805: Â  Â  Â  Â Â 
Â  Â  1806: Â  Â  Â  Â  if (!SHEETS_URL) {
Â  Â  1807: Â  Â  Â  Â  Â  Â  console.warn("[Google Sheets Mock] Sheets URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì „ì†¡ì„ ê±´ë„ˆë›°ë‹ˆë‹¤.");
Â  Â  1808: Â  Â  Â  Â  Â  Â  return false;
Â  Â  1809: Â  Â  Â  Â  }

Â  Â  1810: Â  Â  Â  Â  try {
Â  Â  1811: Â  Â  Â  Â  Â  Â  const response = await fetch(SHEETS_API_URL, {
Â  Â  1812: Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  1813: Â  Â  Â  Â  Â  Â  Â  Â  mode: 'no-cors',Â 
Â  Â  1814: Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  1815: Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: action, data: dataPayload })
Â  Â  1816: Â  Â  Â  Â  Â  Â  });

Â  Â  1817: Â  Â  Â  Â  Â  Â  console.log(`[Google Sheets Success Check] ${displayType} ë°ì´í„° ì „ì†¡ ì™„ë£Œ. (ì‹¤ì œ ì„œë²„ ì‘ë‹µ í™•ì¸ í•„ìš”)`);
Â  Â  1818: Â  Â  Â  Â  Â  Â  return true;

Â  Â  1819: Â  Â  Â  Â  } catch (error) {
Â  Â  1820: Â  Â  Â  Â  Â  Â  console.error(`[Google Sheets Error] ${displayType} ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨:`, error);
Â  Â  1821: Â  Â  Â  Â  Â  Â  displayMessage(`âŒ ${displayType} ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨: ${error.message} (ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” Apps Script ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”)`, 'error');
Â  Â  1822: Â  Â  Â  Â  Â  Â  return false;
Â  Â  1823: Â  Â  Â  Â  }
Â  Â  1824: Â  Â  }
Â  Â  1825: Â  Â Â 
Â  Â  1826: Â  Â Â 
Â  Â  1827: Â  Â  // --- LLM ì¸ì‚¬ì´íŠ¸ ë¶„ì„ (Gemini API í˜¸ì¶œ) ---
Â  Â  1828: Â  Â  async function analyzePerformance() {
Â  Â  1829: Â  Â  Â  Â  Â const reporterName = document.getElementById('reporterName').value.trim();
Â  Â  1830: Â  Â  Â  Â  Â const totalRevenueToday = dashboardData.performance.totalRevenue;
Â  Â  1831: Â  Â  Â  Â  Â const totalContractsToday = dashboardData.performance.totalContracts;
Â  Â  1832: Â  Â  Â  Â  Â const activityCounts = dashboardData.chartData.activityCounts;
Â  Â  1833: Â  Â  Â  Â  Â 
Â  Â  1834: Â  Â  Â  Â  Â if (!reporterName) {
Â  Â  1835: Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ AI ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ë¨¼ì € ë³´ê³ ì ì´ë¦„ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
Â  Â  1836: Â  Â  Â  Â  Â  Â  Â return;
Â  Â  1837: Â  Â  Â  Â  Â }

Â  Â  1838: Â  Â  Â  Â  Â if (totalRevenueToday === 0 && totalContractsToday === 0 && Object.keys(activityCounts).length === 0) {
Â  Â  1839: Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ ì˜¤ëŠ˜ ì‹¤ì  ë° í™œë™ ë‚´ì—­ì´ ì—†ì–´ì„œ ë¶„ì„í•  ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error');
Â  Â  1840: Â  Â  Â  Â  Â  Â  Â return;
Â  Â  1841: Â  Â  Â  Â  Â }

Â  Â  1842: Â  Â  Â  Â  Â // Mock ë°ì´í„° ìƒì„± (ì–´ì œ ì‹¤ì  ê°€ì •: ì˜¤ëŠ˜ë³´ë‹¤ 5% ë‚®ê³ , ê³„ì•½ 1ê±´ ì ìŒ)
Â  Â  1843: Â  Â  Â  Â  Â const yesterdayRevenue = Math.max(0, Math.round(totalRevenueToday * 0.95));
Â  Â  1844: Â  Â  Â  Â  Â const yesterdayContracts = Math.max(0, totalContractsToday - 1);

Â  Â  1845: Â  Â  Â  Â  Â const analysisPrompt = `
Â  Â  1846: Â  Â  Â  Â  Â  Â  Â ë‹¹ì‹ ì€ ì˜ì—… ì‚¬ì›(${reporterName})ì˜ ì¼ì¼ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.
Â  Â  1847: Â  Â  Â  Â  Â  Â  Â ì˜¤ëŠ˜ì˜ ì„±ê³¼ì™€ ê°€ìƒì˜ ì–´ì œ ì„±ê³¼ë¥¼ ë¹„êµ ë¶„ì„í•˜ê³ , í˜„ì¬ ì˜ì—… í™œë™ ìœ í˜•ì„ ê³ ë ¤í•˜ì—¬ í–¥í›„ ê°œì„ í•  ìˆ˜ ìˆëŠ” ì•¡ì…˜ í”Œëœì„ ì œì‹œí•´ì£¼ì„¸ìš”.

Â  Â  1848: Â  Â  Â  Â  Â  Â  Â --- ë°ì´í„° ---
Â  Â  1849: Â  Â  Â  Â  Â  Â  Â 1. ë³´ê³ ì: ${reporterName}
Â  Â  1850: Â  Â  Â  Â  Â  Â  Â 2. ì˜¤ëŠ˜ ë§¤ì¶œ: ${totalRevenueToday.toLocaleString()}ì›
Â  Â  1851: Â  Â  Â  Â  Â  Â  Â 3. ì˜¤ëŠ˜ ê³„ì•½ ê±´ìˆ˜: ${totalContractsToday}ê±´
Â  Â  1852: Â  Â  Â  Â  Â  Â  Â 4. ì–´ì œ (ê°€ìƒ) ë§¤ì¶œ: ${yesterdayRevenue.toLocaleString()}ì›
Â  Â  1853: Â  Â  Â  Â  Â  Â  Â 5. ì–´ì œ (ê°€ìƒ) ê³„ì•½ ê±´ìˆ˜: ${yesterdayContracts}ê±´
Â  Â  1854: Â  Â  Â  Â  Â  Â  Â 6. ì˜¤ëŠ˜ ì£¼ìš” í™œë™ ê±´ìˆ˜: ${JSON.stringify(activityCounts)}

Â  Â  1855: Â  Â  Â  Â  Â  Â  Â --- ë¶„ì„ ìš”ì²­ ---
Â  Â  1856: Â  Â  Â  Â  Â  Â  Â 1. ì„±ê³¼ ìš”ì•½: ì˜¤ëŠ˜ ì‹¤ì  ë³€í™”(ë§¤ì¶œ, ê³„ì•½ ê±´ìˆ˜)ë¥¼ ì–´ì œì™€ ë¹„êµí•˜ì—¬ í•µì‹¬ì ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.
Â  Â  1857: Â  Â  Â  Â  Â  Â  Â 2. í™œë™ ë¶„ì„: ê°€ì¥ ë†’ì€ ë¹„ì¤‘ì„ ì°¨ì§€í•˜ëŠ” í™œë™ ìœ í˜•ì— ëŒ€í•œ ê°„ëµí•œ í‰ê°€ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.
Â  Â  1858: Â  Â  Â  Â  Â  Â  Â 3. ì•¡ì…˜ í”Œëœ: ì„±ê³¼ë¥¼ ê·¹ëŒ€í™”í•˜ê±°ë‚˜ ë¶€ì¡±í•œ ë¶€ë¶„ì„ ê°œì„ í•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ì•¡ì…˜ í”Œëœ 2~3ê°€ì§€ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”.
Â  Â  1859: Â  Â  Â  Â  Â  Â  Â ê²°ê³¼ëŠ” ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì‹­ì‹œì˜¤.
Â  Â  1860: Â  Â  Â  Â  Â  Â  `;

Â  Â  1861: Â  Â  Â  Â  Â const resultElement = document.getElementById('aiAnalysisResult');
Â  Â  1862: Â  Â  Â  Â  Â resultElement.innerHTML = '<div class="text-center py-4 text-blue-600 font-semibold flex items-center justify-center"><i data-lucide="loader-circle" class="w-5 h-5 mr-2 animate-spin"></i>AIê°€ ì„±ê³¼ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (ìµœëŒ€ 10ì´ˆ ì†Œìš”)</div>';
Â  Â  1863: Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  1864: Â  Â  Â  Â  Â 
Â  Â  1865: Â  Â  Â  Â  Â let attempts = 0;
Â  Â  1866: Â  Â  Â  Â  Â const maxAttempts = 5;

Â  Â  1867: Â  Â  Â  Â  Â while (attempts < maxAttempts) {
Â  Â  1868: Â  Â  Â  Â  Â  Â  Â attempts++;
Â  Â  1869: Â  Â  Â  Â  Â  Â  Â let delay = attempts === 1 ? 0 : Math.pow(2, attempts - 1) * 1000;
Â  Â  1870: Â  Â  Â  Â  Â  Â  Â 
Â  Â  1871: Â  Â  Â  Â  Â  Â  Â if (delay > 0) {
Â  Â  1872: Â  Â  Â  Â  Â  Â  Â  Â  Â  await sleep(delay);
Â  Â  1873: Â  Â  Â  Â  Â  Â  Â }
Â  Â  1874: Â  Â  Â  Â  Â  Â  Â 
Â  Â  1875: Â  Â  Â  Â  Â  Â  Â try {
Â  Â  1876: Â  Â  Â  Â  Â  Â  Â  Â  Â // API í‚¤ëŠ” ëŸ°íƒ€ì„ì— í”Œë«í¼ì—ì„œ ì£¼ì…ë©ë‹ˆë‹¤.
Â  Â  1877: Â  Â  Â  Â  Â  Â  Â  Â  Â const apiKey = GEMINI_API_KEY; 
Â  Â  1878: Â  Â  Â  Â  Â  Â  Â  Â  Â const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

Â  Â  1879: Â  Â  Â  Â  Â  Â  Â  Â  Â const payload = {
Â  Â  1880: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contents: [{ parts: [{ text: analysisPrompt }] }],
Â  Â  1881: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â tools: [{ "google_search": {} }],
Â  Â  1882: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â systemInstruction: {
Â  Â  1883: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â parts: [{ text: "ë‹¹ì‹ ì€ ì˜ì—… ì‚¬ì›ì˜ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì‘ë‹µì€ ë¶„ì„ê³¼ ì•¡ì…˜ í”Œëœì— ì§‘ì¤‘í•˜ë©°, ì¹œì ˆí•˜ê³  ì „ë¬¸ì ì¸ í†¤ì„ ìœ ì§€í•©ë‹ˆë‹¤." }]
Â  Â  1884: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â },
Â  Â  1885: Â  Â  Â  Â  Â  Â  Â  Â  Â };
Â  Â  1886: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  1887: Â  Â  Â  Â  Â  Â  Â  Â  Â const response = await fetch(apiUrl, {
Â  Â  1888: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â method: 'POST',
Â  Â  1889: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â headers: { 'Content-Type': 'application/json' },
Â  Â  1890: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â body: JSON.stringify(payload)
Â  Â  1891: Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  1892: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  1893: Â  Â  Â  Â  Â  Â  Â  Â  Â if (!response.ok) {
Â  Â  1894: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
Â  Â  1895: Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  1896: Â  Â  Â  Â  Â  Â  Â  Â  Â const result = await response.json();
Â  Â  1897: Â  Â  Â  Â  Â  Â  Â  Â  Â const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;
Â  Â  1898: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  1899: Â  Â  Â  Â  Â  Â  Â  Â  Â // Marked.parseë¥¼ ì‚¬ìš©í•˜ì—¬ Markdownì„ HTMLë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
Â  Â  1900: Â  Â  Â  Â  Â  Â  Â  Â  Â if (analysisText) {
Â  Â  1901: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="p-4 bg-gray-50 rounded-xl shadow-inner">${marked.parse(analysisText)}</div>`;
Â  Â  1902: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  1903: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return; // ì„±ê³µ ì‹œ í•¨ìˆ˜ ì¢…ë£Œ
Â  Â  1904: Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  1905: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error("ì‘ë‹µ ë‚´ìš© ëˆ„ë½");
Â  Â  1906: Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  1907: Â  Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  1908: Â  Â  Â  Â  Â  Â  Â  Â  Â const isRetryable = error.message.includes('HTTP ì˜¤ë¥˜: 503') || error.message.includes('HTTP ì˜¤ë¥˜: 429');
Â  Â  1909: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  1910: Â  Â  Â  Â  Â  Â  Â  Â  Â if (isRetryable && attempts < maxAttempts) {
Â  Â  1911: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="text-center py-2 text-orange-600">ì¬ì‹œë„ ${attempts}/${maxAttempts}: ì„œë²„ ê³¼ë¶€í•˜. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤...</div>`;
Â  Â  1912: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â continue;
Â  Â  1913: Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  1914: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ìµœì¢… ì‹¤íŒ¨
Â  Â  1915: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="text-center py-4 text-red-600 font-semibold">âŒ AI ë¶„ì„ì— ìµœì¢… ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì›ì¸: ${error.message})</div>`;
Â  Â  1916: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  1917: Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  1918: Â  Â  Â  Â  Â  Â  Â }
Â  Â  1919: Â  Â  Â  Â  Â } // end while
Â  Â  1920: Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="text-center py-4 text-red-600 font-semibold">âŒ AI ë¶„ì„ì— ìµœì¢… ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼)</div>`;
Â  Â  1921: Â  Â  Â  Â  }
Â  Â  1922: Â  Â  Â  Â  window.analyzePerformance = analyzePerformance;

Â  Â  1923: Â  Â  Â  Â Â 
Â  Â  1924: Â  Â  Â  Â  // --- PNG ë‹¤ìš´ë¡œë“œ ë° ì´ˆê¸°í™” ---
Â  Â  1925: Â  Â  Â  Â  function downloadAsPNG() {
Â  Â  1926: Â  Â  Â  Â  Â  Â  const reporterName = document.getElementById('reporterName').value.trim();
Â  Â  1927: Â  Â  Â  Â  Â  Â  if (!reporterName) {
Â  Â  1928: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ ë³´ê³ ì ì´ë¦„ì„ ë¨¼ì € ì„ íƒí•´ì•¼ ë³´ê³ ì„œë¥¼ ì €ì¥í•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
Â  Â  1929: Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  1930: Â  Â  Â  Â  Â  Â  }

Â  Â  1931: Â  Â  Â  Â  Â  Â  // 1. Sheetsì— ìµœì¢… ì‹¤ì  ë°ì´í„° ì €ì¥ (ë¹„ë™ê¸° ì™„ë£Œ ëŒ€ê¸°)
Â  Â  1932: Â  Â  Â  Â  Â  Â  displayMessage('â³ Sheetsì— ìµœì¢… ì‹¤ì  ë°ì´í„°ë¥¼ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...', 'info');
Â  Â  1933: Â  Â  Â  Â  Â  Â  const savePromise = handleSavePerformance(); // ì‹¤ì  ì €ì¥ ë° KPI ê°±ì‹ 

Â  Â  1934: Â  Â  Â  Â  Â  Â  // 2. PNG ìº¡ì²˜ ë° ë‹¤ìš´ë¡œë“œ
Â  Â  1935: Â  Â  Â  Â  Â  Â  savePromise.then((success) => {
Â  Â  1936: Â  Â  Â  Â  Â  Â  Â  Â  Â // Sheets ì €ì¥ ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë‹¤ìš´ë¡œë“œ ë° ì´ˆê¸°í™” ì‹œë„
Â  Â  1937: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('â³ ë³´ê³ ì„œ ì´ë¯¸ì§€ë¥¼ ìº¡ì²˜í•˜ëŠ” ì¤‘...', 'info');

Â  Â  1938: Â  Â  Â  Â  Â  Â  Â  Â  Â const captureArea = document.getElementById('dashboard-container');Â 
Â  Â  1939: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  1940: Â  Â  Â  Â  Â  Â  Â  Â  Â html2canvas(captureArea, {
Â  Â  1941: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â scale: 2,Â 
Â  Â  1942: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â logging: false,
Â  Â  1943: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â useCORS: true,
Â  Â  1944: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â allowTaint: true
Â  Â  1945: Â  Â  Â  Â  Â  Â  Â  Â  Â }).then(canvas => {
Â  Â  1946: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const link = document.createElement('a');
Â  Â  1947: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const today = new Date().toISOString().slice(0, 10);
Â  Â  1948: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.download = `ì˜ì—…ì¼ì¼ë³´ê³ ì„œ_${reporterName}_${today}.png`;
Â  Â  1949: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  1950: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ë‹¤ìš´ë¡œë“œ ë§í¬ ì„¤ì •
Â  Â  1951: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.href = canvas.toDataURL('image/png');
Â  Â  1952: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  1953: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
Â  Â  1954: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(() => {
Â  Â  1955: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.click();
Â  Â  1956: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('ğŸ‰ ë³´ê³ ì„œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! ëª¨ë“  í•„ë“œë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.', 'success');
Â  Â  1957: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  1958: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // 3. ë‹¤ìš´ë¡œë“œ ë° ì €ì¥ í›„ ìµœì¢… ì´ˆê¸°í™”
Â  Â  1959: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resetAllInputs();
Â  Â  1960: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }, 500);


Â  Â  1961: Â  Â  Â  Â  Â  Â  Â  Â  Â }).catch(error => {
Â  Â  1962: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error('Error capturing dashboard:', error);
Â  Â  1963: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ì´ˆê¸°í™”ëŠ” ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ì™€ ë¬´ê´€í•˜ê²Œ ì‹¤í–‰
Â  Â  1964: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resetAllInputs();
Â  Â  1965: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âŒ ì´ë¯¸ì§€ ìº¡ì²˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì • í™•ì¸)', 'error');
Â  Â  1966: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  1967: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Sheets ì €ì¥ì— ì„±ê³µí–ˆë”ë¼ë„ PNG ì‹¤íŒ¨ ì‹œ ì´ˆê¸°í™” í›„ true ë°˜í™˜
Â  Â  1968: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return true;
Â  Â  1969: Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  1970: Â  Â  Â  Â  Â  Â  } else {
Â  Â  1971: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ ì‹¤ì  ì €ì¥ ì‹¤íŒ¨ë¡œ ë‹¤ìš´ë¡œë“œ/ì´ˆê¸°í™”ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.', 'error');
Â  Â  1972: Â  Â  Â  Â  Â  Â  Â  Â  Â resetAllInputs();
Â  Â  1973: Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  1974: Â  Â  Â  Â  Â  Â  }
Â  Â  1975: Â  Â  Â  Â  });
Â  Â  1976: Â  Â  }
Â  Â  1977: Â  Â  window.downloadAsPNG = downloadAsPNG;
Â  Â  1978: Â  Â Â 
Â  Â  1979: Â  Â  // --- ì»¤ìŠ¤í…€ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ ---
Â  Â  1980: Â  Â  function displayMessage(message, type) {
Â  Â  1981: Â  Â  Â  Â  const statusElement = document.getElementById('saveStatus');
Â  Â  1982: Â  Â  Â  Â  statusElement.textContent = message;
Â  Â  1983: Â  Â  Â  Â  statusElement.className = `mt-2 text-sm font-semibold text-center ${type === 'error' ? 'text-red-600' : type === 'info' ? 'text-blue-600' : 'text-green-600'}`;
Â  Â  1984: Â  Â  Â  Â Â 
Â  Â  1985: Â  Â  Â  Â  // ì¼ì • ì‹œê°„ í›„ ë©”ì‹œì§€ ì´ˆê¸°í™”
Â  Â  1986: Â  Â  Â  Â  if (type !== 'info') {
Â  Â  1987: Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  1988: Â  Â  Â  Â  Â  Â  Â  Â  statusElement.textContent = 'ì‹¤ì  ë° í™œë™ ë‚´ì—­ì„ ê¸°ë¡í•´ ì£¼ì„¸ìš”.';
Â  Â  1989: Â  Â  Â  Â  Â  Â  Â  Â  statusElement.className = 'mt-2 text-sm text-gray-500 font-semibold text-center';
Â  Â  1990: Â  Â  Â  Â  Â  Â  }, 8000);
Â  Â  1991: Â  Â  Â  Â  }
Â  Â  1992: Â  Â  }
Â  Â  1993: Â  Â  window.displayMessage = displayMessage;
Â  Â  1994: Â  Â Â 
Â  Â  1995: Â  Â  // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§ ---
Â  Â  1996: Â  Â  function handleDragStart(event) { event.dataTransfer.setData('text/plain', event.target.id); event.target.classList.add('dragging'); }
Â  Â  1997: Â  Â  function handleDragOver(event) { event.preventDefault(); event.currentTarget.classList.add('drag-hover'); }
Â  Â  1998: Â  Â  function handleDragLeave(event) { event.currentTarget.classList.remove('drag-hover'); }
Â  Â  1999: Â  Â  function handleDrop(event) {Â 
Â  Â  2000: Â  Â  Â  Â  event.preventDefault();Â 
Â  Â  2001: Â  Â  Â  Â  event.currentTarget.classList.remove('drag-hover');Â 
Â  Â  2002: Â  Â  Â  Â  const data = event.dataTransfer.getData('text/plain');Â 
Â  Â  2003: Â  Â  Â  Â  const draggedElement = document.getElementById(data);Â 
Â  Â  2004: Â  Â  Â  Â  if (draggedElement) {Â 
Â  Â  2005: Â  Â  Â  Â  Â  Â Â 
Â  Â  2006: Â  Â  Â  Â  Â  Â  if (event.currentTarget.textContent.includes('í™œë™ ì¹´ë“œë¥¼ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”')) {
Â  Â  2007: Â  Â  Â  Â  Â  Â  Â  Â  event.currentTarget.innerHTML = '';
Â  Â  2008: Â  Â  Â  Â  Â  Â  }

Â  Â  2009: Â  Â  Â  Â  Â  Â  if (event.currentTarget.querySelector(`[data-original-id="${draggedElement.id}"]`)) {
Â  Â  2010: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('ì´ë¯¸ ì¶”ê°€ëœ í™œë™ì…ë‹ˆë‹¤.', 'info');
Â  Â  2011: Â  Â  Â  Â  Â  Â  Â  Â  Â draggedElement.classList.remove('dragging');
Â  Â  2012: Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  2013: Â  Â  Â  Â  Â  Â  }
Â  Â  2014: Â  Â  Â  Â  Â  Â Â 
Â  Â  2015: Â  Â  Â  Â  Â  Â  const clone = draggedElement.cloneNode(true);
Â  Â  2016: Â  Â  Â  Â  Â  Â  clone.id = `${draggedElement.id}-plan-link-${Date.now()}`;Â 
Â  Â  2017: Â  Â  Â  Â  Â  Â  clone.dataset.originalId = draggedElement.id;Â 
Â  Â  2018: Â  Â  Â  Â  Â  Â  clone.draggable = false;Â 
Â  Â  2019: Â  Â  Â  Â  Â  Â  clone.style.cursor = 'default';
Â  Â  2020: Â  Â  Â  Â  Â  Â  clone.classList.remove('dragging', 'activity-card', 'cursor-grab', 'bg-bfdbfe', 'text-1e3a8a');
Â  Â  2021: Â  Â  Â  Â  Â  Â  clone.classList.add('bg-indigo-200', 'text-indigo-900', 'p-2', 'mb-1', 'rounded-md', 'text-xs');
Â  Â  2022: Â  Â  Â  Â  Â  Â Â 
Â  Â  2023: Â  Â  Â  Â  Â  Â  const summaryDiv = draggedElement.querySelector('.font-semibold');
Â  Â  2024: Â  Â  Â  Â  Â  Â  const detailsText = summaryDiv ? summaryDiv.textContent : 'ë‚´ìš© ì—†ìŒ';
Â  Â  2025: Â  Â  Â  Â  Â  Â Â 
Â  Â  2026: Â  Â  Â  Â  Â  Â  const cardContent = dashboardData.activities.find(a => a.id === draggedElement.id) || {};
Â  Â  2027: Â  Â  Â  Â  Â  Â Â 
Â  Â  2028: Â  Â  Â  Â  Â  Â  clone.innerHTML = `<div class="flex justify-between items-center">
Â  Â  2029: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="font-bold">${cardContent.type || 'í™œë™'} (${cardContent.time || ''})</span>
Â  Â  2030: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="this.parentElement.parentElement.remove(); checkPlanDropTargetEmpty();" class="text-red-500 hover:text-red-700 font-bold ml-2" title="ì—°ê´€ í™œë™ ì—°ê²° í•´ì œ">X</button>
Â  Â  2031: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  2032: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-1">ğŸ”— ${cardContent.target || detailsText}</p>`;Â 
Â  Â  2033: Â  Â  Â  Â  Â  Â Â 
Â  Â  2034: Â  Â  Â  Â  Â  Â  event.currentTarget.appendChild(clone);
Â  Â  2035: Â  Â  Â  Â  Â  Â  draggedElement.classList.remove('dragging');
Â  Â  2036: Â  Â  Â  Â  Â  Â  // NOTE: ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” Sheetsì— ë°˜ì˜ëœ í™œë™ë§Œ ë‚¨ê²¨ì•¼ í•˜ì§€ë§Œ, Sheets ì—°ë™ì„ ë³µì¡í•˜ê²Œ í•˜ì§€ ì•Šê¸° ìœ„í•´ ë¡œì»¬ì—ì„œë§Œ ìœ ì§€í•©ë‹ˆë‹¤.
Â  Â  2037: Â  Â  Â  Â  Â  Â  // ì›ë³¸ í™œë™ì„ ëª©ë¡ì—ì„œ ì œê±°í•˜ì§€ ì•Šì•„ì•¼ ì—¬ëŸ¬ ê³„íšì— ì—°ê²° ê°€ëŠ¥
Â  Â  2038: Â  Â  Â  Â  Â  Â  // dragSource.removeChild(draggedElement); // ì›ë³¸ì€ ìœ ì§€
Â  Â  2039: Â  Â  Â  Â  }Â 
Â  Â  2040: Â  Â  }
Â  Â  2041: Â  Â  window.handleDragStart = handleDragStart;
Â  Â  2042: Â  Â  window.handleDragOver = handleDragOver;
Â  Â  2043: Â  Â  window.handleDragLeave = handleDragLeave;
Â  Â  2044: Â  Â  window.handleDrop = handleDrop;
Â  Â  2045: Â  Â Â 
Â  Â  2046: Â  Â  // ë“œë¡­ ëŒ€ìƒì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ê³  í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ë‹¤ì‹œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
Â  Â  2047: Â  Â  function checkPlanDropTargetEmpty() {
Â  Â  2048: Â  Â  Â  Â  const target = document.getElementById('planDropTarget');
Â  Â  2049: Â  Â  Â  Â  const linkedCards = target.querySelectorAll('[data-original-id]');
Â  Â  2050: Â  Â  Â  Â  if (linkedCards.length === 0) {
Â  Â  2051: Â  Â  Â  Â  Â  Â  Â target.innerHTML = 'í™œë™ ì¹´ë“œë¥¼ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš” (ì„ íƒì‚¬í•­)';
Â  Â  2052: Â  Â  Â  Â  }
Â  Â  2053: Â  Â  }
Â  Â  2054: Â  Â  window.checkPlanDropTargetEmpty = checkPlanDropTargetEmpty;

Â  Â  2055: Â  Â  // --- Sheetsì—ì„œ ë°ì´í„° ì½ì–´ì˜¤ê¸° (ì›”ê°„ KPI ë° í™œë™ ê±´ìˆ˜) ---
Â  Â  2056: Â  Â  // loadActivities: trueì¼ ë•Œë§Œ activities ë°°ì—´ì„ ë®ì–´ì”ë‹ˆë‹¤.
Â  Â  2057: Â  Â  async function fetchSalesData(reporterName, loadActivities = false) {
Â  Â  2058: Â  Â  Â  Â  displayMessage(`â³ ${reporterName}ë‹˜ì˜ ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ Sheetsì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`, 'info');
Â  Â  2059: 
Â  Â  2060: Â  Â  Â  Â  try {
Â  Â  2061: Â  Â  Â  Â  Â  Â  const response = await fetch(`${SHEETS_READ_URL}?action=getDashboardData&reporter=${encodeURIComponent(reporterName)}`, {
Â  Â  2062: Â  Â  Â  Â  Â  Â  Â  Â  method: 'GET',
Â  Â  2063: Â  Â  Â  Â  Â  Â  Â  Â  mode: 'cors'
Â  Â  2064: Â  Â  Â  Â  Â  Â  });
Â  Â  2065: Â  Â  Â  Â  Â  Â Â 
Â  Â  2066: Â  Â  Â  Â  Â  Â  // HTTP ì˜¤ë¥˜ ì‘ë‹µ ì²˜ë¦¬
Â  Â  2067: Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  2068: Â  Â  Â  Â  Â  Â  Â  Â  Â const errorBody = await response.text();
Â  Â  2069: Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Sheets API HTTP Error:", response.status, errorBody);
Â  Â  2070: Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
Â  Â  2071: Â  Â  Â  Â  Â  Â  }

Â  Â  2072: Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  2073: Â  Â  Â  Â  Â  Â  if (data.status === 'success' && data.message) {
Â  Â  2074: Â  Â  Â  Â  Â  Â  Â  Â  Â const fetchedData = data.message;

Â  Â  2075: Â  Â  Â  Â  Â  Â  Â  Â  Â // 1. KPI ì—…ë°ì´íŠ¸ (í•­ìƒ)
Â  Â  2076: Â  Â  Â  Â  Â  Â  Â  Â  Â const monthly = fetchedData.monthlyKPI || {};
Â  Â  2077: Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.monthlyCumulativeSales = monthly.totalCumulativeSales || 0;
Â  Â  2078: Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.myMonthlySales = monthly.myMonthlySales || 0;
Â  Â  2079: Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.chartData.activityCounts = monthly.activityCounts || {};
Â  Â  2080: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2081: Â  Â  Â  Â  Â  Â  Â  Â  Â // 2. í™œë™ ëª©ë¡ ì—…ë°ì´íŠ¸ (ìš”ì²­ ì‹œì—ë§Œ)
Â  Â  2082: Â  Â  Â  Â  Â  Â  Â  Â  Â if (loadActivities) {
Â  Â  2083: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.activities = fetchedData.activities || [];
Â  Â  2084: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.plans = fetchedData.plans || []; // ê³¼ê±° ê³„íšë„ ë¡œë“œ
Â  Â  2085: Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  2086: Â  Â  Â  Â  Â  Â  Â  Â  Â // 3. ì˜¤ëŠ˜ ì‹¤ì  ìš”ì•½ ì—…ë°ì´íŠ¸ (KPI ê°±ì‹  ì‹œì—ë§Œ)
Â  Â  2087: Â  Â  Â  Â  Â  Â  Â  Â  Â // Sheetsì—ì„œ ê³„ì‚°ëœ ì˜¤ëŠ˜ KPI ê°’ë§Œ ì—…ë°ì´íŠ¸
Â  Â  2088: Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.totalRevenue = fetchedData.todaySummaries
Â  Â  2089: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .filter(s => s.type === 'revenue')
Â  Â  2090: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .reduce((sum, s) => sum + (parseFloat(s.amount) || 0), 0);
Â  Â  2091: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2092: Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.totalContracts = fetchedData.todaySummaries
Â  Â  2093: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .filter(s => s.type === 'contract')
Â  Â  2094: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .length;

Â  Â  2095: Â  Â  Â  Â  Â  Â  Â  Â  Â // 4. UI ê°±ì‹ 
Â  Â  2096: Â  Â  Â  Â  Â  Â  Â  Â  Â renderActivityAndPlanLists();Â 
Â  Â  2097: Â  Â  Â  Â  Â  Â  Â  Â  Â updateDashboardUI();
Â  Â  2098: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âœ… ë°ì´í„° ë¡œë“œ ë° KPI ê°±ì‹  ì™„ë£Œ.', 'success');
Â  Â  2099: Â  Â  Â  Â  Â  Â  Â  Â  Â return true;
Â  Â  2100: Â  Â  Â  Â  Â  Â  } else {
Â  Â  2101: Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Sheets Load Error:", data.message || "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
Â  Â  2102: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage(`âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${data.message || 'Apps Script ì‘ë‹µ ì˜¤ë¥˜'}`, 'error');
Â  Â  2103: Â  Â  Â  Â  Â  Â  Â  Â  Â return false;
Â  Â  2104: Â  Â  Â  Â  Â  Â  }
Â  Â  2105: Â  Â  Â  Â  Â  Â Â 
Â  Â  2106: Â  Â  Â  Â  Â  Â  // NOTE: loadActivitiesê°€ falseì¼ ê²½ìš° dashboardData.activitiesëŠ” ë®ì–´ì“°ì§€ ì•Šê³  ê¸°ì¡´ ë¡œì»¬ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
Â  Â  2107: Â  Â  Â  Â  Â  Â Â 
Â  Â  2108: Â  Â  Â  Â  } catch (error) {
Â  Â  2109: Â  Â  Â  Â  Â  Â  console.error("Sheets Read Error:", error);
Â  Â  2110: Â  Â  Â  Â  Â  Â  // Sheets ì½ê¸° ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ëª©ë¡ì€ ìœ ì§€í•˜ê³  ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
Â  Â  2111: Â  Â  Â  Â  Â  Â  displayMessage('âŒ Sheets ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. (Apps Script ì¬ë°°í¬/ê¶Œí•œ í™•ì¸ ìš”ë§)', 'error');
Â  Â  2112: Â  Â  Â  Â  Â  Â  updateDashboardUI();Â 
Â  Â  2113: Â  Â  Â  Â  Â  Â  return false;
Â  Â  2114: Â  Â  Â  Â  }
Â  Â  2115: Â  Â  }
Â  Â  2116: Â  Â  window.fetchSalesData = fetchSalesData;


Â  Â  2117: Â  Â  // --- Google Sheetsë¡œ ë°ì´í„° ì „ì†¡ í•µì‹¬ í•¨ìˆ˜ ---
Â  Â  2118: Â  Â  async function sendDataToSheets(action, dataPayload) {
Â  Â  2119: Â  Â  Â  Â  const displayType = action === 'addí™œë™' ? 'í™œë™' : action === 'addê³„íš' ? 'ê³„íš' : 'ì‹¤ì ';
Â  Â  2120: Â  Â  Â  Â Â 
Â  Â  2121: Â  Â  Â  Â  if (!SHEETS_URL) {
Â  Â  2122: Â  Â  Â  Â  Â  Â  console.warn("[Google Sheets Mock] Sheets URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì „ì†¡ì„ ê±´ë„ˆë›°ë‹ˆë‹¤.");
Â  Â  2123: Â  Â  Â  Â  Â  Â  return false;
Â  Â  2124: Â  Â  Â  Â  }

Â  Â  2125: Â  Â  Â  Â  try {
Â  Â  2126: Â  Â  Â  Â  Â  Â  const response = await fetch(SHEETS_API_URL, {
Â  Â  2127: Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  2128: Â  Â  Â  Â  Â  Â  Â  Â  mode: 'no-cors',Â 
Â  Â  2129: Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  2130: Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: action, data: dataPayload })
Â  Â  2131: Â  Â  Â  Â  Â  Â  });

Â  Â  2132: Â  Â  Â  Â  Â  Â  console.log(`[Google Sheets Success Check] ${displayType} ë°ì´í„° ì „ì†¡ ì™„ë£Œ. (ì‹¤ì œ ì„œë²„ ì‘ë‹µ í™•ì¸ í•„ìš”)`);
Â  Â  2133: Â  Â  Â  Â  Â  Â  return true;

Â  Â  2134: Â  Â  Â  Â  } catch (error) {
Â  Â  2135: Â  Â  Â  Â  Â  Â  console.error(`[Google Sheets Error] ${displayType} ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨:`, error);
Â  Â  2136: Â  Â  Â  Â  Â  Â  displayMessage(`âŒ ${displayType} ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨: ${error.message} (ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” Apps Script ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”)`, 'error');
Â  Â  2137: Â  Â  Â  Â  Â  Â  return false;
Â  Â  2138: Â  Â  Â  Â  }
Â  Â  2139: Â  Â  }
Â  Â  2140: Â  Â Â 
Â  Â  2141: Â  Â Â 
Â  Â  2142: Â  Â  // --- LLM ì¸ì‚¬ì´íŠ¸ ë¶„ì„ (Gemini API í˜¸ì¶œ) ---
Â  Â  2143: Â  Â  async function analyzePerformance() {
Â  Â  2144: Â  Â  Â  Â  Â const reporterName = document.getElementById('reporterName').value.trim();
Â  Â  2145: Â  Â  Â  Â  Â const totalRevenueToday = dashboardData.performance.totalRevenue;
Â  Â  2146: Â  Â  Â  Â  Â const totalContractsToday = dashboardData.performance.totalContracts;
Â  Â  2147: Â  Â  Â  Â  Â const activityCounts = dashboardData.chartData.activityCounts;
Â  Â  2148: Â  Â  Â  Â  Â 
Â  Â  2149: Â  Â  Â  Â  Â if (!reporterName) {
Â  Â  2150: Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ AI ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ë¨¼ì € ë³´ê³ ì ì´ë¦„ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
Â  Â  2151: Â  Â  Â  Â  Â  Â  Â return;
Â  Â  2152: Â  Â  Â  Â  Â }

Â  Â  2153: Â  Â  Â  Â  Â if (totalRevenueToday === 0 && totalContractsToday === 0 && Object.keys(activityCounts).length === 0) {
Â  Â  2154: Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ ì˜¤ëŠ˜ ì‹¤ì  ë° í™œë™ ë‚´ì—­ì´ ì—†ì–´ì„œ ë¶„ì„í•  ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error');
Â  Â  2155: Â  Â  Â  Â  Â  Â  Â return;
Â  Â  2156: Â  Â  Â  Â  Â }

Â  Â  2157: Â  Â  Â  Â  Â // Mock ë°ì´í„° ìƒì„± (ì–´ì œ ì‹¤ì  ê°€ì •: ì˜¤ëŠ˜ë³´ë‹¤ 5% ë‚®ê³ , ê³„ì•½ 1ê±´ ì ìŒ)
Â  Â  2158: Â  Â  Â  Â  Â const yesterdayRevenue = Math.max(0, Math.round(totalRevenueToday * 0.95));
Â  Â  2159: Â  Â  Â  Â  Â const yesterdayContracts = Math.max(0, totalContractsToday - 1);

Â  Â  2160: Â  Â  Â  Â  Â const analysisPrompt = `
Â  Â  2161: Â  Â  Â  Â  Â  Â  Â ë‹¹ì‹ ì€ ì˜ì—… ì‚¬ì›(${reporterName})ì˜ ì¼ì¼ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.
Â  Â  2162: Â  Â  Â  Â  Â  Â  Â ì˜¤ëŠ˜ì˜ ì„±ê³¼ì™€ ê°€ìƒì˜ ì–´ì œ ì„±ê³¼ë¥¼ ë¹„êµ ë¶„ì„í•˜ê³ , í˜„ì¬ ì˜ì—… í™œë™ ìœ í˜•ì„ ê³ ë ¤í•˜ì—¬ í–¥í›„ ê°œì„ í•  ìˆ˜ ìˆëŠ” ì•¡ì…˜ í”Œëœì„ ì œì‹œí•´ì£¼ì„¸ìš”.

Â  Â  2163: Â  Â  Â  Â  Â  Â  Â --- ë°ì´í„° ---
Â  Â  2164: Â  Â  Â  Â  Â  Â  Â 1. ë³´ê³ ì: ${reporterName}
Â  Â  2165: Â  Â  Â  Â  Â  Â  Â 2. ì˜¤ëŠ˜ ë§¤ì¶œ: ${totalRevenueToday.toLocaleString()}ì›
Â  Â  2166: Â  Â  Â  Â  Â  Â  Â 3. ì˜¤ëŠ˜ ê³„ì•½ ê±´ìˆ˜: ${totalContractsToday}ê±´
Â  Â  2167: Â  Â  Â  Â  Â  Â  Â 4. ì–´ì œ (ê°€ìƒ) ë§¤ì¶œ: ${yesterdayRevenue.toLocaleString()}ì›
Â  Â  2168: Â  Â  Â  Â  Â  Â  Â 5. ì–´ì œ (ê°€ìƒ) ê³„ì•½ ê±´ìˆ˜: ${yesterdayContracts}ê±´
Â  Â  2169: Â  Â  Â  Â  Â  Â  Â 6. ì˜¤ëŠ˜ ì£¼ìš” í™œë™ ê±´ìˆ˜: ${JSON.stringify(activityCounts)}

Â  Â  2170: Â  Â  Â  Â  Â  Â  Â --- ë¶„ì„ ìš”ì²­ ---
Â  Â  2171: Â  Â  Â  Â  Â  Â  Â 1. ì„±ê³¼ ìš”ì•½: ì˜¤ëŠ˜ ì‹¤ì  ë³€í™”(ë§¤ì¶œ, ê³„ì•½ ê±´ìˆ˜)ë¥¼ ì–´ì œì™€ ë¹„êµí•˜ì—¬ í•µì‹¬ì ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.
Â  Â  2172: Â  Â  Â  Â  Â  Â  Â 2. í™œë™ ë¶„ì„: ê°€ì¥ ë†’ì€ ë¹„ì¤‘ì„ ì°¨ì§€í•˜ëŠ” í™œë™ ìœ í˜•ì— ëŒ€í•œ ê°„ëµí•œ í‰ê°€ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.
Â  Â  2173: Â  Â  Â  Â  Â  Â  Â 3. ì•¡ì…˜ í”Œëœ: ì„±ê³¼ë¥¼ ê·¹ëŒ€í™”í•˜ê±°ë‚˜ ë¶€ì¡±í•œ ë¶€ë¶„ì„ ê°œì„ í•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ì•¡ì…˜ í”Œëœ 2~3ê°€ì§€ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”.
Â  Â  2174: Â  Â  Â  Â  Â  Â  Â ê²°ê³¼ëŠ” ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì‹­ì‹œì˜¤.
Â  Â  2175: Â  Â  Â  Â  Â  Â  `;

Â  Â  2176: Â  Â  Â  Â  Â const resultElement = document.getElementById('aiAnalysisResult');
Â  Â  2177: Â  Â  Â  Â  Â resultElement.innerHTML = '<div class="text-center py-4 text-blue-600 font-semibold flex items-center justify-center"><i data-lucide="loader-circle" class="w-5 h-5 mr-2 animate-spin"></i>AIê°€ ì„±ê³¼ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (ìµœëŒ€ 10ì´ˆ ì†Œìš”)</div>';
Â  Â  2178: Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  2179: Â  Â  Â  Â  Â 
Â  Â  2180: Â  Â  Â  Â  Â let attempts = 0;
Â  Â  2181: Â  Â  Â  Â  Â const maxAttempts = 5;

Â  Â  2182: Â  Â  Â  Â  Â while (attempts < maxAttempts) {
Â  Â  2183: Â  Â  Â  Â  Â  Â  Â attempts++;
Â  Â  2184: Â  Â  Â  Â  Â  Â  Â let delay = attempts === 1 ? 0 : Math.pow(2, attempts - 1) * 1000;
Â  Â  2185: Â  Â  Â  Â  Â  Â  Â 
Â  Â  2186: Â  Â  Â  Â  Â  Â  Â if (delay > 0) {
Â  Â  2187: Â  Â  Â  Â  Â  Â  Â  Â  Â  await sleep(delay);
Â  Â  2188: Â  Â  Â  Â  Â  Â  Â }
Â  Â  2189: Â  Â  Â  Â  Â  Â  Â 
Â  Â  2190: Â  Â  Â  Â  Â  Â  Â try {
Â  Â  2191: Â  Â  Â  Â  Â  Â  Â  Â  Â // API í‚¤ëŠ” ëŸ°íƒ€ì„ì— í”Œë«í¼ì—ì„œ ì£¼ì…ë©ë‹ˆë‹¤.
Â  Â  2192: Â  Â  Â  Â  Â  Â  Â  Â  Â const apiKey = GEMINI_API_KEY; 
Â  Â  2193: Â  Â  Â  Â  Â  Â  Â  Â  Â const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

Â  Â  2194: Â  Â  Â  Â  Â  Â  Â  Â  Â const payload = {
Â  Â  2195: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contents: [{ parts: [{ text: analysisPrompt }] }],
Â  Â  2196: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â tools: [{ "google_search": {} }],
Â  Â  2197: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â systemInstruction: {
Â  Â  2198: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â parts: [{ text: "ë‹¹ì‹ ì€ ì˜ì—… ì‚¬ì›ì˜ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì‘ë‹µì€ ë¶„ì„ê³¼ ì•¡ì…˜ í”Œëœì— ì§‘ì¤‘í•˜ë©°, ì¹œì ˆí•˜ê³  ì „ë¬¸ì ì¸ í†¤ì„ ìœ ì§€í•©ë‹ˆë‹¤." }]
Â  Â  2199: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â },
Â  Â  2200: Â  Â  Â  Â  Â  Â  Â  Â  Â };
Â  Â  2201: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2202: Â  Â  Â  Â  Â  Â  Â  Â  Â const response = await fetch(apiUrl, {
Â  Â  2203: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â method: 'POST',
Â  Â  2204: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â headers: { 'Content-Type': 'application/json' },
Â  Â  2205: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â body: JSON.stringify(payload)
Â  Â  2206: Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  2207: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2208: Â  Â  Â  Â  Â  Â  Â  Â  Â if (!response.ok) {
Â  Â  2209: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
Â  Â  2210: Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  2211: Â  Â  Â  Â  Â  Â  Â  Â  Â const result = await response.json();
Â  Â  2212: Â  Â  Â  Â  Â  Â  Â  Â  Â const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;
Â  Â  2213: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2214: Â  Â  Â  Â  Â  Â  Â  Â  Â // Marked.parseë¥¼ ì‚¬ìš©í•˜ì—¬ Markdownì„ HTMLë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
Â  Â  2215: Â  Â  Â  Â  Â  Â  Â  Â  Â if (analysisText) {
Â  Â  2216: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="p-4 bg-gray-50 rounded-xl shadow-inner">${marked.parse(analysisText)}</div>`;
Â  Â  2217: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  2218: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return; // ì„±ê³µ ì‹œ í•¨ìˆ˜ ì¢…ë£Œ
Â  Â  2219: Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  2220: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error("ì‘ë‹µ ë‚´ìš© ëˆ„ë½");
Â  Â  2221: Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  2222: Â  Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  2223: Â  Â  Â  Â  Â  Â  Â  Â  Â const isRetryable = error.message.includes('HTTP ì˜¤ë¥˜: 503') || error.message.includes('HTTP ì˜¤ë¥˜: 429');
Â  Â  2224: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2225: Â  Â  Â  Â  Â  Â  Â  Â  Â if (isRetryable && attempts < maxAttempts) {
Â  Â  2226: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="text-center py-2 text-orange-600">ì¬ì‹œë„ ${attempts}/${maxAttempts}: ì„œë²„ ê³¼ë¶€í•˜. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤...</div>`;
Â  Â  2227: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â continue;
Â  Â  2228: Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  2229: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ìµœì¢… ì‹¤íŒ¨
Â  Â  2230: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="text-center py-4 text-red-600 font-semibold">âŒ AI ë¶„ì„ì— ìµœì¢… ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì›ì¸: ${error.message})</div>`;
Â  Â  2231: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  2232: Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  2233: Â  Â  Â  Â  Â  Â  Â }
Â  Â  2234: Â  Â  Â  Â  Â } // end while
Â  Â  2235: Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="text-center py-4 text-red-600 font-semibold">âŒ AI ë¶„ì„ì— ìµœì¢… ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼)</div>`;
Â  Â  2236: Â  Â  Â  Â  }
Â  Â  2237: Â  Â  Â  Â  window.analyzePerformance = analyzePerformance;

Â  Â  2238: Â  Â  Â  Â Â 
Â  Â  2239: Â  Â  Â  Â  // --- PNG ë‹¤ìš´ë¡œë“œ ë° ì´ˆê¸°í™” ---
Â  Â  2240: Â  Â  Â  Â  function downloadAsPNG() {
Â  Â  2241: Â  Â  Â  Â  Â  Â  const reporterName = document.getElementById('reporterName').value.trim();
Â  Â  2242: Â  Â  Â  Â  Â  Â  if (!reporterName) {
Â  Â  2243: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ ë³´ê³ ì ì´ë¦„ì„ ë¨¼ì € ì„ íƒí•´ì•¼ ë³´ê³ ì„œë¥¼ ì €ì¥í•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
Â  Â  2244: Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  2245: Â  Â  Â  Â  Â  Â  }

Â  Â  2246: Â  Â  Â  Â  Â  Â  // 1. Sheetsì— ìµœì¢… ì‹¤ì  ë°ì´í„° ì €ì¥ (ë¹„ë™ê¸° ì™„ë£Œ ëŒ€ê¸°)
Â  Â  2247: Â  Â  Â  Â  Â  Â  displayMessage('â³ Sheetsì— ìµœì¢… ì‹¤ì  ë°ì´í„°ë¥¼ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...', 'info');
Â  Â  2248: Â  Â  Â  Â  Â  Â  const savePromise = handleSavePerformance(); // ì‹¤ì  ì €ì¥ ë° KPI ê°±ì‹ 

Â  Â  2249: Â  Â  Â  Â  Â  Â  // 2. PNG ìº¡ì²˜ ë° ë‹¤ìš´ë¡œë“œ
Â  Â  2250: Â  Â  Â  Â  Â  Â  savePromise.then((success) => {
Â  Â  2251: Â  Â  Â  Â  Â  Â  Â  Â  Â // Sheets ì €ì¥ ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë‹¤ìš´ë¡œë“œ ë° ì´ˆê¸°í™” ì‹œë„
Â  Â  2252: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('â³ ë³´ê³ ì„œ ì´ë¯¸ì§€ë¥¼ ìº¡ì²˜í•˜ëŠ” ì¤‘...', 'info');

Â  Â  2253: Â  Â  Â  Â  Â  Â  Â  Â  Â const captureArea = document.getElementById('dashboard-container');Â 
Â  Â  2254: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2255: Â  Â  Â  Â  Â  Â  Â  Â  Â html2canvas(captureArea, {
Â  Â  2256: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â scale: 2,Â 
Â  Â  2257: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â logging: false,
Â  Â  2258: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â useCORS: true,
Â  Â  2259: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â allowTaint: true
Â  Â  2260: Â  Â  Â  Â  Â  Â  Â  Â  Â }).then(canvas => {
Â  Â  2261: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const link = document.createElement('a');
Â  Â  2262: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const today = new Date().toISOString().slice(0, 10);
Â  Â  2263: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.download = `ì˜ì—…ì¼ì¼ë³´ê³ ì„œ_${reporterName}_${today}.png`;
Â  Â  2264: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2265: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ë‹¤ìš´ë¡œë“œ ë§í¬ ì„¤ì •
Â  Â  2266: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.href = canvas.toDataURL('image/png');
Â  Â  2267: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2268: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
Â  Â  2269: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(() => {
Â  Â  2270: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.click();
Â  Â  2271: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('ğŸ‰ ë³´ê³ ì„œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! ëª¨ë“  í•„ë“œë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.', 'success');
Â  Â  2272: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2273: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // 3. ë‹¤ìš´ë¡œë“œ ë° ì €ì¥ í›„ ìµœì¢… ì´ˆê¸°í™”
Â  Â  2274: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resetAllInputs();
Â  Â  2275: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }, 500);


Â  Â  2276: Â  Â  Â  Â  Â  Â  Â  Â  Â }).catch(error => {
Â  Â  2277: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error('Error capturing dashboard:', error);
Â  Â  2278: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ì´ˆê¸°í™”ëŠ” ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ì™€ ë¬´ê´€í•˜ê²Œ ì‹¤í–‰
Â  Â  2279: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resetAllInputs();
Â  Â  2280: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âŒ ì´ë¯¸ì§€ ìº¡ì²˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì • í™•ì¸)', 'error');
Â  Â  2281: Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  2282: Â  Â  Â  Â  Â  Â  });
Â  Â  2283: Â  Â  Â  Â  }
Â  Â  2284: Â  Â  Â  Â  window.downloadAsPNG = downloadAsPNG;
Â  Â  2285: Â  Â  Â  Â Â 
Â  Â  2286: Â  Â  Â  Â  // --- ì»¤ìŠ¤í…€ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ ---
Â  Â  2287: Â  Â  Â  Â  function displayMessage(message, type) {
Â  Â  2288: Â  Â  Â  Â  Â  Â  const statusElement = document.getElementById('saveStatus');
Â  Â  2289: Â  Â  Â  Â  Â  Â  statusElement.textContent = message;
Â  Â  2290: Â  Â  Â  Â  Â  Â  statusElement.className = `mt-2 text-sm font-semibold text-center ${type === 'error' ? 'text-red-600' : type === 'info' ? 'text-blue-600' : 'text-green-600'}`;
Â  Â  2291: Â  Â  Â  Â Â 
Â  Â  2292: Â  Â  Â  Â  Â  Â  // ì¼ì • ì‹œê°„ í›„ ë©”ì‹œì§€ ì´ˆê¸°í™”
Â  Â  2293: Â  Â  Â  Â  Â  Â  if (type !== 'info') {
Â  Â  2294: Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  2295: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusElement.textContent = 'ì‹¤ì  ë° í™œë™ ë‚´ì—­ì„ ê¸°ë¡í•´ ì£¼ì„¸ìš”.';
Â  Â  2296: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusElement.className = 'mt-2 text-sm text-gray-500 font-semibold text-center';
Â  Â  2297: Â  Â  Â  Â  Â  Â  Â  Â  }, 8000);
Â  Â  2298: Â  Â  Â  Â  Â  Â  }
Â  Â  2299: Â  Â  Â  Â  }
Â  Â  2300: Â  Â  Â  Â  window.displayMessage = displayMessage;
Â  Â  2301: Â  Â  Â  Â Â 
Â  Â  2302: Â  Â  Â  Â  // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§ ---
Â  Â  2303: Â  Â  Â  Â  function handleDragStart(event) { event.dataTransfer.setData('text/plain', event.target.id); event.target.classList.add('dragging'); }
Â  Â  2304: Â  Â  Â  Â  function handleDragOver(event) { event.preventDefault(); event.currentTarget.classList.add('drag-hover'); }
Â  Â  2305: Â  Â  Â  Â  function handleDragLeave(event) { event.currentTarget.classList.remove('drag-hover'); }
Â  Â  2306: Â  Â  Â  Â  function handleDrop(event) {Â 
Â  Â  2307: Â  Â  Â  Â  Â  Â  event.preventDefault();Â 
Â  Â  2308: Â  Â  Â  Â  Â  Â  event.currentTarget.classList.remove('drag-hover');Â 
Â  Â  2309: Â  Â  Â  Â  Â  Â  const data = event.dataTransfer.getData('text/plain');Â 
Â  Â  2310: Â  Â  Â  Â  Â  Â  const draggedElement = document.getElementById(data);Â 
Â  Â  2311: Â  Â  Â  Â  Â  Â  if (draggedElement) {Â 
Â  Â  2312: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2313: Â  Â  Â  Â  Â  Â  Â  Â  if (event.currentTarget.textContent.includes('í™œë™ ì¹´ë“œë¥¼ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”')) {
Â  Â  2314: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.currentTarget.innerHTML = '';
Â  Â  2315: Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  2316: Â  Â  Â  Â  Â  Â  Â  Â  if (event.currentTarget.querySelector(`[data-original-id="${draggedElement.id}"]`)) {
Â  Â  2317: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('ì´ë¯¸ ì¶”ê°€ëœ í™œë™ì…ë‹ˆë‹¤.', 'info');
Â  Â  2318: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â draggedElement.classList.remove('dragging');
Â  Â  2319: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  2320: Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  2321: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2322: Â  Â  Â  Â  Â  Â  Â  Â  const clone = draggedElement.cloneNode(true);
Â  Â  2323: Â  Â  Â  Â  Â  Â  Â  Â  clone.id = `${draggedElement.id}-plan-link-${Date.now()}`;Â 
Â  Â  2324: Â  Â  Â  Â  Â  Â  Â  Â  clone.dataset.originalId = draggedElement.id;Â 
Â  Â  2325: Â  Â  Â  Â  Â  Â  Â  Â  clone.draggable = false;Â 
Â  Â  2326: Â  Â  Â  Â  Â  Â  Â  Â  clone.style.cursor = 'default';
Â  Â  2327: Â  Â  Â  Â  Â  Â  Â  Â  clone.classList.remove('dragging', 'activity-card', 'cursor-grab', 'bg-bfdbfe', 'text-1e3a8a');
Â  Â  2328: Â  Â  Â  Â  Â  Â  Â  Â  clone.classList.add('bg-indigo-200', 'text-indigo-900', 'p-2', 'mb-1', 'rounded-md', 'text-xs');
Â  Â  2329: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2330: Â  Â  Â  Â  Â  Â  Â  Â  const summaryDiv = draggedElement.querySelector('.font-semibold');
Â  Â  2331: Â  Â  Â  Â  Â  Â  Â  Â  const detailsText = summaryDiv ? summaryDiv.textContent : 'ë‚´ìš© ì—†ìŒ';
Â  Â  2332: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2333: Â  Â  Â  Â  Â  Â  Â  Â  const cardContent = dashboardData.activities.find(a => a.id === draggedElement.id) || {};
Â  Â  2334: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2335: Â  Â  Â  Â  Â  Â  Â  Â  clone.innerHTML = `<div class="flex justify-between items-center">
Â  Â  2336: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="font-bold">${cardContent.type || 'í™œë™'} (${cardContent.time || ''})</span>
Â  Â  2337: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="this.parentElement.parentElement.remove(); checkPlanDropTargetEmpty();" class="text-red-500 hover:text-red-700 font-bold ml-2" title="ì—°ê´€ í™œë™ ì—°ê²° í•´ì œ">X</button>
Â  Â  2338: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  2339: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-1">ğŸ”— ${cardContent.target || detailsText}</p>`;Â 
Â  Â  2340: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2341: Â  Â  Â  Â  Â  Â  Â  Â  event.currentTarget.appendChild(clone);
Â  Â  2342: Â  Â  Â  Â  Â  Â  Â  Â  draggedElement.classList.remove('dragging');
Â  Â  2343: Â  Â  Â  Â  Â  Â  Â  Â  // NOTE: ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” Sheetsì— ë°˜ì˜ëœ í™œë™ë§Œ ë‚¨ê²¨ì•¼ í•˜ì§€ë§Œ, Sheets ì—°ë™ì„ ë³µì¡í•˜ê²Œ í•˜ì§€ ì•Šê¸° ìœ„í•´ ë¡œì»¬ì—ì„œë§Œ ìœ ì§€í•©ë‹ˆë‹¤.
Â  Â  2344: Â  Â  Â  Â  Â  Â  Â  Â  // ì›ë³¸ í™œë™ì„ ëª©ë¡ì—ì„œ ì œê±°í•˜ì§€ ì•Šì•„ì•¼ ì—¬ëŸ¬ ê³„íšì— ì—°ê²° ê°€ëŠ¥
Â  Â  2345: Â  Â  Â  Â  Â  Â  Â  Â  // dragSource.removeChild(draggedElement); // ì›ë³¸ì€ ìœ ì§€
Â  Â  2346: Â  Â  Â  Â  Â  Â  }Â 
Â  Â  2347: Â  Â  Â  Â  }
Â  Â  2348: Â  Â  Â  Â  window.handleDragStart = handleDragStart;
Â  Â  2349: Â  Â  Â  Â  window.handleDragOver = handleDragOver;
Â  Â  2350: Â  Â  Â  Â  window.handleDragLeave = handleDragLeave;
Â  Â  2351: Â  Â  Â  Â  window.handleDrop = handleDrop;
Â  Â  2352: Â  Â  Â  Â Â 
Â  Â  2353: Â  Â  Â  Â  // ë“œë¡­ ëŒ€ìƒì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ê³  í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ë‹¤ì‹œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
Â  Â  2354: Â  Â  Â  Â  function checkPlanDropTargetEmpty() {
Â  Â  2355: Â  Â  Â  Â  Â  Â  const target = document.getElementById('planDropTarget');
Â  Â  2356: Â  Â  Â  Â  Â  Â  const linkedCards = target.querySelectorAll('[data-original-id]');
Â  Â  2357: Â  Â  Â  Â  Â  Â  if (linkedCards.length === 0) {
Â  Â  2358: Â  Â  Â  Â  Â  Â  Â  Â  Â target.innerHTML = 'í™œë™ ì¹´ë“œë¥¼ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš” (ì„ íƒì‚¬í•­)';
Â  Â  2359: Â  Â  Â  Â  Â  Â  }
Â  Â  2360: Â  Â  Â  Â  }
Â  Â  2361: Â  Â  Â  Â  window.checkPlanDropTargetEmpty = checkPlanDropTargetEmpty;

Â  Â  2362: Â  Â  Â  Â  // --- Sheetsì—ì„œ ë°ì´í„° ì½ì–´ì˜¤ê¸° (ì›”ê°„ KPI ë° í™œë™ ê±´ìˆ˜) ---
Â  Â  2363: Â  Â  Â  Â  // loadActivities: trueì¼ ë•Œë§Œ activities ë°°ì—´ì„ ë®ì–´ì”ë‹ˆë‹¤.
Â  Â  2364: Â  Â  Â  Â  async function fetchSalesData(reporterName, loadActivities = false) {
Â  Â  2365: Â  Â  Â  Â  Â  Â  displayMessage(`â³ ${reporterName}ë‹˜ì˜ ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ Sheetsì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`, 'info');
Â  Â  2366: 
Â  Â  2367: Â  Â  Â  Â  Â  Â  try {
Â  Â  2368: Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${SHEETS_READ_URL}?action=getDashboardData&reporter=${encodeURIComponent(reporterName)}`, {
Â  Â  2369: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'GET',
Â  Â  2370: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mode: 'cors'
Â  Â  2371: Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  2372: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2373: Â  Â  Â  Â  Â  Â  Â  Â  // HTTP ì˜¤ë¥˜ ì‘ë‹µ ì²˜ë¦¬
Â  Â  2374: Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  2375: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const errorBody = await response.text();
Â  Â  2376: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Sheets API HTTP Error:", response.status, errorBody);
Â  Â  2377: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
Â  Â  2378: Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  2379: Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  2380: Â  Â  Â  Â  Â  Â  Â  Â  if (data.status === 'success' && data.message) {
Â  Â  2381: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const fetchedData = data.message;

Â  Â  2382: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // 1. KPI ì—…ë°ì´íŠ¸ (í•­ìƒ)
Â  Â  2383: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const monthly = fetchedData.monthlyKPI || {};
Â  Â  2384: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.monthlyCumulativeSales = monthly.totalCumulativeSales || 0;
Â  Â  2385: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.myMonthlySales = monthly.myMonthlySales || 0;
Â  Â  2386: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.chartData.activityCounts = monthly.activityCounts || {};
Â  Â  2387: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2388: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // 2. í™œë™ ëª©ë¡ ì—…ë°ì´íŠ¸ (ìš”ì²­ ì‹œì—ë§Œ)
Â  Â  2389: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (loadActivities) {
Â  Â  2390: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.activities = fetchedData.activities || [];
Â  Â  2391: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.plans = fetchedData.plans || []; // ê³¼ê±° ê³„íšë„ ë¡œë“œ
Â  Â  2392: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  2393: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // 3. ì˜¤ëŠ˜ ì‹¤ì  ìš”ì•½ ì—…ë°ì´íŠ¸ (KPI ê°±ì‹  ì‹œì—ë§Œ)
Â  Â  2394: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Sheetsì—ì„œ ê³„ì‚°ëœ ì˜¤ëŠ˜ KPI ê°’ë§Œ ì—…ë°ì´íŠ¸
Â  Â  2395: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.totalRevenue = fetchedData.todaySummaries
Â  Â  2396: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .filter(s => s.type === 'revenue')
Â  Â  2397: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .reduce((sum, s) => sum + (parseFloat(s.amount) || 0), 0);
Â  Â  2398: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2399: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â dashboardData.performance.totalContracts = fetchedData.todaySummaries
Â  Â  2400: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .filter(s => s.type === 'contract')
Â  Â  2401: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .length;

Â  Â  2402: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // 4. UI ê°±ì‹ 
Â  Â  2403: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â renderActivityAndPlanLists();Â 
Â  Â  2404: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â updateDashboardUI();
Â  Â  2405: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âœ… ë°ì´í„° ë¡œë“œ ë° KPI ê°±ì‹  ì™„ë£Œ.', 'success');
Â  Â  2406: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return true;
Â  Â  2407: Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  2408: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error("Sheets Load Error:", data.message || "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
Â  Â  2409: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage(`âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${data.message || 'Apps Script ì‘ë‹µ ì˜¤ë¥˜'}`, 'error');
Â  Â  2410: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return false;
Â  Â  2411: Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  2412: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2413: Â  Â  Â  Â  Â  Â  Â  Â  // NOTE: loadActivitiesê°€ falseì¼ ê²½ìš° dashboardData.activitiesëŠ” ë®ì–´ì“°ì§€ ì•Šê³  ê¸°ì¡´ ë¡œì»¬ ë°ì´í„°ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.
Â  Â  2414: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2415: Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  2416: Â  Â  Â  Â  Â  Â  Â  Â  console.error("Sheets Read Error:", error);
Â  Â  2417: Â  Â  Â  Â  Â  Â  Â  Â  // Sheets ì½ê¸° ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ëª©ë¡ì€ ìœ ì§€í•˜ê³  ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
Â  Â  2418: Â  Â  Â  Â  Â  Â  Â  Â  displayMessage('âŒ Sheets ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨. (Apps Script ì¬ë°°í¬/ê¶Œí•œ í™•ì¸ ìš”ë§)', 'error');
Â  Â  2419: Â  Â  Â  Â  Â  Â  Â  Â  updateDashboardUI();Â 
Â  Â  2420: Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  2421: Â  Â  Â  Â  Â  Â  }
Â  Â  2422: Â  Â  Â  Â  }
Â  Â  2423: Â  Â  Â  Â  window.fetchSalesData = fetchSalesData;


Â  Â  2424: Â  Â  Â  Â  // --- Google Sheetsë¡œ ë°ì´í„° ì „ì†¡ í•µì‹¬ í•¨ìˆ˜ ---
Â  Â  2425: Â  Â  Â  Â  async function sendDataToSheets(action, dataPayload) {
Â  Â  2426: Â  Â  Â  Â  Â  Â  const displayType = action === 'addí™œë™' ? 'í™œë™' : action === 'addê³„íš' ? 'ê³„íš' : 'ì‹¤ì ';
Â  Â  2427: Â  Â  Â  Â  Â  Â Â 
Â  Â  2428: Â  Â  Â  Â  Â  Â  if (!SHEETS_URL) {
Â  Â  2429: Â  Â  Â  Â  Â  Â  Â  Â  console.warn("[Google Sheets Mock] Sheets URLì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì „ì†¡ì„ ê±´ë„ˆë›°ë‹ˆë‹¤.");
Â  Â  2430: Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  2431: Â  Â  Â  Â  Â  Â  }

Â  Â  2432: Â  Â  Â  Â  Â  Â  try {
Â  Â  2433: Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(SHEETS_API_URL, {
Â  Â  2434: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  2435: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mode: 'no-cors',Â 
Â  Â  2436: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  2437: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ action: action, data: dataPayload })
Â  Â  2438: Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  2439: Â  Â  Â  Â  Â  Â  Â  Â  console.log(`[Google Sheets Success Check] ${displayType} ë°ì´í„° ì „ì†¡ ì™„ë£Œ. (ì‹¤ì œ ì„œë²„ ì‘ë‹µ í™•ì¸ í•„ìš”)`);
Â  Â  2440: Â  Â  Â  Â  Â  Â  Â  Â  return true;

Â  Â  2441: Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  2442: Â  Â  Â  Â  Â  Â  Â  Â  console.error(`[Google Sheets Error] ${displayType} ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨:`, error);
Â  Â  2443: Â  Â  Â  Â  Â  Â  Â  Â  displayMessage(`âŒ ${displayType} ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨: ${error.message} (ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” Apps Script ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”)`, 'error');
Â  Â  2444: Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  2445: Â  Â  Â  Â  Â  Â  }
Â  Â  2446: Â  Â  Â  Â  }
Â  Â  2447: Â  Â  Â  Â Â 
Â  Â  2448: Â  Â  Â  Â Â 
Â  Â  2449: Â  Â  Â  Â  // --- LLM ì¸ì‚¬ì´íŠ¸ ë¶„ì„ (Gemini API í˜¸ì¶œ) ---
Â  Â  2450: Â  Â  Â  Â  async function analyzePerformance() {
Â  Â  2451: Â  Â  Â  Â  Â  Â  Â const reporterName = document.getElementById('reporterName').value.trim();
Â  Â  2452: Â  Â  Â  Â  Â  Â  Â const totalRevenueToday = dashboardData.performance.totalRevenue;
Â  Â  2453: Â  Â  Â  Â  Â  Â  Â const totalContractsToday = dashboardData.performance.totalContracts;
Â  Â  2454: Â  Â  Â  Â  Â  Â  Â const activityCounts = dashboardData.chartData.activityCounts;
Â  Â  2455: Â  Â  Â  Â  Â  Â  Â 
Â  Â  2456: Â  Â  Â  Â  Â  Â  Â if (!reporterName) {
Â  Â  2457: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ AI ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ë¨¼ì € ë³´ê³ ì ì´ë¦„ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
Â  Â  2458: Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  2459: Â  Â  Â  Â  Â  Â  Â }

Â  Â  2460: Â  Â  Â  Â  Â  Â  Â if (totalRevenueToday === 0 && totalContractsToday === 0 && Object.keys(activityCounts).length === 0) {
Â  Â  2461: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ ì˜¤ëŠ˜ ì‹¤ì  ë° í™œë™ ë‚´ì—­ì´ ì—†ì–´ì„œ ë¶„ì„í•  ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error');
Â  Â  2462: Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  2463: Â  Â  Â  Â  Â  Â  Â }

Â  Â  2464: Â  Â  Â  Â  Â  Â  Â // Mock ë°ì´í„° ìƒì„± (ì–´ì œ ì‹¤ì  ê°€ì •: ì˜¤ëŠ˜ë³´ë‹¤ 5% ë‚®ê³ , ê³„ì•½ 1ê±´ ì ìŒ)
Â  Â  2465: Â  Â  Â  Â  Â  Â  Â const yesterdayRevenue = Math.max(0, Math.round(totalRevenueToday * 0.95));
Â  Â  2466: Â  Â  Â  Â  Â  Â  Â const yesterdayContracts = Math.max(0, totalContractsToday - 1);

Â  Â  2467: Â  Â  Â  Â  Â  Â  Â const analysisPrompt = `
Â  Â  2468: Â  Â  Â  Â  Â  Â  Â  Â  Â ë‹¹ì‹ ì€ ì˜ì—… ì‚¬ì›(${reporterName})ì˜ ì¼ì¼ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤.
Â  Â  2469: Â  Â  Â  Â  Â  Â  Â  Â  Â ì˜¤ëŠ˜ì˜ ì„±ê³¼ì™€ ê°€ìƒì˜ ì–´ì œ ì„±ê³¼ë¥¼ ë¹„êµ ë¶„ì„í•˜ê³ , í˜„ì¬ ì˜ì—… í™œë™ ìœ í˜•ì„ ê³ ë ¤í•˜ì—¬ í–¥í›„ ê°œì„ í•  ìˆ˜ ìˆëŠ” ì•¡ì…˜ í”Œëœì„ ì œì‹œí•´ì£¼ì„¸ìš”.

Â  Â  2470: Â  Â  Â  Â  Â  Â  Â  Â  Â --- ë°ì´í„° ---
Â  Â  2471: Â  Â  Â  Â  Â  Â  Â  Â  Â 1. ë³´ê³ ì: ${reporterName}
Â  Â  2472: Â  Â  Â  Â  Â  Â  Â  Â  Â 2. ì˜¤ëŠ˜ ë§¤ì¶œ: ${totalRevenueToday.toLocaleString()}ì›
Â  Â  2473: Â  Â  Â  Â  Â  Â  Â  Â  Â 3. ì˜¤ëŠ˜ ê³„ì•½ ê±´ìˆ˜: ${totalContractsToday}ê±´
Â  Â  2474: Â  Â  Â  Â  Â  Â  Â  Â  Â 4. ì–´ì œ (ê°€ìƒ) ë§¤ì¶œ: ${yesterdayRevenue.toLocaleString()}ì›
Â  Â  2475: Â  Â  Â  Â  Â  Â  Â  Â  Â 5. ì–´ì œ (ê°€ìƒ) ê³„ì•½ ê±´ìˆ˜: ${yesterdayContracts}ê±´
Â  Â  2476: Â  Â  Â  Â  Â  Â  Â  Â  Â 6. ì˜¤ëŠ˜ ì£¼ìš” í™œë™ ê±´ìˆ˜: ${JSON.stringify(activityCounts)}

Â  Â  2477: Â  Â  Â  Â  Â  Â  Â  Â  Â --- ë¶„ì„ ìš”ì²­ ---
Â  Â  2478: Â  Â  Â  Â  Â  Â  Â  Â  Â 1. ì„±ê³¼ ìš”ì•½: ì˜¤ëŠ˜ ì‹¤ì  ë³€í™”(ë§¤ì¶œ, ê³„ì•½ ê±´ìˆ˜)ë¥¼ ì–´ì œì™€ ë¹„êµí•˜ì—¬ í•µì‹¬ì ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.
Â  Â  2479: Â  Â  Â  Â  Â  Â  Â  Â  Â 2. í™œë™ ë¶„ì„: ê°€ì¥ ë†’ì€ ë¹„ì¤‘ì„ ì°¨ì§€í•˜ëŠ” í™œë™ ìœ í˜•ì— ëŒ€í•œ ê°„ëµí•œ í‰ê°€ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.
Â  Â  2480: Â  Â  Â  Â  Â  Â  Â  Â  Â 3. ì•¡ì…˜ í”Œëœ: ì„±ê³¼ë¥¼ ê·¹ëŒ€í™”í•˜ê±°ë‚˜ ë¶€ì¡±í•œ ë¶€ë¶„ì„ ê°œì„ í•˜ê¸° ìœ„í•œ êµ¬ì²´ì ì¸ ì•¡ì…˜ í”Œëœ 2~3ê°€ì§€ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”.
Â  Â  2481: Â  Â  Â  Â  Â  Â  Â  Â  Â ê²°ê³¼ëŠ” ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì‹­ì‹œì˜¤.
Â  Â  2482: Â  Â  Â  Â  Â  Â  Â  Â  `;

Â  Â  2483: Â  Â  Â  Â  Â  Â  Â const resultElement = document.getElementById('aiAnalysisResult');
Â  Â  2484: Â  Â  Â  Â  Â  Â  Â resultElement.innerHTML = '<div class="text-center py-4 text-blue-600 font-semibold flex items-center justify-center"><i data-lucide="loader-circle" class="w-5 h-5 mr-2 animate-spin"></i>AIê°€ ì„±ê³¼ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... (ìµœëŒ€ 10ì´ˆ ì†Œìš”)</div>';
Â  Â  2485: Â  Â  Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  2486: Â  Â  Â  Â  Â  Â  Â 
Â  Â  2487: Â  Â  Â  Â  Â  Â  Â let attempts = 0;
Â  Â  2488: Â  Â  Â  Â  Â  Â  Â const maxAttempts = 5;

Â  Â  2489: Â  Â  Â  Â  Â  Â  Â while (attempts < maxAttempts) {
Â  Â  2490: Â  Â  Â  Â  Â  Â  Â  Â  Â attempts++;
Â  Â  2491: Â  Â  Â  Â  Â  Â  Â  Â  Â let delay = attempts === 1 ? 0 : Math.pow(2, attempts - 1) * 1000;
Â  Â  2492: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2493: Â  Â  Â  Â  Â  Â  Â  Â  Â if (delay > 0) {
Â  Â  2494: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await sleep(delay);
Â  Â  2495: Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  2496: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2497: Â  Â  Â  Â  Â  Â  Â  Â  Â try {
Â  Â  2498: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // API í‚¤ëŠ” ëŸ°íƒ€ì„ì— í”Œë«í¼ì—ì„œ ì£¼ì…ë©ë‹ˆë‹¤.
Â  Â  2499: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const apiKey = GEMINI_API_KEY; 
Â  Â  2500: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

Â  Â  2501: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const payload = {
Â  Â  2502: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â contents: [{ parts: [{ text: analysisPrompt }] }],
Â  Â  2503: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â tools: [{ "google_search": {} }],
Â  Â  2504: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â systemInstruction: {
Â  Â  2505: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â parts: [{ text: "ë‹¹ì‹ ì€ ì˜ì—… ì‚¬ì›ì˜ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ëŠ” ì „ë¬¸ AI ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì‘ë‹µì€ ë¶„ì„ê³¼ ì•¡ì…˜ í”Œëœì— ì§‘ì¤‘í•˜ë©°, ì¹œì ˆí•˜ê³  ì „ë¬¸ì ì¸ í†¤ì„ ìœ ì§€í•©ë‹ˆë‹¤." }]
Â  Â  2506: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â },
Â  Â  2507: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â };
Â  Â  2508: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2509: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const response = await fetch(apiUrl, {
Â  Â  2510: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â method: 'POST',
Â  Â  2511: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â headers: { 'Content-Type': 'application/json' },
Â  Â  2512: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â body: JSON.stringify(payload)
Â  Â  2513: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  2514: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2515: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (!response.ok) {
Â  Â  2516: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(`HTTP ì˜¤ë¥˜: ${response.status}`);
Â  Â  2517: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  2518: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const result = await response.json();
Â  Â  2519: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;
Â  Â  2520: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2521: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // Marked.parseë¥¼ ì‚¬ìš©í•˜ì—¬ Markdownì„ HTMLë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
Â  Â  2522: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (analysisText) {
Â  Â  2523: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="p-4 bg-gray-50 rounded-xl shadow-inner">${marked.parse(analysisText)}</div>`;
Â  Â  2524: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lucide.createIcons();
Â  Â  2525: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return; // ì„±ê³µ ì‹œ í•¨ìˆ˜ ì¢…ë£Œ
Â  Â  2526: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  2527: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error("ì‘ë‹µ ë‚´ìš© ëˆ„ë½");
Â  Â  2528: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }

Â  Â  2529: Â  Â  Â  Â  Â  Â  Â  Â  Â } catch (error) {
Â  Â  2530: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const isRetryable = error.message.includes('HTTP ì˜¤ë¥˜: 503') || error.message.includes('HTTP ì˜¤ë¥˜: 429');
Â  Â  2531: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2532: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (isRetryable && attempts < maxAttempts) {
Â  Â  2533: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="text-center py-2 text-orange-600">ì¬ì‹œë„ ${attempts}/${maxAttempts}: ì„œë²„ ê³¼ë¶€í•˜. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤...</div>`;
Â  Â  2534: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â continue;
Â  Â  2535: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  2536: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ìµœì¢… ì‹¤íŒ¨
Â  Â  2537: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="text-center py-4 text-red-600 font-semibold">âŒ AI ë¶„ì„ì— ìµœì¢… ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì›ì¸: ${error.message})</div>`;
Â  Â  2538: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  2539: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  2540: Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  2541: Â  Â  Â  Â  Â  Â  Â } // end while
Â  Â  2542: Â  Â  Â  Â  Â  Â  Â resultElement.innerHTML = `<div class="text-center py-4 text-red-600 font-semibold">âŒ AI ë¶„ì„ì— ìµœì¢… ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼)</div>`;
Â  Â  2543: Â  Â  Â  Â  }
Â  Â  2544: Â  Â  Â  Â  window.analyzePerformance = analyzePerformance;

Â  Â  2545: Â  Â  Â  Â Â 
Â  Â  2546: Â  Â  Â  Â  // --- PNG ë‹¤ìš´ë¡œë“œ ë° ì´ˆê¸°í™” ---
Â  Â  2547: Â  Â  Â  Â  function downloadAsPNG() {
Â  Â  2548: Â  Â  Â  Â  Â  Â  const reporterName = document.getElementById('reporterName').value.trim();
Â  Â  2549: Â  Â  Â  Â  Â  Â  if (!reporterName) {
Â  Â  2550: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âš ï¸ ë³´ê³ ì ì´ë¦„ì„ ë¨¼ì € ì„ íƒí•´ì•¼ ë³´ê³ ì„œë¥¼ ì €ì¥í•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
Â  Â  2551: Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  2552: Â  Â  Â  Â  Â  Â  }

Â  Â  2553: Â  Â  Â  Â  Â  Â  // 1. Sheetsì— ìµœì¢… ì‹¤ì  ë°ì´í„° ì €ì¥ (ë¹„ë™ê¸° ì™„ë£Œ ëŒ€ê¸°)
Â  Â  2554: Â  Â  Â  Â  Â  Â  displayMessage('â³ Sheetsì— ìµœì¢… ì‹¤ì  ë°ì´í„°ë¥¼ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...', 'info');
Â  Â  2555: Â  Â  Â  Â  Â  Â  const savePromise = handleSavePerformance(); // ì‹¤ì  ì €ì¥ ë° KPI ê°±ì‹ 

Â  Â  2556: Â  Â  Â  Â  Â  Â  // 2. PNG ìº¡ì²˜ ë° ë‹¤ìš´ë¡œë“œ
Â  Â  2557: Â  Â  Â  Â  Â  Â  savePromise.then((success) => {
Â  Â  2558: Â  Â  Â  Â  Â  Â  Â  Â  Â // Sheets ì €ì¥ ì„±ê³µ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ë‹¤ìš´ë¡œë“œ ë° ì´ˆê¸°í™” ì‹œë„
Â  Â  2559: Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('â³ ë³´ê³ ì„œ ì´ë¯¸ì§€ë¥¼ ìº¡ì²˜í•˜ëŠ” ì¤‘...', 'info');

Â  Â  2560: Â  Â  Â  Â  Â  Â  Â  Â  Â const captureArea = document.getElementById('dashboard-container');Â 
Â  Â  2561: Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2562: Â  Â  Â  Â  Â  Â  Â  Â  Â html2canvas(captureArea, {
Â  Â  2563: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â scale: 2,Â 
Â  Â  2564: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â logging: false,
Â  Â  2565: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â useCORS: true,
Â  Â  2566: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â allowTaint: true
Â  Â  2567: Â  Â  Â  Â  Â  Â  Â  Â  Â }).then(canvas => {
Â  Â  2568: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const link = document.createElement('a');
Â  Â  2569: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const today = new Date().toISOString().slice(0, 10);
Â  Â  2570: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.download = `ì˜ì—…ì¼ì¼ë³´ê³ ì„œ_${reporterName}_${today}.png`;
Â  Â  2571: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2572: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ë‹¤ìš´ë¡œë“œ ë§í¬ ì„¤ì •
Â  Â  2573: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.href = canvas.toDataURL('image/png');
Â  Â  2574: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2575: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
Â  Â  2576: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setTimeout(() => {
Â  Â  2577: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â link.click();
Â  Â  2578: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('ğŸ‰ ë³´ê³ ì„œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! ëª¨ë“  í•„ë“œë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.', 'success');
Â  Â  2579: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  2280: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // 3. ë‹¤ìš´ë¡œë“œ ë° ì €ì¥ í›„ ìµœì¢… ì´ˆê¸°í™”
Â  Â  2281: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resetAllInputs();
Â  Â  2282: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }, 500);


Â  Â  2283: Â  Â  Â  Â  Â  Â  Â  Â  Â }).catch(error => {
Â  Â  2284: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â console.error('Error capturing dashboard:', error);
Â  Â  2285: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ì´ˆê¸°í™”ëŠ” ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ì™€ ë¬´ê´€í•˜ê²Œ ì‹¤í–‰
Â  Â  2286: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â resetAllInputs();
Â  Â  2287: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('âŒ ì´ë¯¸ì§€ ìº¡ì²˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ë³´ì•ˆ ì„¤ì • í™•ì¸)', 'error');
Â  Â  2288: Â  Â  Â  Â  Â  Â  Â  Â  Â });
Â  Â  2289: Â  Â  Â  Â  Â  Â  });
Â  Â  2290: Â  Â  Â  Â  }
Â  Â  2291: Â  Â  Â  Â  window.downloadAsPNG = downloadAsPNG;
Â  Â  2292: Â  Â  Â  Â Â 
Â  Â  2293: Â  Â  Â  Â  // --- ì»¤ìŠ¤í…€ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜ ---
Â  Â  2294: Â  Â  Â  Â  function displayMessage(message, type) {
Â  Â  2295: Â  Â  Â  Â  Â  Â  const statusElement = document.getElementById('saveStatus');
Â  Â  2296: Â  Â  Â  Â  Â  Â  statusElement.textContent = message;
Â  Â  2297: Â  Â  Â  Â  Â  Â  statusElement.className = `mt-2 text-sm font-semibold text-center ${type === 'error' ? 'text-red-600' : type === 'info' ? 'text-blue-600' : 'text-green-600'}`;
Â  Â  2298: Â  Â  Â  Â Â 
Â  Â  2299: Â  Â  Â  Â  Â  Â  // ì¼ì • ì‹œê°„ í›„ ë©”ì‹œì§€ ì´ˆê¸°í™”
Â  Â  2300: Â  Â  Â  Â  Â  Â  if (type !== 'info') {
Â  Â  2301: Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  2302: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusElement.textContent = 'ì‹¤ì  ë° í™œë™ ë‚´ì—­ì„ ê¸°ë¡í•´ ì£¼ì„¸ìš”.';
Â  Â  2303: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusElement.className = 'mt-2 text-sm text-gray-500 font-semibold text-center';
Â  Â  2304: Â  Â  Â  Â  Â  Â  Â  Â  }, 8000);
Â  Â  2305: Â  Â  Â  Â  Â  Â  }
Â  Â  2306: Â  Â  Â  Â  }
Â  Â  2307: Â  Â  Â  Â  window.displayMessage = displayMessage;
Â  Â  2308: Â  Â  Â  Â Â 
Â  Â  2309: Â  Â  Â  Â  // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë¡œì§ ---
Â  Â  2310: Â  Â  Â  Â  function handleDragStart(event) { event.dataTransfer.setData('text/plain', event.target.id); event.target.classList.add('dragging'); }
Â  Â  2311: Â  Â  Â  Â  function handleDragOver(event) { event.preventDefault(); event.currentTarget.classList.add('drag-hover'); }
Â  Â  2312: Â  Â  Â  Â  function handleDragLeave(event) { event.currentTarget.classList.remove('drag-hover'); }
Â  Â  2313: Â  Â  Â  Â  function handleDrop(event) {Â 
Â  Â  2314: Â  Â  Â  Â  Â  Â  event.preventDefault();Â 
Â  Â  2315: Â  Â  Â  Â  Â  Â  event.currentTarget.classList.remove('drag-hover');Â 
Â  Â  2316: Â  Â  Â  Â  Â  Â  const data = event.dataTransfer.getData('text/plain');Â 
Â  Â  2317: Â  Â  Â  Â  Â  Â  const draggedElement = document.getElementById(data);Â 
Â  Â  2318: Â  Â  Â  Â  Â  Â  if (draggedElement) {Â 
Â  Â  2319: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2320: Â  Â  Â  Â  Â  Â  Â  Â  if (event.currentTarget.textContent.includes('í™œë™ ì¹´ë“œë¥¼ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”')) {
Â  Â  2321: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.currentTarget.innerHTML = '';
Â  Â  2322: Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  2323: Â  Â  Â  Â  Â  Â  Â  Â  if (event.currentTarget.querySelector(`[data-original-id="${draggedElement.id}"]`)) {
Â  Â  2324: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayMessage('ì´ë¯¸ ì¶”ê°€ëœ í™œë™ì…ë‹ˆë‹¤.', 'info');
Â  Â  2325: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â draggedElement.classList.remove('dragging');
Â  Â  2326: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  2327: Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  2328: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2329: Â  Â  Â  Â  Â  Â  Â  Â  const clone = draggedElement.cloneNode(true);
Â  Â  2330: Â  Â  Â  Â  Â  Â  Â  Â  clone.id = `${draggedElement.id}-plan-link-${Date.now()}`;Â 
Â  Â  2331: Â  Â  Â  Â  Â  Â  Â  Â  clone.dataset.originalId = draggedElement.id;Â 
Â  Â  2332: Â  Â  Â  Â  Â  Â  Â  Â  clone.draggable = false;Â 
Â  Â  2333: Â  Â  Â  Â  Â  Â  Â  Â  clone.style.cursor = 'default';
Â  Â  2334: Â  Â  Â  Â  Â  Â  Â  Â  clone.classList.remove('dragging', 'activity-card', 'cursor-grab', 'bg-bfdbfe', 'text-1e3a8a');
Â  Â  2335: Â  Â  Â  Â  Â  Â  Â  Â  clone.classList.add('bg-indigo-200', 'text-indigo-900', 'p-2', 'mb-1', 'rounded-md', 'text-xs');
Â  Â  2336: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2337: Â  Â  Â  Â  Â  Â  Â  Â  const summaryDiv = draggedElement.querySelector('.font-semibold');
Â  Â  2338: Â  Â  Â  Â  Â  Â  Â  Â  const detailsText = summaryDiv ? summaryDiv.textContent : 'ë‚´ìš© ì—†ìŒ';
Â  Â  2339: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2340: Â  Â  Â  Â  Â  Â  Â  Â  const cardContent = dashboardData.activities.find(a => a.id === draggedElement.id) || {};
Â  Â  2341: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2342: Â  Â  Â  Â  Â  Â  Â  Â  clone.innerHTML = `<div class="flex justify-between items-center">
Â  Â  2343: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="font-bold">${cardContent.type || 'í™œë™'} (${cardContent.time || ''})</span>
Â  Â  2344: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="this.parentElement.parentElement.remove(); checkPlanDropTargetEmpty();" class="text-red-500 hover:text-red-700 font-bold ml-2" title="ì—°ê´€ í™œë™ ì—°ê²° í•´ì œ">X</button>
Â  Â  2345: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  2346: Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-1">ğŸ”— ${cardContent.target || detailsText}</p>`;Â 
Â  Â  2347: Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  2348: Â  Â  Â  Â  Â  Â  Â  Â  event.currentTarget.appendChild(clone);
Â  Â  2349: Â  Â  Â  Â  Â  Â  Â  Â  draggedElement.classList.remove('dragging');
Â  Â  2350: Â  Â  Â  Â  Â  Â  Â  Â  // NOTE: ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” Sheetsì— ë°˜ì˜ëœ í™œë™ë§Œ ë‚¨ê²¨ì•¼ í•˜ì§€ë§Œ, Sheets ì—°ë™ì„ ë³µì¡í•˜ê²Œ í•˜ì§€ ì•Šê¸° ìœ„í•´ ë¡œì»¬ì—ì„œë§Œ ìœ ì§€í•©ë‹ˆë‹¤.
Â  Â  2351: Â  Â  Â  Â  Â  Â  Â  Â  // ì›ë³¸ í™œë™ì„ ëª©ë¡ì—ì„œ ì œê±°í•˜ì§€ ì•Šì•„ì•¼ ì—¬ëŸ¬ ê³„íšì— ì—°ê²° ê°€ëŠ¥
Â  Â  2352: Â  Â  Â  Â  Â  Â  Â  Â  // dragSource.removeChild(draggedElement); // ì›ë³¸ì€ ìœ ì§€
Â  Â  2353: Â  Â  Â  Â  Â  Â  }Â 
Â  Â  2354: Â  Â  Â  Â  }
Â  Â  2355: Â  Â  Â  Â  window.handleDragStart = handleDragStart;
Â  Â  2356: Â  Â  Â  Â  window.handleDragOver = handleDragOver;
Â  Â  2357: Â  Â  Â  Â  window.handleDragLeave = handleDragLeave;
Â  Â  2358: Â  Â  Â  Â  window.handleDrop = handleDrop;
Â  Â  2359: Â  Â  Â  Â Â 
Â  Â  2360: Â  Â  Â  Â  // ë“œë¡­ ëŒ€ìƒì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ê³  í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ë‹¤ì‹œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
Â  Â  2361: Â  Â  Â  Â  function checkPlanDropTargetEmpty() {
Â  Â  2362: Â  Â  Â  Â  Â  Â  const target = document.getElementById('planDropTarget');
Â  Â  2363: Â  Â  Â  Â  Â  Â  const linkedCards = target.querySelectorAll('[data-original-id]');
Â  Â  2364: Â  Â  Â  Â  Â  Â  if (linkedCards.length === 0) {
Â  Â  2365: Â  Â  Â  Â  Â  Â  Â  Â  Â target.innerHTML = 'í™œë™ ì¹´ë“œë¥¼ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš” (ì„ íƒì‚¬í•­)';
Â  Â  2366: Â  Â  Â  Â  Â  Â  }
Â  Â  2367: Â  Â  Â  Â  }
Â  Â  2368: Â  Â  Â  Â  window.checkPlanDropTargetEmpty = checkPlanDropTargetEmpty;

Â  Â  2369: Â  Â  Â  Â  // --- Sheetsì—ì„œ ë°ì´í„° ì½ì–´ì˜¤ê¸° (ì›”ê°„ KPI ë° í™œë™ ê±´ìˆ˜) ---
Â  Â  2370: Â  Â  Â  Â  // loadActivities: true
