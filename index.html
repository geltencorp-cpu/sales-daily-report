<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>영업 일일 보고서 대시보드</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas는 PNG 다운로드용 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> 
    <!-- 아이콘 로드 (Lucide Icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 📊 Chart.js 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        /* Custom styles and font setting */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-main {
            max-width: 1024px;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .drag-source, .drag-target {
            min-height: 5rem;
            border: 2px dashed #d1d5db;
            padding: 0.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s;
        }
        .drag-target.drag-hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .activity-card {
            cursor: grab;
            background-color: #bfdbfe;
            color: #1e3a8a;
            border: 1px solid #60a5fa;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .activity-card.dragging {
            opacity: 0.5;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .plan-card {
            background-color: #e0f2fe;
            border: 1px solid #93c5fd;
            color: #0c4a6e;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .summary-card {
            background-color: #f0fdf4; /* Green background for success */
            border: 1px solid #4ade80;
            color: #065f46;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        /* AI 분석 결과의 가독성을 높이기 위한 스타일 */
        #aiAnalysisResult p {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        #aiAnalysisResult ul, #aiAnalysisResult ol {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            padding-left: 1.5rem;
            list-style: disc; /* 리스트 스타일 추가 */
        }
        #aiAnalysisResult li {
            margin-bottom: 0.25rem;
            line-height: 1.4;
        }
        /* 로딩 스피너 스타일 */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #10b981; /* 에메랄드 색상 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="loading-overlay" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="spinner"></div>
    </div>
    
    <div id="dashboard-container" class="container-main mx-auto space-y-8 p-4">

        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-blue-800">영업 일일 보고서 대시보드</h1>
            <p class="text-gray-600 mt-2">데이터를 기반으로 영업 성과를 분석하고 인사이트를 발견하세요.</p>
            <p class="text-xs text-gray-400 mt-1">사용자 ID: <span id="userIdDisplay">03937239367092324634</span></p>
        </header>

        <!-- Main Content Area: Left (Activity & Plans & Analysis) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Column 1 & 2: Activity, Plans, & Analysis (lg:col-span-2) -->
            <div class="lg:col-span-2 space-y-6">

                <!-- 1. 일일 활동 기록 -->
                <section class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="file-pen" class="w-5 h-5 mr-2 text-blue-500"></i>
                        ✍️ 일일 활동 기록 및 상세 내용 추가
                    </h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">보고자 이름:</label>
                            <select id="reporterName" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border transition duration-150">
                                <option value="">--- 이름을 선택하세요 ---</option>
                                <option value="정봉주">정봉주</option>
                                <option value="김강">김강</option>
                                <option value="허연">허연</option>
                                <option value="김산">김산</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">영업 활동 유형 선택:</label>
                            <select id="activityType" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                                <option value="">--- 활동 유형을 선택하세요 ---</option>
                                <option value="공문영업">공문영업</option>
                                <option value="인바운드 영업">인바운드 영업</option>
                                <option value="아웃바운드 영업">아웃바운드 영업</option>
                                <option value="메일영업">메일영업</option>
                                <option value="SNS 영업">SNS 영업</option>
                                <option value="대면 영업">대면 영업</option>
                                <option value="기타영업">기타영업</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 동적으로 생성될 입력 필드 영역 -->
                    <div id="dynamicActivityFields" class="mt-4 border-l-4 border-blue-200 pl-4 py-2">
                        <p class="text-sm text-gray-400">활동 유형을 선택하면 관련 입력 필드가 여기에 나타납니다.</p>
                    </div>

                    <button id="addActivityButton" class="w-full mt-6 bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600 transition">
                        + 활동 내역 추가
                    </button>
                    
                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-700 mb-2">작성된 활동 목록 (아래로 누적) - 카드를 끌어 '내일 계획'에 연결하세요</h3>
                        <button id="loadPastDataBtn" class="w-full bg-gray-100 text-gray-700 p-2 mb-2 rounded-lg text-sm hover:bg-gray-200 transition flex items-center justify-center">
                            <i data-lucide="history" class="w-4 h-4 mr-2"></i>
                            📅 과거 내역 불러오기 (최근 1개월)
                        </button>
                        <div id="activityList" class="drag-source bg-gray-50 p-3 min-h-[5rem]"
                            ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                            <p class="text-gray-400 text-sm">아직 등록된 활동이 없습니다. 위의 양식으로 활동 내역을 추가해 보세요.</p>
                        </div>
                    </div>
                </section>

                <!-- 2. 내일 계획 작성 -->
                <section class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="clipboard-list" class="w-5 h-5 mr-2 text-indigo-500"></i>
                        📝 내일 계획 작성
                    </h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">업무 활동 유형 선택:</label>
                            <select id="planActivityType" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                                <option value="">--- 유형 선택 ---</option>
                                <option value="공문영업">공문영업</option>
                                <option value="인바운드 영업">인바운드 영업</option>
                                <option value="아웃바운드 영업">아웃바운드 영업</option>
                                <option value="메일영업">메일영업</option>
                                <option value="SNS 영업">SNS 영업</option>
                                <option value="대면 영업">대면 영업</option>
                                <option value="기타영업">기타영업</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">연관 활동 (여기에 드래그)</label>
                            <div id="planDropTarget" 
                                class="drag-target border-indigo-300 bg-indigo-50 p-2 text-xs text-gray-500" 
                                ondragover="handleDragOver(event)" 
                                ondragleave="handleDragLeave(event)" 
                                ondrop="handleDrop(event)">
                                활동 카드를 여기에 놓으세요 (선택사항)
                            </div>
                        </div>
                    </div>

                    <!-- 동적으로 생성될 입력 필드 영역 -->
                    <div id="dynamicPlanFields" class="mt-4 border-l-4 border-indigo-200 pl-4 py-2 space-y-3">
                        <p class="text-sm text-gray-400">활동 유형을 선택하면 후속 작업 필드가 여기에 나타납니다.</p>
                    </div>
                    
                    <button id="addPlanButton" class="w-full mt-4 bg-indigo-500 text-white p-3 rounded-lg font-bold hover:bg-indigo-600 transition">
                        + 계획 추가
                    </button>

                    <div class="mt-6">
                        <h3 class="font-semibold text-gray-700 mb-2">작성된 내일 계획 목록</h3>
                        <div id="planList" class="bg-gray-50 p-3 min-h-[5rem]">
                            <p class="text-gray-400 text-sm">등록된 내일 계획이 없습니다. 위의 양식으로 계획을 추가해 보세요。</p>
                        </div>
                    </div>
                </section>

                <!-- 4. 종합 성과 및 파일 관리 (KPI, 분석 버튼, 차트 통합됨) -->
                <section class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2 text-orange-500"></i>
                        📊 종합 성과
                    </h2>
                    
                    <!-- KPI Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-center mb-6">
                        
                        <!-- 당월 누적 매출 -->
                        <div class="p-3 bg-indigo-50 rounded-lg">
                            <p class="text-xs text-gray-500">팀 월간 누적 매출</p>
                            <p id="displayMonthlyCumulativeSales" class="text-lg font-bold text-indigo-800 mt-1">₩0</p>
                        </div>

                        <!-- 당월 나의 매출 -->
                        <div class="p-3 bg-blue-50 rounded-lg">
                            <p class="text-xs text-gray-500">당월 나의 매출</p>
                            <p id="displayMyMonthlySales" class="text-lg font-bold text-blue-800 mt-1">₩0</p>
                        </div>

                        <!-- 총 실제 매출 (오늘) (일일 합산) -->
                        <div class="p-3 bg-green-50 rounded-lg">
                            <p class="text-xs text-gray-500">총 실제 매출 (오늘)</p>
                            <p id="displayTotalRevenue" class="text-lg font-bold text-green-800 mt-1">₩0</p>
                        </div>
                        
                        <!-- 총 계약 건수 (오늘) (일일 합산) -->
                        <div class="p-3 bg-yellow-50 rounded-lg">
                            <p class="text-xs text-gray-500">총 계약 건수 (오늘)</p>
                            <p id="displayTotalContracts" class="text-lg font-bold text-yellow-800 mt-1">0건</p>
                        </div>

                        <!-- 매출 목표 달성률 (오늘) (Mock) -->
                        <div class="p-3 bg-red-50 rounded-lg">
                            <p class="text-xs text-gray-500">매출 목표 달성률 (오늘)</p>
                            <p id="displayRevenueGoalAttainment" class="text-lg font-bold text-red-800 mt-1">0.0%</p>
                        </div>
                        
                    </div>

                    <div class="space-y-3 mb-6">
                        
                        <!-- AI 분석 버튼 -->
                        <button onclick="analyzePerformance()" class="w-full bg-indigo-500 text-white p-3 rounded-lg font-bold hover:bg-indigo-600 transition flex items-center justify-center shadow-md">
                            <i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>
                            ✨ 성과 인사이트 분석 시작
                        </button>
                        
                    </div>
                    
                    <!-- 성과 인사이트 분석 (차트 포함) -->
                    <div class="pt-6 border-t border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                                <i data-lucide="line-chart" class="w-5 h-5 mr-2 text-green-500"></i>
                                성과 인사이트 분석
                            </h3>
                        <div id="aiAnalysisResult" class="mb-6">
                            <p class="text-gray-500 text-sm">AI 분석을 시작하면 이 영역에 맞춤형 성과 리포트가 나타납니다.</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Chart 1: Sales Breakdown (매출 기여도 도넛 차트) -->
                            <div>
                                <h4 class="font-semibold text-gray-700 text-lg mb-2 border-b pb-1">월별 매출 기여도 분석</h4>
                                <div class="relative h-64">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>
                            
                            <!-- Chart 2: Activity Count (활동 유형별 막대 그래프) -->
                            <div>
                                <h4 class="font-semibold text-gray-700 text-lg mb-2 border-b pb-1">활동 유형별 실행 건수 (최근 7일)</h4>
                                <div class="relative h-64">
                                    <canvas id="activityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Download Button -->
                    <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                        <button onclick="downloadAsPNG()" class="w-full max-w-lg mx-auto border border-gray-300 text-gray-700 p-4 rounded-xl font-bold hover:bg-gray-100 transition flex items-center justify-center shadow-lg">
                            <i data-lucide="download" class="w-6 h-6 mr-3"></i>
                            ⬇️ 최종 보고서 저장 및 다운로드
                        </button>
                    </div>

                </section>
                

            </div>

            <!-- Column 3: Performance Entry Only (lg:col-span-1) -->
            <div class="lg:col-span-1 space-y-6">

                <!-- 3. 오늘 최종 실적 입력 -->
                <section class="card p-6 text-center">
                    <h2 class="text-xl font-extrabold text-gray-700 flex flex-col items-center">
                        <div class="flex items-center">
                            <i data-lucide="trending-up" class="w-5 h-5 mr-2 text-green-500"></i>
                            💰 오늘 최종 실적 입력
                        </div>
                        <span class="mt-1 text-base font-medium text-gray-500">(일별 기준)</span>
                    </h2>
                    <p class="text-sm text-gray-500 my-4">오늘 하루의 최종 매출 및 계약 건수를 상세히 기록합니다.</p>
                    
                    <div class="space-y-4">
                        <!-- 매출 건수 입력 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 text-left">매출 발생 건수 (숫자만)</label>
                            <input type="number" id="inputRevenueCount" min="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="0">
                        </div>
                        <!-- 동적 매출 필드 영역 (세로 정렬) -->
                        <div id="revenueFields" class="space-y-3">
                            <!-- revenue inputs will be rendered here -->
                        </div>
                        
                        <hr class="border-t border-gray-200">
                        
                        <!-- 계약 건수 입력 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 text-left">계약 체결 건수 (숫자만)</label>
                            <input type="number" id="inputContractCount" min="0" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="0">
                        </div>
                        <!-- 동적 계약 필드 영역 (세로 정렬) -->
                        <div id="contractFields" class="space-y-3">
                            <!-- contract inputs will be rendered here -->
                        </div>
                    </div>
                    
                    <button onclick="handleSavePerformance()" class="w-full mt-5 bg-green-500 text-white p-3 rounded-lg font-bold hover:bg-green-600 transition flex items-center justify-center shadow-md">
                        <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                        ✅ 오늘 실적 저장
                    </button>
                    <div id="saveStatus" class="mt-2 text-sm text-gray-500 font-semibold text-center">실적 및 활동 내역을 기록해 주세요.</div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="font-semibold text-gray-700 mb-2">오늘 저장된 실적 목록</h3>
                        <div id="performanceSummaryList" class="bg-gray-50 p-3 min-h-[5rem] space-y-2">
                            <p class="text-gray-400 text-sm">오늘 저장된 실적 내역이 없습니다. 실적을 상세히 기록해 주세요。</p>
                        </div>
                    </div>
                </section>

            </div>
        </div>
    </div>

    <script type="module">
        
        // --- Gemini API 설정 ---
        const GEMINI_API_KEY = "AIzaSyD7md4tcbDQJ9_WrBowlIjdvss4wajs2R4";
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
        
        // [필수] Google Sheets Web App URL
        const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxCq9AE93PxKNttqmwjMyK3Rgze9JLoSRJUhkXYMD3MZ9_qNyLBysH7h41sITeZhePYMw/exec";
        const SHEETS_API_URL = SHEETS_URL;
        const SHEETS_READ_URL = SHEETS_URL;

        const REPORTER_NAME_KEY = 'salesReporterName'; 

        // 사용자 ID는 로컬에서 생성 및 유지 (인증 없이 사용)
        let currentUserId = localStorage.getItem('localUserId') || crypto.randomUUID();
        localStorage.setItem('localUserId', currentUserId);
        
        let salesChartInstance = null;
        let activityChartInstance = null;
        let activityCounter = 1; 
        let planCounter = 1; 
        
        // --- 임시 데이터 초기값 (Sheets 로드 후 업데이트됨) ---
        let dashboardData = {
            activities: [],
            plans: [],
            todaySummaries: [], // 실적 요약 목록
            performance: {
                totalRevenue: 0, 
                totalContracts: 0, 
                revenueGoalAttainment: 0, 
                monthlyCumulativeSales: 0, 
                myMonthlySales: 0, 
            },
            chartData: {
                activityCounts: {}
            }
        };

        // --- 재시도 로직을 위한 유틸리티 함수 ---
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        
        // --- Chart Rendering Functions ---
        
        // --- UI 업데이트 함수 (KPI 업데이트 및 차트 재렌더링) ---
        function updateDashboardUI() {
            // 헬퍼: KRW 통화 형식 지정 (원 단위)
            const krwFormatter = new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                minimumFractionDigits: 0
            });

            // 일일 KPI 업데이트 (실적 요약 목록에서 합산된 값)
            document.getElementById('displayTotalRevenue').textContent = krwFormatter.format(dashboardData.performance.totalRevenue);
            document.getElementById('displayTotalContracts').textContent = `${dashboardData.performance.totalContracts.toLocaleString()}건`;
            
            // Sheets에 목표 데이터가 없으므로 임시 Mock 값 유지
            document.getElementById('displayRevenueGoalAttainment').textContent = `${dashboardData.performance.revenueGoalAttainment.toFixed(1)}%`; 

            // **월별 KPI 업데이트 (Sheets 데이터 기반으로 업데이트)**
            document.getElementById('displayMonthlyCumulativeSales').textContent = krwFormatter.format(dashboardData.performance.monthlyCumulativeSales);
            document.getElementById('displayMyMonthlySales').textContent = krwFormatter.format(dashboardData.performance.myMonthlySales);
            
            // 차트 데이터가 KPI 값에 의존하므로, KPI 업데이트 후 차트도 다시 렌더링
            renderSalesChart(dashboardData.performance);
            renderActivityChart(dashboardData.chartData.activityCounts);
        }

        // --- 차트 렌더링 함수 1: 월별 매출 기여도 (도넛 차트) ---
        function renderSalesChart(performanceData) {
            const mySales = performanceData.myMonthlySales;
            const cumulativeSales = performanceData.monthlyCumulativeSales;
            const otherSales = Math.max(0, cumulativeSales - mySales); 

            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            const ctx = document.getElementById('salesChart').getContext('2d');
            salesChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['나의 매출', '다른 팀원 매출'],
                    datasets: [{
                        data: [mySales, otherSales],
                        backgroundColor: [
                            'rgb(59, 130, 246)', 
                            'rgb(209, 213, 219)' 
                        ],
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: {
                                    family: 'Inter',
                                    size: 14,
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `팀 전체 월간 매출 기여도 (총액: ${cumulativeSales.toLocaleString()}원)`,
                            font: {
                                family: 'Inter',
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }
        
        // --- 차트 렌더링 함수 2: 활동 유형별 실행 건수 (막대 그래프) ---
        function renderActivityChart(activityCounts) {
            const labels = Object.keys(activityCounts);
            const data = Object.values(activityCounts);

            if (activityChartInstance) {
                activityChartInstance.destroy();
            }
            
            const ctx = document.getElementById('activityChart').getContext('2d');
            activityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '실행 건수',
                        data: data,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.7)', 
                            'rgba(245, 158, 11, 0.7)',  
                            'rgba(99, 102, 241, 0.7)',  
                            'rgba(239, 68, 68, 0.7)',   
                            'rgba(6, 182, 212, 0.7)',   
                            'rgba(236, 72, 153, 0.7)',  
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)', 
                            'rgb(245, 158, 11)',  
                            'rgb(99, 102, 241)', 
                            'rgb(239, 68, 68)',   
                            'rgb(6, 182, 212)',   
                            'rgb(236, 72, 153)',  
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: '주요 영업 활동 유형별 실행 건수 (최근 7일)',
                            font: { family: 'Inter', size: 16, weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '건수'
                            }
                        }
                    }
                }
            });
        }

        // --- 활동/계획 카드 렌더링 함수 ---
        function renderActivityCard(activity) {
            const list = document.getElementById('activityList');
            const placeholder = list.querySelector('p.text-gray-400');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Note: Sheets에서 로드된 데이터는 이미 Strings로 처리되어 있음.
            const detailsText = activity.summaryText || `대상: ${activity.target} | 목적: ${activity.purpose} | 건수: ${activity.count}건. 상세: ${activity.fullDetails.substring(0, 20)}...`;

            const card = document.createElement('div');
            card.id = activity.id;
            card.className = 'activity-card flex flex-col cursor-grab mb-2';
            card.draggable = true;
            card.ondragstart = handleDragStart;

            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center">
                        <span class="text-xs font-bold bg-blue-700 text-white px-2 py-0.5 rounded-full">${activity.type}</span>
                        <span class="text-xs text-blue-900 opacity-75 ml-2">${activity.time}</span>
                    </div>
                    <!-- 삭제 버튼 추가 -->
                    <button onclick="deleteActivity('${activity.id}')" class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-white transition" title="활동 삭제">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <!-- 요약된 내용 표시 -->
                <p class="mt-1 text-sm font-semibold">${detailsText}</p>
                <p class="text-xs text-blue-900 opacity-75 mt-0.5">보고자: ${activity.reporter}</p>
            `;
            list.appendChild(card);
            lucide.createIcons();
        }

        function renderPlanCard(plan) {
            const list = document.getElementById('planList');
            const placeholder = list.querySelector('p.text-gray-400');
            if (placeholder) {
                placeholder.remove();
            }

            const relatedActivitiesArray = plan.relatedActivities ? plan.relatedActivities.split('; ') : [];

            const relatedHtml = relatedActivitiesArray.length > 0 
                ? `<div class="mt-2 text-xs bg-indigo-100 p-2 rounded-lg text-indigo-700">
                    <span class="font-bold">🔗 연관 활동:</span> ${relatedActivitiesArray.join('; ')}
                   </div>`
                : '';

            const card = document.createElement('div');
            card.id = plan.id;
            card.className = 'plan-card flex flex-col mb-3 transition shadow-sm hover:shadow-md';

            card.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-sm font-bold bg-indigo-700 text-white px-3 py-1 rounded-full">${plan.type} (예정)</span>
                        <span class="text-xs text-indigo-900 font-medium ml-3">담당: ${plan.contact}</span>
                    </div>
                    <!-- 삭제 버튼 추가 -->
                    <button onclick="deletePlan('${plan.id}')" class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-white transition" title="계획 삭제">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <h4 class="mt-2 text-md font-extrabold text-indigo-900">${plan.followup}</h4>
                <p class="text-sm mt-1 text-gray-700">상세: ${plan.details}</p>
                ${relatedHtml}
            `;
            list.appendChild(card);
            lucide.createIcons();
        }
        
        // --- 실적 요약 카드 렌더링 함수 ---
        function renderSummaryCard(summary) {
            const list = document.getElementById('performanceSummaryList');
            const placeholder = list.querySelector('p.text-gray-400');
            if (placeholder) {
                placeholder.remove();
            }

            const krwFormatter = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW', minimumFractionDigits: 0 });

            let content = '';
            if (summary.type === 'revenue') {
                content = `매출 발생 (₩): <strong>${krwFormatter.format(summary.amount)}</strong> | 매출처: ${summary.source}`;
            } else if (summary.type === 'contract') {
                content = `계약명: <strong>${summary.contractName}</strong> | 거래처: ${summary.source}`;
            }

            const card = document.createElement('div');
            card.className = 'summary-card';
            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-bold text-sm">${summary.type === 'revenue' ? '💰 매출 기록' : '🤝 계약 기록'}</span>
                    <span class="text-xs opacity-75">${summary.time}</span>
                </div>
                <p class="mt-1">${content}</p>
            `;
            list.appendChild(card);
            lucide.createIcons();
        }


        // --- 목록 초기화 및 데이터 기반 렌더링 ---
        function renderActivityAndPlanLists() {
            const activityList = document.getElementById('activityList');
            const planList = document.getElementById('planList');
            const performanceSummaryList = document.getElementById('performanceSummaryList');

            // --- 렌더링 전에 기존 목록을 비웁니다 ---
            activityList.innerHTML = '';
            performanceSummaryList.innerHTML = ''; // 실적 요약 목록은 항상 비웁니다.

            // 플레이스홀더 설정
            if (dashboardData.activities.length === 0) {
                activityList.innerHTML = '<p class="text-gray-400 text-sm">아직 등록된 활동이 없습니다. 위의 양식으로 활동 내역을 추가해 보세요.</p>';
            }
            if (dashboardData.plans.length === 0) {
                planList.innerHTML = '<p class="text-gray-400 text-sm">등록된 내일 계획이 없습니다. 위의 양식으로 계획을 추가해 보세요。</p>';
            }
            // 실적 요약 목록은 로컬 데이터가 없을 때만 플레이스홀더 표시
            if (dashboardData.todaySummaries.length === 0) {
                 performanceSummaryList.innerHTML = '<p class="text-gray-400 text-sm">오늘 저장된 실적 내역이 없습니다. 실적을 상세히 기록해 주세요。</p>';
            }

            // 데이터 렌더링
            dashboardData.activities.forEach(renderActivityCard);
            dashboardData.plans.forEach(renderPlanCard); 
            dashboardData.todaySummaries.forEach(renderSummaryCard); 

            lucide.createIcons();
        }

        // --- 활동 내역 삭제 함수 ---
        function deleteActivity(activityId) {
             // 로컬에서만 삭제 (Sheets 반영은 최종 저장 시)
            dashboardData.activities = dashboardData.activities.filter(a => a.id !== activityId);
            
            const element = document.getElementById(activityId);
            if (element) {
                element.remove();
                displayMessage('✔️ 활동 내역이 삭제되었습니다. (Sheets 반영은 최종 저장 시)', 'success');
            }
            
            const list = document.getElementById('activityList');
            if (dashboardData.activities.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm">아직 등록된 활동이 없습니다. 위의 양식으로 활동 내역을 추가해 보세요。</p>';
            }
            lucide.createIcons();
        }
        window.deleteActivity = deleteActivity;

        // --- 내일 계획 삭제 함수 ---
        function deletePlan(planId) {
            // 로컬에서만 삭제 (Sheets 반영은 최종 저장 시)
            dashboardData.plans = dashboardData.plans.filter(p => p.id !== planId);
            
            const element = document.getElementById(planId);
            if (element) {
                element.remove();
                displayMessage('✔️ 내일 계획이 삭제되었습니다. (Sheets 반영은 최종 저장 시)', 'success');
            }
            
            const list = document.getElementById('planList');
            if (dashboardData.plans.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-sm">등록된 내일 계획이 없습니다. 위의 양식으로 계획을 추가해 보세요。</p>';
            }
            lucide.createIcons();
        }
        window.deletePlan = deletePlan;


        // --- 동적 입력 필드 렌더링 (활동/계획) ---
        function renderPlanDynamicFields() {
            const container = document.getElementById('dynamicPlanFields');
            const selectedType = document.getElementById('planActivityType').value;
            container.innerHTML = ''; 

            if (selectedType === '--- 유형 선택 ---') {
                container.innerHTML = '<p class="text-sm text-gray-400">활동 유형을 선택하면 후속 작업 필드가 여기에 나타납니다.</p>';
                return;
            }
            // ... (HTML 구조 유지)
            const fieldsHtml = `
                <div class="space-y-3">
                    <!-- 1. 수행 후속작업 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">수행 후속작업</label>
                        <input type="text" id="planFollowup" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ex: 보고서 제출, 다음 단계 논의, 견적 발송">
                    </div>

                    <!-- 2. 연락처 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">연락처 / 담당자</label>
                        <input type="text" id="planContact" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ex: 김철수, 010-XXXX-XXXX">
                    </div>
                    
                    <!-- 3. 상세 계획 / To-Do List -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">상세 계획 / To-Do List</label>
                        <textarea id="planDetailsInput" rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="내일의 주요 목표와 상세 업무 내용을 작성하세요."></textarea>
                    </div>
                </div>
            `;
            container.innerHTML = fieldsHtml;
            lucide.createIcons();
        }
        window.renderPlanDynamicFields = renderPlanDynamicFields;

        
        // --- 내일 계획 추가 핸들러 ---
        async function handleAddPlan() {
            const reporterNameSelect = document.getElementById('reporterName');
            const reporterName = reporterNameSelect.value.trim(); // 이름 고정 해제됨

            if (!reporterName) {
                displayMessage('⚠️ 보고자 이름을 먼저 선택하고 활동을 추가하세요.', 'error');
                return;
            }

            const planActivityType = document.getElementById('planActivityType').value;
            const planFollowupInput = document.getElementById('planFollowup');
            const planContactInput = document.getElementById('planContact');
            const planDetailsInput = document.getElementById('planDetailsInput');
            const planDropTarget = document.getElementById('planDropTarget');
            
            // 1. 유효성 검사
            if (planActivityType === '--- 유형 선택 ---' || !planFollowupInput || !planContactInput || !planDetailsInput) {
                displayMessage('⚠️ 계획 유형을 선택하고 모든 상세 필드를 입력해야 합니다.', 'error');
                return;
            }

            const followup = planFollowupInput.value.trim();
            const contact = planContactInput.value.trim();
            const details = planDetailsInput.value.trim();

            if (!followup || !contact || !details) {
                 displayMessage('⚠️ 수행 후속작업, 연락처, 상세 계획을 모두 입력해야 합니다.', 'error');
                 return;
            }

            // 2. 연관 활동 정보 추출
            const relatedActivities = Array.from(planDropTarget.children)
                .filter(child => child.dataset.originalId)
                .map(child => {
                    const contentElement = child.querySelector('.font-semibold');
                    return contentElement ? contentElement.textContent.trim() : '내용 없음';
                });

            const now = new Date();
            // 3. 새 계획 객체 생성
            const newPlan = {
                id: `plan-${planCounter++}`,
                reporter: reporterName,
                date: now.toISOString().slice(0, 10),
                time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                type: planActivityType,
                followup: followup,
                contact: contact,
                details: details,
                relatedActivities: relatedActivities.join('; '), 
                status: '예정'
            };

            // 4. 로컬 데이터 저장 및 UI 즉시 업데이트 (속도 개선)
            dashboardData.plans.push(newPlan);
            renderPlanCard(newPlan); 

            // 5. 입력 필드 초기화
            document.getElementById('planActivityType').value = '--- 유형 선택 ---';
            planDropTarget.innerHTML = '활동 카드를 여기에 놓으세요 (선택사항)';
            document.getElementById('dynamicPlanFields').innerHTML = '<p class="text-sm text-gray-400">활동 유형을 선택하면 후속 작업 필드가 여기에 나타납니다.</p>';

            displayMessage('✔️ 새로운 내일 계획이 추가되었습니다.', 'success');

            // 6. Google Sheets에 데이터 비동기 전송
            await sendDataToSheets('add계획', newPlan);
        }
        window.handleAddPlan = handleAddPlan;


        // --- 동적 입력 필드 렌더링 (일일 활동 유형 선택 시 호출) ---
        function renderDynamicFields() {
            const container = document.getElementById('dynamicActivityFields');
            const selectedType = document.getElementById('activityType').value;

            if (selectedType === '--- 활동 유형을 선택하세요 ---') {
                container.innerHTML = '<p class="text-sm text-gray-400">활동 유형을 선택하면 관련 입력 필드가 여기에 나타납니다.</p>';
                return;
            }
            
            // ... (HTML 구조 유지)
            container.innerHTML = `
                <div class="space-y-4">
                    <!-- 1. 영업 대상 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">영업 대상</label>
                        <input type="text" id="inputTarget" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ex: A사 신규 프로젝트, 기존 B고객 유지">
                    </div>

                    <!-- 2. 영업 목적 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">영업 목적</label>
                        <input type="text" id="inputPurpose" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ex: 신제품 X 판매, 계약 연장">
                    </div>
                    
                    <!-- 3. 예상 성과 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">예상 성과</label>
                        <input type="text" id="inputExpectedResult" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="ex: 500만원 계약 체결, 다음 미팅 확정">
                    </div>

                    <hr class="border-t border-gray-200">
                    
                    <!-- 4. 실적 건수 (동적 생성 기준) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">실적 건수 (숫자만 입력)</label>
                        <input type="number" id="inputPerformanceCount" min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" oninput="renderDetailFields(this.value)" placeholder="1">
                    </div>

                    <!-- 5. 상세 내용 (동적 생성 영역) -->
                    <div id="detailTextareas" class="space-y-3">
                        <!-- 상세 내용 입력란이 여기에 동적으로 생성됩니다. -->
                    </div>
                </div>
            `;
            // 기본값 1에 대해 상세 내용 필드 1개를 바로 렌더링
            renderDetailFields(1);
            lucide.createIcons();
        }
        window.renderDynamicFields = renderDynamicFields;


        // --- 실적 건수에 따른 상세 내용 필드 렌더링 ---
        function renderDetailFields(countString) {
            const count = parseInt(countString, 10);
            const container = document.getElementById('detailTextareas');
            container.innerHTML = '';

            if (isNaN(count) || count <= 0) {
                container.innerHTML = '<p class="text-sm text-red-500">실적 건수는 1 이상의 숫자로 입력해야 합니다.</p>';
                return;
            }

            for (let i = 1; i <= count; i++) {
                const detailHtml = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700">상세 내용 ${i}</label>
                        <textarea id="detail_${i}" rows="2" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" placeholder="${i}번째 활동의 구체적인 내용, 결과, 후속 조치를 기록하세요."></textarea>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', detailHtml);
            }
        }
        window.renderDetailFields = renderDetailFields;


        // --- 활동 내역 추가 핸들러 ---
        async function handleAddActivity() {
            const reporterNameSelect = document.getElementById('reporterName'); 
            let reporterName = reporterNameSelect.value.trim(); // 이름 고정 해제됨

            const activityTypeSelect = document.getElementById('activityType');
            const activityType = activityTypeSelect.value;
            
            const target = document.getElementById('inputTarget')?.value.trim();
            const purpose = document.getElementById('inputPurpose')?.value.trim();
            const expectedResult = document.getElementById('inputExpectedResult')?.value.trim();
            const count = parseInt(document.getElementById('inputPerformanceCount')?.value, 10) || 0;
            
            // 이름 유효성 검사 (고정 로직 제거)
            if (!reporterName) {
                displayMessage('⚠️ 보고자 이름을 먼저 선택하고 활동을 추가하세요.', 'error');
                return;
            }
            
            // 상세 내용 수집
            let collectedDetails = [];
            for (let i = 1; i <= count; i++) {
                const detailElement = document.getElementById(`detail_${i}`);
                if (detailElement && detailElement.value.trim()) {
                    collectedDetails.push(detailElement.value.trim());
                }
            }


            if (activityType === '--- 활동 유형을 선택하세요 ---' || !target || count <= 0 || collectedDetails.length === 0) {
                displayMessage('⚠️ 활동 유형, 영업 대상, 실적 건수 및 상세 내용을 모두 입력해야 합니다.', 'error');
                return;
            }

            const summaryText = `대상: ${target} | 목적: ${purpose} | 건수: ${count}건. 상세: ${collectedDetails[0].substring(0, 20)}...`;

            const now = new Date();
            const newActivity = {
                id: `activity-${activityCounter++}`,
                reporter: reporterName,
                date: now.toISOString().slice(0, 10),
                time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                type: activityType,
                target: target,
                purpose: purpose,
                expectedResult: expectedResult,
                count: count,
                fullDetails: collectedDetails.join('; '), 
                summaryText: summaryText
            };

            // 1. 로컬 데이터에 추가 및 UI 즉시 업데이트 (응답 속도 개선)
            dashboardData.activities.push(newActivity); 
            renderActivityCard(newActivity); 
            
            // 2. 입력 필드 초기화
            activityTypeSelect.value = '--- 활동 유형을 선택하세요 ---';
            document.getElementById('dynamicActivityFields').innerHTML = '<p class="text-sm text-gray-400">활동 유형을 선택하면 관련 입력 필드가 여기에 나타납니다.</p>';

            displayMessage('✔️ 새로운 활동 내역이 추가되었습니다.', 'success');
            
            // 3. Google Sheets에 데이터 비동기 전송
            await sendDataToSheets('add활동', newActivity);
        }
        window.handleAddActivity = handleAddActivity;

        
        // --- 동적 실적 입력 필드 렌더링 ---
        function renderRevenueFields(count) {
            const container = document.getElementById('revenueFields');
            container.innerHTML = '';
            if (isNaN(count) || count <= 0) return;

            for (let i = 1; i <= count; i++) {
                container.insertAdjacentHTML('beforeend', `
                    <div class="space-y-1 p-2 border border-gray-200 rounded-lg">
                        <input type="text" id="revenueSource_${i}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="매출처">
                        <input type="number" id="revenueAmount_${i}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="금액 (EX: 100000)">
                    </div>
                `);
            }
        }
        window.renderRevenueFields = renderRevenueFields;

        function renderContractFields(count) {
            const container = document.getElementById('contractFields');
            container.innerHTML = '';
            if (isNaN(count) || count <= 0) return;

            for (let i = 1; i <= count; i++) {
                 container.insertAdjacentHTML('beforeend', `
                    <div class="space-y-1 p-2 border border-gray-200 rounded-lg">
                        <input type="text" id="contractSource_${i}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="거래처">
                        <input type="text" id="contractName_${i}" class="block w-full rounded-lg border-gray-300 shadow-sm p-2 border text-sm" placeholder="계약명 (ex: 2차 서비스 계약)">
                    </div>
                `);
            }
        }
        window.renderContractFields = renderContractFields;
        
        
        // --- 이벤트 핸들러: 실적 저장, 요약 표시, Sheets 전송 (비동기) ---
        window.handleSavePerformance = async () => {
            const reporterNameSelect = document.getElementById('reporterName');
            const reporterName = reporterNameSelect.value.trim(); // 이름 고정 해제됨
            
            if (!reporterName) {
                displayMessage('⚠️ 보고자 이름이 설정되지 않았습니다.', 'error');
                return false; 
            }
            
            // 1. 데이터 수집
            const revenueCount = parseInt(document.getElementById('inputRevenueCount').value, 10) || 0;
            const contractCount = parseInt(document.getElementById('inputContractCount').value, 10) || 0;
            const now = new Date();
            const time = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            
            let allSummaries = [];
            let localRevenueTotal = 0;
            let localContractCount = 0; 
            let sheetsPromises = [];

            // 1-1. 매출 데이터 수집 및 전송 준비
            for (let i = 1; i <= revenueCount; i++) {
                const source = document.getElementById(`revenueSource_${i}`)?.value.trim();
                const amount = parseFloat(document.getElementById(`revenueAmount_${i}`)?.value) || 0;
                
                if (source && amount > 0) {
                    localRevenueTotal += amount;
                    const summary = { id: `sum-${Date.now()}-rev-${i}`, type: 'revenue', time: time, reporter: reporterName, source: source, amount: amount, contractName: '' };
                    allSummaries.push(summary);
                    
                    const payload = {
                        date: now.toISOString().slice(0, 10),
                        time: time,
                        reporter: reporterName,
                        revenueSource: source,
                        revenue: amount,
                        contractSource: '',
                        contracts: 0,
                        contractName: '',
                    };
                    sheetsPromises.push(sendDataToSheets('add실적', payload));
                }
            }

            // 1-2. 계약 데이터 수집 및 전송 준비
            for (let i = 1; i <= contractCount; i++) {
                const source = document.getElementById(`contractSource_${i}`)?.value.trim();
                const contractName = document.getElementById(`contractName_${i}`)?.value.trim();
                
                if (source && contractName) {
                    localContractCount += 1;
                    const summary = { id: `sum-${Date.now()}-con-${i}`, type: 'contract', time: time, reporter: reporterName, source: source, amount: 0, contractName: contractName };
                    allSummaries.push(summary);

                    const payload = {
                        date: now.toISOString().slice(0, 10),
                        time: time,
                        reporter: reporterName,
                        revenueSource: '',
                        revenue: 0,
                        contractSource: source,
                        contracts: 1, // 건수는 1로 고정
                        contractName: contractName,
                    };
                    sheetsPromises.push(sendDataToSheets('add실적', payload));
                }
            }
            
            if (sheetsPromises.length === 0) {
                displayMessage('⚠️ 저장할 유효한 실적 데이터가 없습니다. 입력 필드를 확인하세요.', 'error');
                return false;
            }

            // 2. Sheets에 데이터 전송 (병렬 처리)
            displayMessage('⏳ 모든 실적 데이터를 Google Sheets로 전송 중...', 'info');
            const results = await Promise.all(sheetsPromises.map(p => p.catch(e => e)));
            const hasError = results.some(r => r instanceof Error || r === false);
            
            if (hasError) {
                displayMessage('❌ 일부 실적 데이터 Sheets 전송에 실패했습니다.', 'error');
            }


            // 3. 로컬 데이터 업데이트 (UI 즉시 반영)
            dashboardData.todaySummaries.push(...allSummaries);
            
            // 여기서는 오늘 저장된 실적만 합산하여 로컬 KPI에 반영합니다.
            dashboardData.performance.totalRevenue += localRevenueTotal;
            dashboardData.performance.totalContracts += localContractCount; 

            // 4. 입력 필드 초기화
            document.getElementById('inputRevenueCount').value = '';
            document.getElementById('inputContractCount').value = '';
            renderRevenueFields(0);
            renderContractFields(0);
            
            // 5. UI 갱신 (실적 요약 및 KPI 갱신)
            renderActivityAndPlanLists();
            
            // 6. Sheets에서 최신 KPI 데이터 로드 (실시간 갱신)
            displayMessage('✅ 실적 저장 완료. KPI 데이터 갱신 중...', 'info');
            // Sheets에서 KPI 데이터만 로드 (활동 내역과 과거 실적 요약은 불러오지 않음)
            const loadSuccess = await fetchSalesData(reporterName, false); 
            
            if (loadSuccess) {
                 displayMessage('🎉 실적 저장 및 KPI 갱신 완료!', 'success');
            } else {
                 displayMessage('⚠️ 실적 저장은 완료되었으나, KPI 갱신에 실패했습니다. (Apps Script 확인)', 'error');
            }

            // 전송에 심각한 오류가 없었다면 true 반환 (다운로드 진행 가능)
            return !hasError;
        };

        
        // --- LLM 인사이트 분석 (Gemini API 호출) ---
        async function analyzePerformance() {
             const reporterName = document.getElementById('reporterName').value.trim();
             const totalRevenueToday = dashboardData.performance.totalRevenue;
             const totalContractsToday = dashboardData.performance.totalContracts;
             const activityCounts = dashboardData.chartData.activityCounts;
             
             if (!reporterName) {
                 displayMessage('⚠️ AI 분석을 시작하려면 먼저 보고자 이름을 선택해야 합니다.', 'error');
                 return;
             }

             if (totalRevenueToday === 0 && totalContractsToday === 0 && Object.keys(activityCounts).length === 0) {
                 displayMessage('⚠️ 오늘 실적 및 활동 내역이 없어서 분석할 데이터가 부족합니다.', 'error');
                 return;
             }

             // Mock 데이터 생성 (어제 실적 가정: 오늘보다 5% 낮고, 계약 1건 적음)
             const yesterdayRevenue = Math.max(0, Math.round(totalRevenueToday * 0.95));
             const yesterdayContracts = Math.max(0, totalContractsToday - 1);

             const analysisPrompt = `
                 당신은 영업 사원(${reporterName})의 일일 성과를 분석하는 전문 AI 분석가입니다.
                 오늘의 성과와 가상의 어제 성과를 비교 분석하고, 현재 영업 활동 유형을 고려하여 향후 개선할 수 있는 액션 플랜을 제시해주세요.

                 --- 데이터 ---
                 1. 보고자: ${reporterName}
                 2. 오늘 매출: ${totalRevenueToday.toLocaleString()}원
                 3. 오늘 계약 건수: ${totalContractsToday}건
                 4. 어제 (가상) 매출: ${yesterdayRevenue.toLocaleString()}원
                 5. 어제 (가상) 계약 건수: ${yesterdayContracts}건
                 6. 오늘 주요 활동 건수: ${JSON.stringify(activityCounts)}

                 --- 분석 요청 ---
                 1. 성과 요약: 오늘 실적 변화(매출, 계약 건수)를 어제와 비교하여 핵심적으로 요약해주세요.
                 2. 활동 분석: 가장 높은 비중을 차지하는 활동 유형에 대한 간략한 평가를 제공해주세요.
                 3. 액션 플랜: 성과를 극대화하거나 부족한 부분을 개선하기 위한 구체적인 액션 플랜 2~3가지를 제시해주세요.
                 결과는 마크다운 형식으로 작성해주십시오.
             `;

             const resultElement = document.getElementById('aiAnalysisResult');
             resultElement.innerHTML = '<div class="text-center py-4 text-blue-600 font-semibold flex items-center justify-center"><i data-lucide="loader-circle" class="w-5 h-5 mr-2 animate-spin"></i>AI가 성과를 분석 중입니다... (최대 10초 소요)</div>';
             lucide.createIcons();
             
             let attempts = 0;
             const maxAttempts = 5;

             while (attempts < maxAttempts) {
                 attempts++;
                 let delay = attempts === 1 ? 0 : Math.pow(2, attempts - 1) * 1000;
                 
                 if (delay > 0) {
                      await sleep(delay);
                 }
                 
                 try {
                      // API 키는 런타임에 플랫폼에서 주입됩니다.
                      const apiKey = GEMINI_API_KEY; 
                      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                      const payload = {
                           contents: [{ parts: [{ text: analysisPrompt }] }],
                           tools: [{ "google_search": {} }],
                           systemInstruction: {
                               parts: [{ text: "당신은 영업 사원의 성과를 분석하는 전문 AI 분석가입니다. 응답은 분석과 액션 플랜에 집중하며, 친절하고 전문적인 톤을 유지합니다." }]
                           },
                       };
                       
                       const response = await fetch(apiUrl, {
                           method: 'POST',
                           headers: { 'Content-Type': 'application/json' },
                           body: JSON.stringify(payload)
                       });
                       
                       if (!response.ok) {
                           throw new Error(`HTTP 오류: ${response.status}`);
                       }

                       const result = await response.json();
                       const analysisText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                       
                       // Marked.parse를 사용하여 Markdown을 HTML로 변환합니다.
                       if (analysisText) {
                            resultElement.innerHTML = `<div class="p-4 bg-gray-50 rounded-xl shadow-inner">${marked.parse(analysisText)}</div>`;
                            lucide.createIcons();
                            return; // 성공 시 함수 종료
                       } else {
                            throw new Error("응답 내용 누락");
                       }

                 } catch (error) {
                      const isRetryable = error.message.includes('HTTP 오류: 503') || error.message.includes('HTTP 오류: 429');
                      
                      if (isRetryable && attempts < maxAttempts) {
                           resultElement.innerHTML = `<div class="text-center py-2 text-orange-600">재시도 ${attempts}/${maxAttempts}: 서버 과부하. 잠시 후 다시 시도합니다...</div>`;
                           continue;
                      } else {
                           // 최종 실패
                           resultElement.innerHTML = `<div class="text-center py-4 text-red-600 font-semibold">❌ AI 분석에 최종 실패했습니다. (원인: ${error.message})</div>`;
                           return;
                      }
                 }
             } // end while
             resultElement.innerHTML = `<div class="text-center py-4 text-red-600 font-semibold">❌ AI 분석에 최종 실패했습니다. (최대 재시도 횟수 초과)</div>`;
        }
        window.analyzePerformance = analyzePerformance;

        
        // --- PNG 다운로드 및 초기화 ---
        function downloadAsPNG() {
            const reporterName = document.getElementById('reporterName').value.trim();
            if (!reporterName) {
                 displayMessage('⚠️ 보고자 이름을 먼저 선택해야 보고서를 저장하고 다운로드할 수 있습니다.', 'error');
                 return;
            }

            // 1. Sheets에 최종 실적 데이터 저장 (비동기 완료 대기)
            displayMessage('⏳ Sheets에 최종 실적 데이터를 저장 중입니다...', 'info');
            const savePromise = handleSavePerformance(); // 실적 저장 및 KPI 갱신

            // 2. PNG 캡처 및 다운로드
            savePromise.then((success) => {
                 // Sheets 저장 성공 여부와 관계없이 다운로드 및 초기화 시도
                 displayMessage('⏳ 보고서 이미지를 캡처하는 중...', 'info');

                 const captureArea = document.getElementById('dashboard-container'); 
                 
                 html2canvas(captureArea, {
                     scale: 2, 
                     logging: false,
                     useCORS: true,
                     allowTaint: true
                 }).then(canvas => {
                     const link = document.createElement('a');
                     const today = new Date().toISOString().slice(0, 10);
                     link.download = `영업일일보고서_${reporterName}_${today}.png`;
                     
                     // 다운로드 링크 설정
                     link.href = canvas.toDataURL('image/png');
                     
                     // 다운로드 실행
                     setTimeout(() => {
                         link.click();
                         displayMessage('🎉 보고서 이미지 다운로드 완료! 모든 필드를 초기화합니다.', 'success');
                         
                         // 3. 다운로드 및 저장 후 최종 초기화
                         resetAllInputs();
                     }, 500);


                 }).catch(error => {
                     console.error('Error capturing dashboard:', error);
                     // 초기화는 다운로드 실패와 무관하게 실행
                     resetAllInputs();
                     displayMessage('❌ 이미지 캡처에 실패했습니다. (브라우저 보안 설정 확인)', 'error');
                 });
            });
        }
        window.downloadAsPNG = downloadAsPNG;
        
        // --- 커스텀 메시지 표시 함수 ---
        function displayMessage(message, type) {
            const statusElement = document.getElementById('saveStatus');
            statusElement.textContent = message;
            statusElement.className = `mt-2 text-sm font-semibold text-center ${type === 'error' ? 'text-red-600' : type === 'info' ? 'text-blue-600' : 'text-green-600'}`;
            
            // 일정 시간 후 메시지 초기화
            if (type !== 'info') {
                setTimeout(() => {
                    statusElement.textContent = '실적 및 활동 내역을 기록해 주세요.';
                    statusElement.className = 'mt-2 text-sm text-gray-500 font-semibold text-center';
                }, 8000);
            }
        }
        window.displayMessage = displayMessage;
        
        // --- 드래그 앤 드롭 로직 ---
        function handleDragStart(event) { event.dataTransfer.setData('text/plain', event.target.id); event.target.classList.add('dragging'); }
        function handleDragOver(event) { event.preventDefault(); event.currentTarget.classList.add('drag-hover'); }
        function handleDragLeave(event) { event.currentTarget.classList.remove('drag-hover'); }
        function handleDrop(event) { 
            event.preventDefault(); 
            event.currentTarget.classList.remove('drag-hover'); 
            const data = event.dataTransfer.getData('text/plain'); 
            const draggedElement = document.getElementById(data); 
            if (draggedElement) { 
                
                if (event.currentTarget.textContent.includes('활동 카드를 여기에 놓으세요')) {
                    event.currentTarget.innerHTML = '';
                }

                if (event.currentTarget.querySelector(`[data-original-id="${draggedElement.id}"]`)) {
                     displayMessage('이미 추가된 활동입니다.', 'info');
                     draggedElement.classList.remove('dragging');
                     return;
                }
                
                const clone = draggedElement.cloneNode(true);
                clone.id = `${draggedElement.id}-plan-link-${Date.now()}`; 
                clone.dataset.originalId = draggedElement.id; 
                clone.draggable = false; 
                clone.style.cursor = 'default';
                clone.classList.remove('dragging', 'activity-card', 'cursor-grab', 'bg-bfdbfe', 'text-1e3a8a');
                clone.classList.add('bg-indigo-200', 'text-indigo-900', 'p-2', 'mb-1', 'rounded-md', 'text-xs');
                
                const summaryDiv = draggedElement.querySelector('.font-semibold');
                const detailsText = summaryDiv ? summaryDiv.textContent : '내용 없음';
                
                const cardContent = dashboardData.activities.find(a => a.id === draggedElement.id) || {};
                
                clone.innerHTML = `<div class="flex justify-between items-center">
                                     <span class="font-bold">${cardContent.type || '활동'} (${cardContent.time || ''})</span>
                                     <button onclick="this.parentElement.parentElement.remove(); checkPlanDropTargetEmpty();" class="text-red-500 hover:text-red-700 font-bold ml-2" title="연관 활동 연결 해제">X</button>
                                    </div>
                                    <p class="mt-1">🔗 ${cardContent.target || detailsText}</p>`; 
                
                event.currentTarget.appendChild(clone);
                draggedElement.classList.remove('dragging');
            } 
        }
        window.handleDragStart = handleDragStart;
        window.handleDragOver = handleDragOver;
        window.handleDragLeave = handleDragLeave;
        window.handleDrop = handleDrop;
        
        // 드롭 대상이 비어있는지 확인하고 플레이스홀더를 다시 표시하는 함수
        function checkPlanDropTargetEmpty() {
            const target = document.getElementById('planDropTarget');
            const linkedCards = target.querySelectorAll('[data-original-id]');
            if (linkedCards.length === 0) {
                 target.innerHTML = '활동 카드를 여기에 놓으세요 (선택사항)';
            }
        }
        window.checkPlanDropTargetEmpty = checkPlanDropTargetEmpty;

    </script>
</body>
</html>
